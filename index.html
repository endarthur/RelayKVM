<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RelayKVM</title>
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16.png">
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="theme-color" content="#00b894">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RelayKVM">
    <meta name="description" content="Wireless KVM using Bluetooth HID - control any PC from your browser">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* === SURFACE COLORS === */
            --surface-base: #0d0f12;      /* Page background */
            --panel-bg: #1a1d21;          /* Main panel background */
            --panel-surface: #22262b;     /* Raised surfaces */
            --panel-raised: #2a2f35;      /* Higher elevation */
            --panel-inset: #13161a;       /* Inset/pressed areas */
            --panel-border: #0d0f12;      /* Panel borders */

            /* === STATUS LEDS === */
            --led-green: #00ff66;
            --led-green-dim: #004d1f;
            --led-red: #ff3333;
            --led-red-dim: #4d1010;
            --led-amber: #ffaa00;
            --led-amber-dim: #4d3300;
            --led-blue: #0099ff;
            --led-blue-dim: #003366;

            /* === TEXT COLORS === */
            --text-bright: #e8eaed;
            --text-normal: #9aa0a6;
            --text-dim: #5f6368;
            --text-label: #80868b;

            /* === DISPLAY/TERMINAL === */
            --display-bg: #0a0c0e;
            --display-text: #00ff66;
            --display-text-dim: #006633;

            /* === 3D EFFECTS === */
            --bezel-light: #3a4045;
            --bezel-dark: #101214;
            --screw-color: #2a2f35;

            /* === PRIMARY ACTION (green) === */
            --btn-primary-bg: #1a6040;
            --btn-primary-border: #124030;
            --btn-primary-text: #88ffaa;
            --btn-primary-hover: #227850;

            /* === DANGER ACTION (red) === */
            --btn-danger-bg: #702020;
            --btn-danger-border: #501515;
            --btn-danger-text: #ffaaaa;
            --btn-danger-hover: #882828;

            /* === NEUTRAL BUTTONS === */
            --btn-neutral-bg: #35393e;
            --btn-neutral-hover: #45494f;
            --btn-neutral-active: #282c30;

            /* === COLORED ACTION BUTTONS === */
            --action-red-bg: #7a2020;
            --action-red-border: #501515;
            --action-red-text: #ffcccc;
            --action-amber-bg: #806500;
            --action-amber-border: #584500;
            --action-amber-text: #ffe088;
            --action-green-bg: #256530;
            --action-green-border: #184520;
            --action-green-text: #aaffbb;
            --action-blue-bg: #254a70;
            --action-blue-border: #18354a;
            --action-blue-text: #aaddff;

            /* === FUNCTION KEY COLORS === */
            --fnkey-red-bg: #8b2525;
            --fnkey-red-border: #5c1818;
            --fnkey-amber-bg: #9a7b00;
            --fnkey-amber-border: #6b5500;
            --fnkey-green-bg: #2a7a3a;
            --fnkey-green-border: #1a5528;
            --fnkey-blue-bg: #2a5a8a;
            --fnkey-blue-border: #1a4060;

            /* === SPECIAL STATES === */
            --recording-color: #ff8800;
            --accent-primary: #00b894;    /* Teal accent */
            --accent-secondary: #e17055;  /* Coral accent */

            /* === LOGO === */
            --logo-block1: var(--accent-primary);
            --logo-block2: var(--accent-secondary);
            --logo-relay: #ffffff;

            /* === PENDANT === */
            --pendant-btn-bg: #2a2d31;
            --pendant-btn-text: #9aa0a6;
        }

        /* ============================================
           THEME: Industrial (classic green/amber)
           High contrast, machine-room aesthetic
           ============================================ */
        [data-theme="industrial"] {
            /* Accents */
            --accent-primary: #00ff66;
            --accent-secondary: #ffaa00;
            --logo-block1: #00ff66;
            --logo-block2: #ffaa00;

            /* Display */
            --display-text: #00ff66;
            --display-text-dim: #006633;

            /* Primary buttons match green LED */
            --btn-primary-bg: #1a5030;
            --btn-primary-border: #103820;
            --btn-primary-text: #66ff99;
            --btn-primary-hover: #226840;

            /* Action buttons - industrial palette */
            --action-red-bg: #702020;
            --action-red-border: #501515;
            --action-red-text: #ff8888;
            --action-amber-bg: #705020;
            --action-amber-border: #503515;
            --action-amber-text: #ffcc88;
            --action-green-bg: #1a5030;
            --action-green-border: #103820;
            --action-green-text: #88ffaa;
            --action-blue-bg: #204060;
            --action-blue-border: #152840;
            --action-blue-text: #88ccff;

            /* Fnkeys */
            --fnkey-red-bg: #702525;
            --fnkey-red-border: #501818;
            --fnkey-amber-bg: #705525;
            --fnkey-amber-border: #503818;
            --fnkey-green-bg: #1a5530;
            --fnkey-green-border: #103a20;
            --fnkey-blue-bg: #254565;
            --fnkey-blue-border: #182a40;

            /* Pendant */
            --pendant-btn-bg: #1a2820;
            --pendant-btn-text: #66ff99;
        }

        /* ============================================
           THEME: Signal (blue/red, alert-focused)
           Emergency/control room aesthetic
           ============================================ */
        [data-theme="signal"] {
            /* Accents */
            --accent-primary: #0099ff;
            --accent-secondary: #ff3333;
            --logo-block1: #0099ff;
            --logo-block2: #ff3333;

            /* Display */
            --display-text: #0099ff;
            --display-text-dim: #004466;

            /* Primary buttons - blue instead of green */
            --btn-primary-bg: #1a4a70;
            --btn-primary-border: #123050;
            --btn-primary-text: #88ccff;
            --btn-primary-hover: #225a80;

            /* Action buttons - signal/alert palette */
            --action-red-bg: #802020;
            --action-red-border: #601515;
            --action-red-text: #ff9999;
            --action-amber-bg: #806020;
            --action-amber-border: #604515;
            --action-amber-text: #ffdd99;
            --action-green-bg: #1a4a70;
            --action-green-border: #123050;
            --action-green-text: #88ccff;
            --action-blue-bg: #1a4a70;
            --action-blue-border: #123050;
            --action-blue-text: #88ccff;

            /* Fnkeys */
            --fnkey-red-bg: #802525;
            --fnkey-red-border: #601818;
            --fnkey-amber-bg: #806525;
            --fnkey-amber-border: #604818;
            --fnkey-green-bg: #1a4a70;
            --fnkey-green-border: #123050;
            --fnkey-blue-bg: #1a4a70;
            --fnkey-blue-border: #123050;

            /* Pendant */
            --pendant-btn-bg: #152535;
            --pendant-btn-text: #88ccff;
        }

        /* ============================================
           THEME: Koma (lava orange + phosphor green)
           Industrial terminal aesthetic
           ============================================ */
        [data-theme="koma"] {
            /* Accents - orange/green */
            --accent-primary: #ff6b35;
            --accent-secondary: #00ff88;
            --logo-block1: #ff6b35;
            --logo-block2: #00ff88;
            --logo-relay: #e0e0e0;

            /* Surfaces - charcoal */
            --surface-base: #0f0f0f;
            --panel-bg: #1a1a1a;
            --panel-surface: #252525;
            --panel-raised: #2a2a2a;
            --panel-inset: #0a0a0a;
            --panel-border: #333333;

            /* Text */
            --text-bright: #e0e0e0;
            --text-normal: #999999;
            --text-dim: #666666;

            /* LEDs */
            --led-green: #00ff88;
            --led-green-dim: #004422;
            --led-red: #ff6b35;
            --led-red-dim: #552200;
            --led-amber: #ff6b35;
            --led-amber-dim: #552200;
            --led-blue: #4d9fff;
            --led-blue-dim: #1a3355;

            /* Display - phosphor green */
            --display-text: #00ff88;
            --display-text-dim: #005533;
            --display-bg: #0a0a0a;

            /* Primary buttons - orange */
            --btn-primary-bg: #ff6b35;
            --btn-primary-border: #cc5528;
            --btn-primary-text: #0f0f0f;
            --btn-primary-hover: #ff8555;

            /* Neutral buttons */
            --btn-neutral-bg: #252525;
            --btn-neutral-hover: #333333;

            /* Action buttons */
            --action-red-bg: #3a2520;
            --action-red-border: #552200;
            --action-red-text: #ff6b35;
            --action-amber-bg: #3a2520;
            --action-amber-border: #552200;
            --action-amber-text: #ff6b35;
            --action-green-bg: #1a3025;
            --action-green-border: #004422;
            --action-green-text: #00ff88;
            --action-blue-bg: #1a2535;
            --action-blue-border: #1a3355;
            --action-blue-text: #4d9fff;

            /* Fnkeys */
            --fnkey-red-bg: #2a1a15;
            --fnkey-red-border: #441a00;
            --fnkey-amber-bg: #2a1a15;
            --fnkey-amber-border: #441a00;
            --fnkey-green-bg: #152a1a;
            --fnkey-green-border: #003318;
            --fnkey-blue-bg: #151a2a;
            --fnkey-blue-border: #152244;

            /* Pendant */
            --pendant-btn-bg: #1a1a1a;
            --pendant-btn-text: #ff6b35;
        }

        /* ============================================
           THEME: Amber (warm CRT feel)
           Retro terminal aesthetic
           ============================================ */
        [data-theme="amber"] {
            /* Accents */
            --accent-primary: #ffaa00;
            --accent-secondary: #ff6600;
            --logo-block1: #ffaa00;
            --logo-block2: #ff6600;

            /* Display - amber CRT */
            --display-text: #ffaa00;
            --display-text-dim: #664400;

            /* LEDs - warm tones */
            --led-green: #ffcc00;
            --led-green-dim: #665500;
            --led-blue: #ffaa44;
            --led-blue-dim: #664422;

            /* Primary buttons - warm */
            --btn-primary-bg: #604a1a;
            --btn-primary-border: #403012;
            --btn-primary-text: #ffdd88;
            --btn-primary-hover: #786020;

            /* Recording */
            --recording-color: #ff6600;

            /* Action buttons - amber CRT palette */
            --action-red-bg: #8b3000;
            --action-red-border: #5c2000;
            --action-red-text: #ffcc99;
            --action-amber-bg: #8b6000;
            --action-amber-border: #5c4000;
            --action-amber-text: #ffee99;
            --action-green-bg: #6b7000;
            --action-green-border: #454a00;
            --action-green-text: #eeff88;
            --action-blue-bg: #555540;
            --action-blue-border: #38382a;
            --action-blue-text: #ddddaa;

            /* Fnkeys - amber CRT */
            --fnkey-red-bg: #8b3500;
            --fnkey-red-border: #5c2200;
            --fnkey-amber-bg: #8b6500;
            --fnkey-amber-border: #5c4200;
            --fnkey-green-bg: #6b7500;
            --fnkey-green-border: #454c00;
            --fnkey-blue-bg: #555845;
            --fnkey-blue-border: #383a2d;

            /* Pendant */
            --pendant-btn-bg: #2a2010;
            --pendant-btn-text: #ffcc88;
        }

        /* ============================================
           THEME: Light (industrial beige/gray)
           Daytime, paper-like aesthetic
           ============================================ */
        [data-theme="light"] {
            /* Surfaces - light industrial */
            --surface-base: #c8c8c8;
            --panel-bg: #d8d8d8;
            --panel-surface: #e4e4e4;
            --panel-raised: #ececec;
            --panel-inset: #c0c0c0;
            --panel-border: #a0a0a0;

            /* Text - dark on light */
            --text-bright: #1a1a1a;
            --text-normal: #404040;
            --text-dim: #707070;
            --text-label: #606060;

            /* Bezels */
            --bezel-light: #f0f0f0;
            --bezel-dark: #909090;
            --screw-color: #b0b0b0;

            /* Display - inverted */
            --display-bg: #1a2420;
            --display-text: #00dd55;
            --display-text-dim: #005522;

            /* LEDs - darker for contrast */
            --led-green: #00cc44;
            --led-green-dim: #b8d8c0;
            --led-red: #dd2222;
            --led-red-dim: #d8b8b8;
            --led-amber: #cc8800;
            --led-amber-dim: #d8d0b8;
            --led-blue: #0077cc;
            --led-blue-dim: #b8c8d8;

            /* Primary buttons */
            --btn-primary-bg: #2a8050;
            --btn-primary-border: #1a6040;
            --btn-primary-text: #ffffff;
            --btn-primary-hover: #3a9060;

            /* Danger buttons */
            --btn-danger-bg: #c03030;
            --btn-danger-border: #902020;
            --btn-danger-text: #ffffff;
            --btn-danger-hover: #d04040;

            /* Neutral buttons */
            --btn-neutral-bg: #b8b8b8;
            --btn-neutral-hover: #c8c8c8;
            --btn-neutral-active: #a0a0a0;

            /* Action buttons - saturated on light bg */
            --action-red-bg: #c04040;
            --action-red-border: #903030;
            --action-red-text: #ffffff;
            --action-amber-bg: #b89000;
            --action-amber-border: #907000;
            --action-amber-text: #ffffff;
            --action-green-bg: #308040;
            --action-green-border: #206030;
            --action-green-text: #ffffff;
            --action-blue-bg: #3060a0;
            --action-blue-border: #204080;
            --action-blue-text: #ffffff;

            /* Fnkeys */
            --fnkey-red-bg: #c04545;
            --fnkey-red-border: #903535;
            --fnkey-amber-bg: #b89500;
            --fnkey-amber-border: #907500;
            --fnkey-green-bg: #358545;
            --fnkey-green-border: #256535;
            --fnkey-blue-bg: #3565a5;
            --fnkey-blue-border: #254585;

            /* Accents */
            --accent-primary: #00a080;
            --accent-secondary: #d06040;
            --logo-block1: #00a080;
            --logo-block2: #d06040;
            --logo-relay: #ffffff;

            /* Recording */
            --recording-color: #dd6600;

            /* Pendant - dark buttons on light theme */
            --pendant-btn-bg: #2a3530;
            --pendant-btn-text: #88ddaa;
        }

        /* ============================================
           THEME: Catppuccin Mocha (darkest)
           Soothing pastel theme
           ============================================ */
        [data-theme="ctp-mocha"] {
            /* Surfaces */
            --surface-base: #11111b;
            --panel-bg: #1e1e2e;
            --panel-surface: #313244;
            --panel-raised: #45475a;
            --panel-inset: #181825;
            --panel-border: #11111b;

            /* Text */
            --text-bright: #cdd6f4;
            --text-normal: #bac2de;
            --text-dim: #6c7086;
            --text-label: #9399b2;

            /* Bezels */
            --bezel-light: #585b70;
            --bezel-dark: #181825;
            --screw-color: #45475a;

            /* Display */
            --display-bg: #11111b;
            --display-text: #a6e3a1;
            --display-text-dim: #40553e;

            /* LEDs - Catppuccin accent colors */
            --led-green: #a6e3a1;
            --led-green-dim: #40553e;
            --led-red: #f38ba8;
            --led-red-dim: #5c3540;
            --led-amber: #f9e2af;
            --led-amber-dim: #5c5340;
            --led-blue: #89b4fa;
            --led-blue-dim: #35455c;

            /* Primary - Teal */
            --btn-primary-bg: #2a4a48;
            --btn-primary-border: #1a3230;
            --btn-primary-text: #94e2d5;
            --btn-primary-hover: #3a5a58;

            /* Danger - Red */
            --btn-danger-bg: #5c3540;
            --btn-danger-border: #3c2028;
            --btn-danger-text: #f38ba8;
            --btn-danger-hover: #6c4550;

            /* Neutral */
            --btn-neutral-bg: #45475a;
            --btn-neutral-hover: #585b70;
            --btn-neutral-active: #313244;

            /* Action buttons */
            --action-red-bg: #5c3540;
            --action-red-border: #3c2028;
            --action-red-text: #f38ba8;
            --action-amber-bg: #5c5340;
            --action-amber-border: #3c3528;
            --action-amber-text: #f9e2af;
            --action-green-bg: #40553e;
            --action-green-border: #283528;
            --action-green-text: #a6e3a1;
            --action-blue-bg: #35455c;
            --action-blue-border: #202838;
            --action-blue-text: #89b4fa;

            /* Fnkeys */
            --fnkey-red-bg: #5c3540;
            --fnkey-red-border: #3c2028;
            --fnkey-amber-bg: #5c5340;
            --fnkey-amber-border: #3c3528;
            --fnkey-green-bg: #40553e;
            --fnkey-green-border: #283528;
            --fnkey-blue-bg: #35455c;
            --fnkey-blue-border: #202838;

            /* Accents - Mauve & Peach */
            --accent-primary: #cba6f7;
            --accent-secondary: #fab387;
            --logo-block1: #cba6f7;
            --logo-block2: #fab387;
            --logo-relay: #cdd6f4;
            --recording-color: #fab387;

            /* Pendant */
            --pendant-btn-bg: #1e1e2e;
            --pendant-btn-text: #cba6f7;
        }

        /* ============================================
           THEME: Catppuccin Macchiato
           ============================================ */
        [data-theme="ctp-macchiato"] {
            /* Surfaces */
            --surface-base: #181926;
            --panel-bg: #24273a;
            --panel-surface: #363a4f;
            --panel-raised: #494d64;
            --panel-inset: #1e2030;
            --panel-border: #181926;

            /* Text */
            --text-bright: #cad3f5;
            --text-normal: #b8c0e0;
            --text-dim: #6e738d;
            --text-label: #939ab7;

            /* Bezels */
            --bezel-light: #5b6078;
            --bezel-dark: #1e2030;
            --screw-color: #494d64;

            /* Display */
            --display-bg: #181926;
            --display-text: #a6da95;
            --display-text-dim: #405038;

            /* LEDs */
            --led-green: #a6da95;
            --led-green-dim: #405038;
            --led-red: #ed8796;
            --led-red-dim: #583538;
            --led-amber: #eed49f;
            --led-amber-dim: #585038;
            --led-blue: #8aadf4;
            --led-blue-dim: #354258;

            /* Primary - Teal */
            --btn-primary-bg: #2a4845;
            --btn-primary-border: #1a3230;
            --btn-primary-text: #8bd5ca;
            --btn-primary-hover: #3a5855;

            /* Danger */
            --btn-danger-bg: #583538;
            --btn-danger-border: #382025;
            --btn-danger-text: #ed8796;
            --btn-danger-hover: #684548;

            /* Neutral */
            --btn-neutral-bg: #494d64;
            --btn-neutral-hover: #5b6078;
            --btn-neutral-active: #363a4f;

            /* Action buttons */
            --action-red-bg: #583538;
            --action-red-border: #382025;
            --action-red-text: #ed8796;
            --action-amber-bg: #585038;
            --action-amber-border: #383225;
            --action-amber-text: #eed49f;
            --action-green-bg: #405038;
            --action-green-border: #283225;
            --action-green-text: #a6da95;
            --action-blue-bg: #354258;
            --action-blue-border: #202835;
            --action-blue-text: #8aadf4;

            /* Fnkeys */
            --fnkey-red-bg: #583538;
            --fnkey-red-border: #382025;
            --fnkey-amber-bg: #585038;
            --fnkey-amber-border: #383225;
            --fnkey-green-bg: #405038;
            --fnkey-green-border: #283225;
            --fnkey-blue-bg: #354258;
            --fnkey-blue-border: #202835;

            /* Accents - Mauve & Peach */
            --accent-primary: #c6a0f6;
            --accent-secondary: #f5a97f;
            --logo-block1: #c6a0f6;
            --logo-block2: #f5a97f;
            --logo-relay: #cad3f5;
            --recording-color: #f5a97f;

            /* Pendant */
            --pendant-btn-bg: #24273a;
            --pendant-btn-text: #c6a0f6;
        }

        /* ============================================
           THEME: Catppuccin Frapp√©
           ============================================ */
        [data-theme="ctp-frappe"] {
            /* Surfaces */
            --surface-base: #232634;
            --panel-bg: #303446;
            --panel-surface: #414559;
            --panel-raised: #51576d;
            --panel-inset: #292c3c;
            --panel-border: #232634;

            /* Text */
            --text-bright: #c6d0f5;
            --text-normal: #b5bfe2;
            --text-dim: #737994;
            --text-label: #949cbb;

            /* Bezels */
            --bezel-light: #626880;
            --bezel-dark: #292c3c;
            --screw-color: #51576d;

            /* Display */
            --display-bg: #232634;
            --display-text: #a6d189;
            --display-text-dim: #405035;

            /* LEDs */
            --led-green: #a6d189;
            --led-green-dim: #405035;
            --led-red: #e78284;
            --led-red-dim: #553535;
            --led-amber: #e5c890;
            --led-amber-dim: #554a35;
            --led-blue: #8caaee;
            --led-blue-dim: #354055;

            /* Primary - Teal */
            --btn-primary-bg: #2a4542;
            --btn-primary-border: #1a302e;
            --btn-primary-text: #81c8be;
            --btn-primary-hover: #3a5552;

            /* Danger */
            --btn-danger-bg: #553535;
            --btn-danger-border: #352020;
            --btn-danger-text: #e78284;
            --btn-danger-hover: #654545;

            /* Neutral */
            --btn-neutral-bg: #51576d;
            --btn-neutral-hover: #626880;
            --btn-neutral-active: #414559;

            /* Action buttons */
            --action-red-bg: #553535;
            --action-red-border: #352020;
            --action-red-text: #e78284;
            --action-amber-bg: #554a35;
            --action-amber-border: #353020;
            --action-amber-text: #e5c890;
            --action-green-bg: #405035;
            --action-green-border: #283020;
            --action-green-text: #a6d189;
            --action-blue-bg: #354055;
            --action-blue-border: #202830;
            --action-blue-text: #8caaee;

            /* Fnkeys */
            --fnkey-red-bg: #553535;
            --fnkey-red-border: #352020;
            --fnkey-amber-bg: #554a35;
            --fnkey-amber-border: #353020;
            --fnkey-green-bg: #405035;
            --fnkey-green-border: #283020;
            --fnkey-blue-bg: #354055;
            --fnkey-blue-border: #202830;

            /* Accents - Mauve & Peach */
            --accent-primary: #ca9ee6;
            --accent-secondary: #ef9f76;
            --logo-block1: #ca9ee6;
            --logo-block2: #ef9f76;
            --logo-relay: #c6d0f5;
            --recording-color: #ef9f76;

            /* Pendant */
            --pendant-btn-bg: #303446;
            --pendant-btn-text: #ca9ee6;
        }

        /* ============================================
           THEME: Catppuccin Latte (light)
           ============================================ */
        [data-theme="ctp-latte"] {
            /* Surfaces */
            --surface-base: #dce0e8;
            --panel-bg: #eff1f5;
            --panel-surface: #e6e9ef;
            --panel-raised: #ccd0da;
            --panel-inset: #bcc0cc;
            --panel-border: #acb0be;

            /* Text */
            --text-bright: #4c4f69;
            --text-normal: #5c5f77;
            --text-dim: #8c8fa1;
            --text-label: #6c6f85;

            /* Bezels */
            --bezel-light: #eff1f5;
            --bezel-dark: #9ca0b0;
            --screw-color: #bcc0cc;

            /* Display - keep dark for contrast */
            --display-bg: #1e1e2e;
            --display-text: #a6e3a1;
            --display-text-dim: #40553e;

            /* LEDs - saturated for light bg */
            --led-green: #40a02b;
            --led-green-dim: #c8e8c0;
            --led-red: #d20f39;
            --led-red-dim: #e8c0c8;
            --led-amber: #df8e1d;
            --led-amber-dim: #e8dcc0;
            --led-blue: #1e66f5;
            --led-blue-dim: #c0d0e8;

            /* Primary - Teal */
            --btn-primary-bg: #179299;
            --btn-primary-border: #0e6065;
            --btn-primary-text: #ffffff;
            --btn-primary-hover: #20a5ad;

            /* Danger */
            --btn-danger-bg: #d20f39;
            --btn-danger-border: #a00a2c;
            --btn-danger-text: #ffffff;
            --btn-danger-hover: #e52048;

            /* Neutral */
            --btn-neutral-bg: #ccd0da;
            --btn-neutral-hover: #bcc0cc;
            --btn-neutral-active: #acb0be;

            /* Action buttons */
            --action-red-bg: #d20f39;
            --action-red-border: #a00a2c;
            --action-red-text: #ffffff;
            --action-amber-bg: #df8e1d;
            --action-amber-border: #a86a15;
            --action-amber-text: #ffffff;
            --action-green-bg: #40a02b;
            --action-green-border: #2e7820;
            --action-green-text: #ffffff;
            --action-blue-bg: #1e66f5;
            --action-blue-border: #1550c0;
            --action-blue-text: #ffffff;

            /* Fnkeys */
            --fnkey-red-bg: #d20f39;
            --fnkey-red-border: #a00a2c;
            --fnkey-amber-bg: #df8e1d;
            --fnkey-amber-border: #a86a15;
            --fnkey-green-bg: #40a02b;
            --fnkey-green-border: #2e7820;
            --fnkey-blue-bg: #1e66f5;
            --fnkey-blue-border: #1550c0;

            /* Accents - Mauve & Peach */
            --accent-primary: #8839ef;
            --accent-secondary: #fe640b;
            --logo-block1: #8839ef;
            --logo-block2: #fe640b;
            --logo-relay: #eff1f5;
            --recording-color: #fe640b;

            /* Pendant - dark buttons on light theme */
            --pendant-btn-bg: #303446;
            --pendant-btn-text: #c6a0f6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            background: var(--surface-base);
            color: var(--text-normal);
            min-height: 100vh;
            padding: 12px;
        }

        /* Themed scrollbars (global) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--panel-inset);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--panel-border);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-dim);
        }
        ::-webkit-scrollbar-corner {
            background: var(--panel-inset);
        }
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--panel-border) var(--panel-inset);
        }

        /* Main chassis */
        .chassis {
            position: relative;
            width: 100%;
            height: calc(100vh - 24px);
            display: flex;
            flex-direction: column;
            background: var(--panel-bg);
            border: 3px solid var(--panel-border);
            border-radius: 4px;
            box-shadow:
                inset 0 1px 0 var(--bezel-light),
                0 8px 32px rgba(0,0,0,0.6),
                0 2px 4px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        /* Top bezel with branding */
        .top-bezel {
            background: linear-gradient(180deg, var(--panel-raised) 0%, var(--panel-surface) 100%);
            border-bottom: 2px solid var(--panel-border);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .brand-logo {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-bright);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .brand-model {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            color: var(--text-dim);
            padding: 4px 8px;
            background: var(--panel-inset);
            border-radius: 2px;
        }

        .status-cluster {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* LED Indicators - Koma-style vertical bars */
        .led-cluster {
            display: flex;
            gap: 6px;
            padding: 4px 8px;
            background: var(--panel-inset);
            border-radius: 3px;
            border: 1px solid var(--panel-border);
        }

        .led-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .led-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 8px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .led {
            width: 4px;
            height: 20px;
            border-radius: 2px;
            background: var(--led-green-dim);
            border: 1px solid rgba(0,0,0,0.3);
            transition: all 0.15s;
        }

        .led.on {
            background: var(--led-green);
            box-shadow: 0 0 6px var(--led-green);
        }

        .led.red { background: var(--led-red-dim); }
        .led.red.on {
            background: var(--led-red);
            box-shadow: 0 0 6px var(--led-red);
        }

        .led.amber { background: var(--led-amber-dim); }
        .led.amber.on {
            background: var(--led-amber);
            box-shadow: 0 0 6px var(--led-amber);
        }

        .led.blue { background: var(--led-blue-dim); }
        .led.blue.on {
            background: var(--led-blue);
            box-shadow: 0 0 6px var(--led-blue);
        }

        /* Circular LED style for non-header indicators */
        .led.dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Main panel area - horizontal layout */
        .main-panel {
            display: grid;
            grid-template-columns: minmax(350px, 1fr) minmax(600px, 1.5fr);
            padding: 10px;
            gap: 10px;
            flex: 1;
            min-height: 0;  /* Allow to shrink in flex container */
            overflow: hidden;
        }

        @media (max-width: 1100px) {
            .main-panel {
                grid-template-columns: 1fr;
            }
        }

        /* Left column: video panel */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Right column grid layout */
        .right-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            grid-template-rows: auto auto auto auto 1fr;
            grid-template-areas:
                "tinput tinput tinput tinput"
                "keys keys mouse mouse"
                "jiggler settings log log"
                "wakepower macros log log"
                "cardputer scripts log log";
            gap: 8px;
            flex: 1;
            min-height: 0;  /* Allow grid to shrink */
            overflow: hidden;  /* Prevent grid from growing beyond container */
        }

        .right-column .module {
            margin-bottom: 0;
        }

        .area-tinput { grid-area: tinput; }
        .area-keys { grid-area: keys; }
        .area-mouse { grid-area: mouse; display: flex; flex-direction: column; }
        .area-jiggler { grid-area: jiggler; }
        .area-settings { grid-area: settings; }
        .area-wakepower { grid-area: wakepower; }
        .area-cardputer { grid-area: cardputer; }
        .area-scripts { grid-area: scripts; display: flex; flex-direction: column; }
        .area-macros { grid-area: macros; }
        .area-log { grid-area: log; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }

        /* Extras row: quick actions in compact grid */
        .extras-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .extras-row .module {
            margin-bottom: 0;
        }

        .section-header {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-label);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--panel-border);
        }

        /* Module containers */
        .module {
            background: var(--panel-inset);
            border: 1px solid var(--panel-border);
            border-radius: 3px;
            margin-bottom: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .module:last-child {
            margin-bottom: 0;
        }

        .module-header {
            background: var(--panel-surface);
            padding: 5px 10px;
            height: 24px;
            box-sizing: content-box;
            border-bottom: 1px solid var(--panel-border);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-label);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-body {
            padding: 8px;
        }

        /* Hardware buttons - industrial flat style */
        .hw-btn {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 14px;
            background: var(--btn-neutral-bg);
            border: 1px solid var(--text-dim);
            border-radius: 3px;
            color: var(--text-normal);
            cursor: pointer;
            transition: all 0.1s;
        }

        .hw-btn:hover {
            background: var(--btn-neutral-hover);
            color: var(--text-bright);
        }

        .hw-btn:active {
            background: var(--btn-neutral-active);
            transform: translateY(1px);
        }

        .hw-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .hw-btn.primary {
            background: var(--btn-primary-bg);
            border-color: rgba(255, 255, 255, 0.25);
            color: var(--btn-primary-text);
        }

        .hw-btn.primary:hover {
            background: var(--btn-primary-hover);
        }

        .theme-select {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            padding: 4px 8px;
            background: var(--panel-inset);
            border: 1px solid var(--panel-border);
            border-radius: 3px;
            color: var(--text-dim);
            cursor: pointer;
        }

        .theme-select:hover {
            color: var(--text-normal);
        }

        /* Settings Modal */
        .settings-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 4px 8px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: color 0.15s, background 0.15s;
        }

        .settings-btn:hover {
            color: var(--text-normal);
            background: var(--panel-surface);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--panel-bg);
            border: 3px solid var(--panel-border);
            border-radius: 8px;
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.05),
                0 20px 60px rgba(0,0,0,0.5);
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 2px solid var(--panel-border);
            background: var(--panel-surface);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-bright);
        }

        .modal-body {
            padding: 16px;
        }

        .settings-section {
            margin-bottom: 16px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-section-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--panel-border);
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }

        .theme-btn {
            aspect-ratio: 1;
            border: 2px solid var(--panel-border);
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.15s;
            position: relative;
            overflow: hidden;
        }

        .theme-btn:hover {
            transform: scale(1.05);
            border-color: var(--text-dim);
        }

        .theme-btn.active {
            border-color: var(--accent-primary);
            box-shadow: 0 0 8px var(--accent-primary);
        }

        .theme-btn::before,
        .theme-btn::after {
            content: '';
            position: absolute;
            width: 60%;
            height: 60%;
        }

        .theme-btn::before {
            top: 10%;
            left: 10%;
            border-radius: 2px;
        }

        .theme-btn::after {
            bottom: 10%;
            right: 10%;
            border-radius: 2px;
        }

        /* Theme button colors */
        .theme-btn[data-theme=""] { background: #0d0f12; }
        .theme-btn[data-theme=""]::before { background: #00b894; }
        .theme-btn[data-theme=""]::after { background: #e17055; }

        .theme-btn[data-theme="industrial"] { background: #0d0f12; }
        .theme-btn[data-theme="industrial"]::before { background: #00ff66; }
        .theme-btn[data-theme="industrial"]::after { background: #ffaa00; }

        .theme-btn[data-theme="signal"] { background: #0d0f12; }
        .theme-btn[data-theme="signal"]::before { background: #0099ff; }
        .theme-btn[data-theme="signal"]::after { background: #ff3333; }

        .theme-btn[data-theme="amber"] { background: #0d0f12; }
        .theme-btn[data-theme="amber"]::before { background: #ffaa00; }
        .theme-btn[data-theme="amber"]::after { background: #cc8800; }

        .theme-btn[data-theme="koma"] { background: #1a1a1a; }
        .theme-btn[data-theme="koma"]::before { background: #ff6b35; }
        .theme-btn[data-theme="koma"]::after { background: #00ff88; }

        .theme-btn[data-theme="light"] { background: #f0f0f0; }
        .theme-btn[data-theme="light"]::before { background: #00897b; }
        .theme-btn[data-theme="light"]::after { background: #d84315; }

        .theme-btn[data-theme="ctp-mocha"] { background: #1e1e2e; }
        .theme-btn[data-theme="ctp-mocha"]::before { background: #89b4fa; }
        .theme-btn[data-theme="ctp-mocha"]::after { background: #f38ba8; }

        .theme-btn[data-theme="ctp-macchiato"] { background: #24273a; }
        .theme-btn[data-theme="ctp-macchiato"]::before { background: #8aadf4; }
        .theme-btn[data-theme="ctp-macchiato"]::after { background: #ed8796; }

        .theme-btn[data-theme="ctp-frappe"] { background: #303446; }
        .theme-btn[data-theme="ctp-frappe"]::before { background: #8caaee; }
        .theme-btn[data-theme="ctp-frappe"]::after { background: #e78284; }

        .theme-btn[data-theme="ctp-latte"] { background: #eff1f5; }
        .theme-btn[data-theme="ctp-latte"]::before { background: #1e66f5; }
        .theme-btn[data-theme="ctp-latte"]::after { background: #d20f39; }

        .theme-btn-label {
            font-size: 7px;
            text-align: center;
            color: var(--text-dim);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .theme-option {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .theme-option:hover {
            background: var(--panel-surface);
        }

        .theme-option:hover .theme-btn-label {
            color: var(--text-normal);
        }

        .theme-option.custom-slot .theme-btn {
            border-style: dashed;
            background: transparent;
        }

        .theme-option.custom-slot .theme-btn::before,
        .theme-option.custom-slot .theme-btn::after {
            opacity: 0.5;
        }

        .theme-option.custom-slot .theme-btn.has-theme {
            border-style: solid;
        }

        .theme-option.custom-slot .theme-btn.has-theme::before,
        .theme-option.custom-slot .theme-btn.has-theme::after {
            opacity: 1;
        }

        /* Theme Editor Modal */
        .theme-editor-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .theme-editor-overlay.active {
            display: flex;
        }

        .theme-editor {
            background: var(--panel-bg);
            border: 3px solid var(--panel-border);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .theme-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 2px solid var(--panel-border);
            background: var(--panel-surface);
        }

        .theme-editor-header h3 {
            margin: 0;
            font-size: 13px;
            color: var(--text-bright);
        }

        .theme-editor-body {
            padding: 16px;
        }

        .theme-editor-row {
            margin-bottom: 12px;
        }

        .theme-editor-row label {
            display: block;
            font-size: 10px;
            color: var(--text-dim);
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .theme-editor-row input[type="text"],
        .theme-editor-row textarea {
            width: 100%;
            box-sizing: border-box;
            background: var(--panel-inset);
            border: 1px solid var(--panel-border);
            border-radius: 3px;
            color: var(--text-normal);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            padding: 8px;
        }

        .theme-editor-row textarea {
            min-height: 200px;
            resize: vertical;
        }

        .theme-editor-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .theme-editor-actions button {
            flex: 1;
            padding: 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
        }

        .btn-apply {
            background: var(--btn-primary-bg);
            border: 1px solid var(--btn-primary-border);
            color: var(--btn-primary-text);
        }

        .btn-apply:hover {
            background: var(--btn-primary-hover);
        }

        .btn-cancel {
            background: var(--btn-neutral-bg);
            border: 1px solid var(--panel-border);
            color: var(--text-normal);
        }

        .btn-cancel:hover {
            background: var(--btn-neutral-hover);
        }

        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .color-picker-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .color-picker-item label {
            font-size: 8px;
            color: var(--text-dim);
            text-transform: uppercase;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .color-picker-item input[type="color"] {
            width: 100%;
            height: 28px;
            padding: 0;
            border: 1px solid var(--panel-border);
            border-radius: 3px;
            cursor: pointer;
            background: transparent;
        }

        .color-picker-item input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 2px;
        }

        .color-picker-item input[type="color"]::-webkit-color-swatch {
            border-radius: 2px;
            border: none;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .settings-row:last-child {
            margin-bottom: 0;
        }

        .settings-label {
            font-size: 11px;
            color: var(--text-normal);
        }

        .settings-value {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-slider {
            width: 100px;
        }

        .settings-display {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            background: var(--display-bg);
            color: var(--display-text);
            padding: 2px 6px;
            border-radius: 2px;
            min-width: 32px;
            text-align: center;
        }

        .danger-zone {
            padding-top: 12px;
            margin-top: 12px;
            border-top: 1px solid var(--btn-danger-border);
        }

        .btn-danger-sm {
            background: var(--btn-danger-bg);
            border: 1px solid var(--btn-danger-border);
            color: var(--btn-danger-text);
            padding: 6px 12px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            width: 100%;
        }

        .btn-danger-sm:hover {
            background: var(--btn-danger-hover);
        }

        .btn-secondary {
            background: var(--btn-neutral-bg);
            border: 1px solid var(--panel-border);
            color: var(--text-normal);
            padding: 6px 12px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: var(--btn-neutral-hover);
            color: var(--text-bright);
        }

        /* Screen Manager */
        .screen-manager-modal {
            max-width: 550px;
        }

        .screen-map {
            background: var(--display-bg);
            border: 1px solid var(--panel-border);
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
            min-height: 150px;
        }

        .screen-map-inner {
            position: relative;
            margin: 0 auto;
        }

        .screen-box {
            position: absolute;
            background: var(--panel-surface);
            border: 2px solid var(--panel-border);
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: var(--text-dim);
            transition: all 0.15s;
            overflow: hidden;
        }

        .screen-box:hover {
            border-color: var(--text-dim);
        }

        .screen-box.selected {
            border-color: var(--accent-primary);
            box-shadow: 0 0 8px var(--accent-primary);
        }

        .screen-box.role-controller {
            border-color: var(--accent-secondary);
            background: rgba(0, 184, 148, 0.1);
        }

        .screen-box.role-portal {
            border-color: var(--accent-primary);
            background: rgba(0, 210, 211, 0.1);
        }

        .screen-box.current::after {
            content: '‚óè';
            position: absolute;
            top: 2px;
            right: 4px;
            color: var(--accent-tertiary);
            font-size: 8px;
        }

        .screen-box .screen-label {
            font-size: 8px;
            font-weight: 600;
            color: var(--text-normal);
            text-align: center;
            padding: 2px 4px;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .screen-box .screen-size {
            font-size: 7px;
            color: var(--text-dim);
        }

        .screen-box .screen-role {
            font-size: 7px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 1px 4px;
            border-radius: 2px;
            margin-top: 2px;
        }

        .screen-box .screen-role.controller {
            background: var(--accent-secondary);
            color: #fff;
        }

        .screen-box .screen-role.portal {
            background: var(--accent-primary);
            color: #fff;
        }

        .screen-config {
            background: var(--panel-surface);
            border: 1px solid var(--panel-border);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .screen-config-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .screen-config-title .screen-badge {
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 2px;
            background: var(--panel-border);
            color: var(--text-dim);
        }

        .screen-config-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .screen-config-row:last-child {
            margin-bottom: 0;
        }

        .screen-config-label {
            font-size: 10px;
            color: var(--text-dim);
            min-width: 60px;
        }

        .screen-config-input {
            flex: 1;
        }

        .role-selector {
            display: flex;
            gap: 4px;
        }

        .role-btn {
            padding: 4px 10px;
            font-size: 9px;
            border: 1px solid var(--panel-border);
            background: var(--btn-neutral-bg);
            color: var(--text-dim);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .role-btn:hover {
            border-color: var(--text-dim);
            color: var(--text-normal);
        }

        .role-btn.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: #fff;
        }

        .role-btn.active.controller {
            border-color: var(--accent-secondary);
            background: var(--accent-secondary);
        }

        .screen-unavailable {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-dim);
            font-size: 11px;
        }

        .screen-unavailable-icon {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .hw-btn.danger {
            background: var(--btn-danger-bg);
            border-color: rgba(255, 255, 255, 0.25);
            color: var(--btn-danger-text);
        }

        .hw-btn.danger:hover {
            background: var(--btn-danger-hover);
        }

        .hw-btn.large {
            padding: 16px 32px;
            font-size: 13px;
        }

        /* Seven-segment style display */
        .seg-display {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--display-bg);
            color: var(--display-text);
            padding: 8px 12px;
            border-radius: 2px;
            border: 1px solid var(--panel-border);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.6);
            font-size: 14px;
            font-weight: 500;
            text-shadow: 0 0 8px var(--display-text);
        }

        .seg-display.amber {
            color: var(--led-amber);
            text-shadow: 0 0 8px var(--led-amber);
        }

        .seg-display.dim {
            color: var(--display-text-dim);
            text-shadow: none;
        }

        /* Capture panel - video area */
        .capture-panel {
            position: relative;
            overflow: hidden;
            background: var(--panel-inset);
            border: 2px solid var(--panel-border);
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex: 1;
            min-height: 200px;
        }

        .capture-panel #videoFeed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 0;
            display: none;
            background: #000;
        }

        .capture-panel.streaming #videoFeed {
            display: block;
        }

        .capture-panel.streaming .capture-title {
            display: none;
        }

        .capture-panel.streaming::before,
        .capture-panel.streaming::after {
            display: none;
        }

        /* Hover overlay for controls when streaming */
        .capture-panel.streaming .capture-btn-wrapper,
        .capture-panel.streaming .capture-hint {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .capture-panel.streaming:hover .capture-btn-wrapper,
        .capture-panel.streaming:hover .capture-hint {
            opacity: 1;
        }

        .capture-panel.streaming .capture-btn {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .capture-panel.streaming .capture-hint {
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 8px;
            border-radius: 3px;
        }

        /* When captured (jacked in), show video fullscreen over entire page */
        .capture-panel.captured #videoFeed {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 999;
            object-fit: cover;
            background: #000;
        }

        /* Scanline effect for future video area */
        .capture-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 255, 102, 0.02) 2px,
                rgba(0, 255, 102, 0.02) 4px
            );
            pointer-events: none;
        }

        /* Grid pattern background */
        .capture-panel::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(rgba(0, 255, 102, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 102, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
        }

        .capture-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--led-amber);
            margin-bottom: 24px;
            position: relative;
            z-index: 1;
            padding: 4px 12px;
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid rgba(255, 170, 0, 0.3);
            border-radius: 2px;
        }

        .capture-btn-wrapper {
            position: relative;
            display: inline-block;
            z-index: 1;
        }

        .capture-btn {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 20px 48px;
            background: var(--btn-primary-bg);
            border: 2px solid var(--btn-primary-border);
            border-radius: 4px;
            color: var(--btn-primary-text);
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            z-index: 1;
        }

        .capture-btn:hover:not(:disabled) {
            background: var(--btn-primary-hover);
            filter: brightness(1.1);
        }

        .capture-btn:active:not(:disabled) {
            background: var(--btn-primary-border);
            transform: translateY(2px);
        }

        .capture-btn:disabled {
            background: var(--panel-raised);
            border-color: var(--panel-border);
            color: var(--text-dim);
            cursor: not-allowed;
        }

        .capture-hint {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }

        .capture-hint kbd {
            background: var(--panel-surface);
            padding: 3px 6px;
            border-radius: 2px;
            border: 1px solid var(--panel-border);
        }

        /* Trackpad */
        .trackpad {
            background: var(--display-bg);
            border: 2px solid var(--panel-border);
            border-radius: 3px;
            height: 160px;
            cursor: crosshair;
            touch-action: none;
            position: relative;
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.6);
        }

        .trackpad-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border: 1px solid var(--text-dim);
            border-radius: 50%;
            opacity: 0.3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--text-dim);
            transition: all 0.15s;
            pointer-events: none;
        }

        .trackpad-center.drag-ready {
            opacity: 0.6;
            transform: translate(-50%, -50%) scale(1.3);
        }

        .trackpad-center.drag-active {
            opacity: 1;
            border-width: 2px;
            transform: translate(-50%, -50%) scale(1.2);
        }

        .trackpad-center.drag-active.left { border-color: var(--led-red); color: var(--led-red); }
        .trackpad-center.drag-active.middle { border-color: var(--led-green); color: var(--led-green); }
        .trackpad-center.drag-active.right { border-color: var(--led-blue); color: var(--led-blue); }

        /* Button grid */
        .btn-grid {
            display: grid;
            gap: 3px;
        }

        .btn-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
        .btn-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
        .btn-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }

        /* Function keys - Bloomberg Terminal style */
        .fn-key {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            padding: 5px 4px;
            background: var(--panel-raised);
            border: 1px solid var(--text-dim);
            border-radius: 2px;
            color: var(--text-normal);
            cursor: pointer;
            transition: all 0.1s;
        }

        .fn-key:hover {
            filter: brightness(1.2);
            color: var(--text-bright);
        }

        .fn-key:active {
            filter: brightness(0.9);
            transform: translateY(1px);
        }

        /* Industrial membrane keypad style - raised look with bright borders */
        .fn-key.red {
            background: var(--fnkey-red-bg);
            border-color: rgba(255, 255, 255, 0.25);
            color: #fff;
        }

        .fn-key.amber {
            background: var(--fnkey-amber-bg);
            border-color: rgba(255, 255, 255, 0.25);
            color: #fff;
        }

        .fn-key.green {
            background: var(--fnkey-green-bg);
            border-color: rgba(255, 255, 255, 0.25);
            color: #fff;
        }

        .fn-key.blue {
            background: var(--fnkey-blue-bg);
            border-color: rgba(255, 255, 255, 0.25);
            color: #fff;
        }

        /* Text input */
        .text-input-row {
            display: flex;
            gap: 8px;
        }

        .text-input {
            flex: 1;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            padding: 10px 12px;
            background: var(--display-bg);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            color: var(--led-green);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }

        .text-input:focus {
            outline: none;
            border-color: var(--led-green-dim);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4), 0 0 8px rgba(0,255,102,0.1);
        }

        .text-input::placeholder {
            color: var(--text-dim);
        }

        /* Quick actions */
        .action-btn {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 10px 8px;
            background: var(--panel-raised);
            border: 1px solid var(--text-dim);
            border-radius: 2px;
            color: var(--text-normal);
            cursor: pointer;
            text-align: left;
            transition: all 0.1s;
        }

        .action-btn:hover {
            background: var(--panel-raised);
            color: var(--text-bright);
            filter: brightness(1.15);
        }

        .action-btn:active {
            filter: brightness(0.9);
            transform: translateY(1px);
        }

        .action-btn .shortcut {
            display: block;
            font-size: 8px;
            color: var(--text-dim);
            margin-top: 4px;
        }

        /* Industrial raised colored action buttons */
        .action-btn.red {
            background: var(--action-red-bg);
            border-color: rgba(255, 255, 255, 0.25);
            color: #fff;
        }
        .action-btn.red .shortcut { color: var(--action-red-text); }

        .action-btn.amber {
            background: var(--action-amber-bg);
            border-color: rgba(255, 255, 255, 0.25);
            color: #fff;
        }
        .action-btn.amber .shortcut { color: var(--action-amber-text); }

        .action-btn.green {
            background: var(--action-green-bg);
            border-color: rgba(255, 255, 255, 0.25);
            color: #fff;
        }
        .action-btn.green .shortcut { color: var(--action-green-text); }

        .action-btn.blue {
            background: var(--action-blue-bg);
            border-color: rgba(255, 255, 255, 0.25);
            color: #fff;
        }
        .action-btn.blue .shortcut { color: var(--action-blue-text); }

        /* Log display */
        .log-display {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            background: var(--display-bg);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            padding: 8px;
            overflow-y: auto;
            color: var(--display-text);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.5);
        }

        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid rgba(0,255,102,0.1);
        }

        .log-entry:last-child { border-bottom: none; }
        .log-entry .time { color: var(--text-dim); }
        .log-entry.error { color: var(--led-red); }
        .log-entry.send { color: var(--led-blue); }
        .log-entry.info { color: var(--led-amber); }

        /* Bottom bezel */
        .bottom-bezel {
            background: linear-gradient(180deg, var(--panel-surface) 0%, var(--panel-raised) 100%);
            border-top: 2px solid var(--panel-border);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bezel-text {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Screws decoration */
        .screw {
            width: 12px;
            height: 12px;
            background: var(--screw-color);
            border-radius: 50%;
            border: 1px solid var(--panel-border);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
            position: relative;
        }

        .screw::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 8px;
            height: 1px;
            background: var(--panel-border);
        }

        .screw::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            width: 8px;
            height: 1px;
            background: var(--panel-border);
        }

        /* Capture Overlay */
        #captureOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(10, 12, 14, 0.98);
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: none;
        }

        #captureOverlay.active {
            display: flex;
        }

        /* When video is streaming, minimize to broadcast-style single line */
        #captureOverlay.video-active {
            background: transparent;
            justify-content: flex-start;
            align-items: flex-start;
            padding: 6px 8px;
        }

        #captureOverlay.video-active .overlay-content {
            background: rgba(0, 0, 0, 0.75);
            padding: 3px 8px;
            border-radius: 2px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        #captureOverlay.video-active .overlay-indicator,
        #captureOverlay.video-active .overlay-title,
        #captureOverlay.video-active .overlay-subtitle,
        #captureOverlay.video-active .overlay-hint,
        #captureOverlay.video-active .overlay-exit {
            display: none;
        }

        #captureOverlay.video-active .overlay-stats {
            display: contents;
        }

        #captureOverlay.video-active .stat-block {
            display: flex;
            flex-direction: row;
            align-items: baseline;
            margin-right: 8px;
        }

        #captureOverlay.video-active .stat-block:last-child {
            margin-right: 0;
        }

        #captureOverlay.video-active .stat-block .stat-label {
            font-size: 10px;
            color: var(--text-dim);
            letter-spacing: 0;
            order: 0;
        }

        #captureOverlay.video-active .stat-block .stat-label::after {
            content: ':';
        }

        #captureOverlay.video-active .stat-block .stat-value {
            font-size: 10px;
            min-width: auto;
            order: 1;
        }

        #captureOverlay.video-active .overlay-content::before {
            content: '‚óè';
            color: #f44;
            margin-right: 6px;
            font-size: 8px;
        }

        #captureOverlay.video-active .overlay-content::after {
            content: 'ESC';
            color: var(--text-dim);
            margin-left: 8px;
            padding: 1px 4px;
            border: 1px solid var(--text-dim);
            border-radius: 2px;
            font-size: 8px;
            order: 99;
        }

        /* Hide FPS stat when not in video mode */
        .stat-fps {
            display: none;
        }

        #captureOverlay.video-active .stat-fps {
            display: contents;
        }

        .overlay-content {
            text-align: center;
        }

        .overlay-indicator {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--led-green);
            margin: 0 auto 32px;
            box-shadow:
                0 0 40px var(--led-green),
                0 0 80px rgba(0,255,102,0.4),
                inset 0 -4px 12px rgba(0,0,0,0.3);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow:
                    0 0 40px var(--led-green),
                    0 0 80px rgba(0,255,102,0.4),
                    inset 0 -4px 12px rgba(0,0,0,0.3);
            }
            50% {
                box-shadow:
                    0 0 60px var(--led-green),
                    0 0 120px rgba(0,255,102,0.5),
                    inset 0 -4px 12px rgba(0,0,0,0.3);
            }
        }

        .overlay-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-bright);
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 8px;
        }

        .overlay-subtitle {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 48px;
        }

        .overlay-stats {
            display: flex;
            justify-content: center;
            gap: 48px;
        }

        .stat-block {
            text-align: center;
        }

        .stat-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 32px;
            font-weight: 700;
            color: var(--led-green);
            text-shadow: 0 0 20px var(--led-green);
        }

        .stat-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 4px;
        }

        .overlay-exit {
            position: absolute;
            bottom: 48px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .overlay-exit kbd {
            background: var(--panel-surface);
            color: var(--led-amber);
            padding: 8px 16px;
            border-radius: 3px;
            border: 1px solid var(--panel-border);
            margin: 0 8px;
        }

        .hardware-hint {
            color: var(--text-dim);
            font-size: 10px;
        }

        /* Command mode banner */
        .cmd-mode-banner {
            display: none;
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--fnkey-amber-bg);
            border: 2px solid var(--led-amber);
            color: #fff;
            padding: 12px 24px;
            border-radius: 4px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            z-index: 10;
            animation: cmdPulse 1.5s ease-in-out infinite;
        }

        .cmd-mode-banner.active {
            display: block;
        }

        .cmd-mode-icon {
            margin-right: 8px;
        }

        .cmd-mode-hint {
            display: block;
            font-size: 10px;
            font-weight: 400;
            letter-spacing: 1px;
            margin-top: 4px;
            opacity: 0.8;
        }

        @keyframes cmdPulse {
            0%, 100% { box-shadow: 0 0 10px var(--led-amber); }
            50% { box-shadow: 0 0 20px var(--led-amber), 0 0 30px var(--led-amber); }
        }

        /* Sensitivity sliders */
        .sensitivity-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--display-bg);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .sensitivity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(180deg, var(--bezel-light) 0%, var(--panel-raised) 50%, var(--panel-surface) 100%);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            cursor: pointer;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .sensitivity-slider::-webkit-slider-thumb:hover {
            background: linear-gradient(180deg, var(--btn-neutral-hover) 0%, var(--btn-neutral-bg) 50%, var(--panel-raised) 100%);
        }

        .sensitivity-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: linear-gradient(180deg, var(--bezel-light) 0%, var(--panel-raised) 50%, var(--panel-surface) 100%);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            cursor: pointer;
        }

        /* Radio button toggles */
        .radio-btn {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background: var(--panel-surface);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            cursor: pointer;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            transition: all 0.1s;
        }

        .radio-btn:hover {
            background: var(--panel-raised);
            color: var(--text-normal);
        }

        .radio-btn input[type="radio"] {
            display: none;
        }

        .radio-btn:has(input:checked) {
            background: var(--fnkey-blue-bg);
            border-color: var(--fnkey-blue-border);
            color: #fff;
        }

        .radio-btn.wide {
            width: 100%;
            justify-content: center;
        }

        /* Off button gets amber when active */
        #radioOff:has(input:checked) {
            background: var(--fnkey-amber-bg);
            border-color: var(--fnkey-amber-border);
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 28px;
            height: 14px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--panel-surface);
            border: 1px solid var(--panel-border);
            border-radius: 7px;
            transition: 0.2s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 10px;
            width: 10px;
            left: 1px;
            bottom: 1px;
            background: var(--text-dim);
            border-radius: 50%;
            transition: 0.2s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--fnkey-green-bg);
            border-color: var(--fnkey-green-border);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(14px);
            background: #fff;
        }

        /* Video settings grid */
        .video-grid {
            display: grid;
            grid-template-columns: 54px 1fr;
            gap: 4px 8px;
            align-items: center;
        }

        .video-grid .radio-btn {
            width: 54px;
            justify-content: center;
        }

        .video-hint {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            color: var(--text-dim);
            font-style: italic;
        }

        /* Video controls disabled state */
        .video-grid .fn-key:disabled {
            background: var(--panel-inset);
            border-color: var(--panel-border);
            color: var(--text-dim);
            opacity: 0.5;
        }

        .video-grid .fn-key {
            width: 52px;
            text-align: center;
        }

        .video-params {
            transition: opacity 0.15s;
        }

        .video-params.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        /* Wake/Power grid layout */
        .wakepower-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            grid-template-rows: 1fr 1fr;
            grid-template-areas:
                "wake arm power"
                "usbwake arm power";
            gap: 4px;
            height: 100%;
        }

        .wakepower-grid .wake-btn:first-child { grid-area: wake; }
        .wakepower-grid .wake-btn:nth-child(2) { grid-area: usbwake; }
        .wakepower-grid .arm-btn { grid-area: arm; }
        .wakepower-grid .power-btn { grid-area: power; }

        /* Arm button - thin and tall */
        .arm-btn {
            width: 24px;
            background: var(--panel-inset);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-dim);
            transition: all 0.2s;
        }

        .arm-btn:hover {
            background: var(--panel-raised);
            color: var(--led-amber);
        }

        .arm-btn.armed {
            background: var(--led-amber);
            border-color: var(--recording-color);
            color: #000;
            box-shadow: 0 0 8px rgba(255, 170, 0, 0.5);
        }

        /* Power button - faded until armed */
        .power-btn {
            font-size: 11px;
            font-weight: bold;
            opacity: 0.3;
            transition: all 0.2s;
        }

        .power-btn.armed {
            opacity: 1;
            border: 2px solid var(--recording-color) !important;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.4);
        }

        /* Signal strength bars */
        .signal-bars {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 16px;
        }

        .signal-bars .bar {
            width: 4px;
            background: var(--panel-border);
            border-radius: 1px;
        }

        .signal-bars .bar:nth-child(1) { height: 4px; }
        .signal-bars .bar:nth-child(2) { height: 8px; }
        .signal-bars .bar:nth-child(3) { height: 12px; }
        .signal-bars .bar:nth-child(4) { height: 16px; }

        .signal-bars.strength-1 .bar:nth-child(1) { background: var(--led-red); }
        .signal-bars.strength-2 .bar:nth-child(1),
        .signal-bars.strength-2 .bar:nth-child(2) { background: var(--led-amber); }
        .signal-bars.strength-3 .bar:nth-child(1),
        .signal-bars.strength-3 .bar:nth-child(2),
        .signal-bars.strength-3 .bar:nth-child(3) { background: var(--led-green); }
        .signal-bars.strength-4 .bar { background: var(--led-green); }

        /* Script editor */
        .script-editor {
            flex: 1;
            min-height: 60px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            padding: 6px;
            background: var(--display-bg);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            color: var(--led-green);
            resize: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }

        .script-editor:focus {
            outline: none;
            border-color: var(--led-green-dim);
        }

        .script-editor::placeholder {
            color: var(--text-dim);
        }

        /* Help modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--panel-bg);
            border: 2px solid var(--panel-border);
            border-radius: 4px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        .modal-header {
            background: var(--panel-surface);
            padding: 10px 14px;
            border-bottom: 1px solid var(--panel-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-bright);
        }

        .modal-body {
            padding: 14px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            line-height: 1.6;
            color: var(--text-normal);
            overflow-y: auto;
            max-height: 70vh;
        }

        .modal-body h3 {
            color: var(--led-amber);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 12px 0 6px 0;
        }

        .modal-body h3:first-child {
            margin-top: 0;
        }

        .modal-body code {
            background: var(--panel-inset);
            padding: 2px 5px;
            border-radius: 2px;
            color: var(--led-green);
        }

        .modal-body .cmd-row {
            display: flex;
            gap: 8px;
            margin: 4px 0;
        }

        .modal-body .cmd-name {
            color: var(--led-blue);
            min-width: 80px;
        }

        .modal-body .cmd-desc {
            color: var(--text-dim);
        }

        /* Browser warning */
        .browser-warning {
            display: none;
            background: var(--led-red);
            color: white;
            padding: 12px;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
        }

        /* ============================================
           Docked Pendant (embedded in main window)
           ============================================ */
        .docked-pendant {
            position: absolute;
            bottom: 40px;
            right: 12px;
            width: 320px;
            min-width: 100px;
            z-index: 100;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid var(--panel-border);
            resize: both;
            container-type: inline-size;
            container-name: pendant;
        }

        .docked-titlebar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: #3c3c3c;
            border-bottom: 1px solid #2a2a2a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 12px;
            color: #e0e0e0;
        }

        .docked-origin {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .docked-origin::before {
            content: '‚ìò';
            font-size: 14px;
            opacity: 0.7;
        }

        .docked-controls {
            display: flex;
            gap: 4px;
        }

        .docked-popout {
            background: transparent;
            border: none;
            color: #999;
            font-size: 14px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .docked-popout:hover {
            background: #555;
            color: #fff;
        }

        .docked-content {
            background: var(--surface-base);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            height: 200px;
        }

        /* Docked pendant header */
        .dp-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--panel-border);
        }

        .dp-header-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dp-logo { width: 18px; height: 18px; }

        .dp-help {
            padding: 0 4px;
            font-size: 8px;
            min-width: 14px;
            height: 14px;
            background: var(--pendant-btn-bg);
            color: var(--pendant-btn-text);
            border: 1px solid var(--panel-border);
            border-radius: 3px;
            cursor: pointer;
        }

        .dp-lcd {
            flex: 1;
            margin: 0 8px;
            padding: 5px 6px;
            background: var(--pendant-btn-bg);
            color: var(--pendant-btn-text);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            font-weight: bold;
            letter-spacing: 1px;
            border-radius: 2px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .dp-leds {
            display: flex;
            gap: 3px;
        }

        .dp-led {
            width: 6px;
            height: 16px;
            border-radius: 2px;
            background: var(--led-green-dim);
        }

        .dp-led.on { background: var(--led-green); box-shadow: 0 0 6px var(--led-green); }
        .dp-led.blue { background: var(--led-blue-dim); }
        .dp-led.blue.on { background: var(--led-blue); box-shadow: 0 0 6px var(--led-blue); }
        .dp-led.amber { background: var(--led-amber-dim); }
        .dp-led.amber.on { background: var(--led-amber); box-shadow: 0 0 6px var(--led-amber); }

        /* Grid layout for entire pendant content */
        .dp-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: auto 1fr auto;
            grid-template-areas:
                "idl cmd cad esc lck slp wke ptl calc"
                "track track track numpad numpad numpad numpad numpad numpad"
                "popout popout popout jig jig jig conn conn conn";
            gap: 4px;
            font-size: 9px;
            flex: 1;
            min-height: 0;
        }

        .dp-trackpad, .dp-numpad {
            min-height: 0;
        }

        .dp-idl { grid-area: idl; }
        .dp-cmd { grid-area: cmd; }
        .dp-cad { grid-area: cad; }
        .dp-esc { grid-area: esc; }
        .dp-lck { grid-area: lck; }
        .dp-slp { grid-area: slp; }
        .dp-wke { grid-area: wke; }
        .dp-ptl { grid-area: ptl; }
        .dp-calc { grid-area: calc; }
        .dp-trackpad { grid-area: track; }
        .dp-numpad { grid-area: numpad; }
        .dp-popout { grid-area: popout; }
        .dp-jig { grid-area: jig; }
        .dp-conn { grid-area: conn; }

        .dp-status-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-dim);
        }

        .dp-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--led-green-dim);
        }

        .dp-dot.on { background: var(--led-amber); box-shadow: 0 0 4px var(--led-amber); }

        /* Grid action buttons (row 1) */
        .dp-grid button {
            padding: 2px 6px;
            font-size: 8px;
            background: var(--pendant-btn-bg);
            color: var(--pendant-btn-text);
            border: 1px solid var(--panel-border);
            border-radius: 3px;
            cursor: pointer;
        }

        .dp-grid button:hover { border-color: var(--accent-primary); }

        .dp-grid button.active {
            background: var(--accent-primary);
            color: #fff;
            border-color: var(--accent-primary);
        }

        .dp-danger {
            color: var(--accent-secondary) !important;
            border-color: var(--accent-secondary) !important;
        }

        .dp-danger:hover {
            background: var(--accent-secondary) !important;
            color: #fff !important;
        }

        .dp-portal {
            background: var(--fnkey-blue-bg) !important;
            border-color: var(--fnkey-blue-bg) !important;
            color: #fff !important;
        }

        .dp-portal:hover {
            filter: brightness(1.2);
        }

        .dp-trackpad {
            min-height: 80px;
            background: var(--pendant-btn-bg);
            border: 2px solid var(--panel-border);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: crosshair;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.5);
            position: relative;
        }

        .dp-crosshair {
            position: absolute;
            width: 18px;
            height: 18px;
            border: 1px solid var(--text-dim);
            border-radius: 50%;
            opacity: 0.3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-dim);
            transition: all 0.15s;
        }

        .dp-trackpad.captured {
            border-color: var(--accent-primary);
            cursor: none;
        }

        .dp-trackpad.captured .dp-crosshair {
            opacity: 0.8;
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: scale(1.2);
        }

        .dp-numpad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: 1fr;
            gap: 2px;
            background: var(--panel-inset);
            border-radius: 3px;
            padding: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .dp-numpad button {
            padding: 4px 6px;
            font-size: 9px;
            min-height: 0;
            overflow: hidden;
            font-weight: bold;
            background: var(--pendant-btn-bg);
            color: var(--pendant-btn-text);
            border: 1px solid var(--panel-border);
            border-radius: 3px;
            cursor: pointer;
        }

        .dp-numpad button:hover { border-color: var(--accent-primary); }

        .dp-mod {
            font-size: 7px !important;
            font-weight: normal !important;
            color: var(--text-dim) !important;
        }

        .dp-mod.active {
            background: var(--accent-primary) !important;
            color: #fff !important;
        }

        .dp-mod.calc-op {
            font-size: 14px !important;
            font-weight: bold !important;
            color: var(--accent-primary) !important;
        }

        .dp-calc.rpn {
            background: var(--led-amber, #ffaa00) !important;
            color: #000 !important;
        }

        /* Bottom buttons */
        .dp-buttons {
            display: flex;
            gap: 4px;
        }

        .dp-buttons button {
            flex: 1;
            padding: 5px 8px;
            font-size: 9px;
            text-transform: uppercase;
            background: var(--pendant-btn-bg);
            color: var(--pendant-btn-text);
            border: 1px solid var(--panel-border);
            border-radius: 3px;
            cursor: pointer;
        }

        .dp-buttons button:hover { border-color: var(--accent-primary); }

        .dp-primary {
            border-color: var(--accent-primary) !important;
            color: var(--accent-primary) !important;
        }

        .dp-primary:hover {
            background: var(--accent-primary) !important;
            color: #fff !important;
        }

        .dp-danger-btn {
            border-color: var(--accent-secondary) !important;
            color: var(--accent-secondary) !important;
        }

        /* ============================================
           Pendant Container Query Breakpoints
           ============================================ */

        /* Medium: 180-280px - Hide trackpad/numpad, show buttons */
        @container pendant (max-width: 280px) {
            .dp-trackpad,
            .dp-numpad {
                display: none !important;
            }

            .dp-grid {
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: auto auto auto;
                grid-template-areas:
                    "idl cmd cad esc"
                    "lck slp wke ptl"
                    "dock jig calc conn";
            }

            .dp-popout { grid-area: dock; }
        }

        /* Compact: 120-180px - Essential buttons only */
        @container pendant (max-width: 180px) {
            .dp-trackpad,
            .dp-numpad,
            .dp-lck,
            .dp-slp,
            .dp-wke,
            .dp-ptl,
            .dp-calc {
                display: none !important;
            }

            .dp-grid {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: auto auto;
                grid-template-areas:
                    "idl cad esc"
                    "dock jig conn";
            }

            .dp-cmd { display: none !important; }
            .dp-popout { grid-area: dock; }
        }

        /* Minimal: <120px - Just connect */
        @container pendant (max-width: 120px) {
            .dp-trackpad,
            .dp-numpad,
            .dp-lck,
            .dp-slp,
            .dp-wke,
            .dp-ptl,
            .dp-calc,
            .dp-idl,
            .dp-cmd,
            .dp-cad,
            .dp-esc,
            .dp-popout,
            .dp-jig {
                display: none !important;
            }

            .dp-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                grid-template-areas: "conn";
            }

            .dp-header-left { display: none; }
            .dp-lcd { font-size: 9px; }
        }

        /* Header adjustments for medium sizes */
        @container pendant (max-width: 200px) {
            .dp-header-left .dp-logo { display: none; }
            .dp-lcd { font-size: 10px; padding: 3px 6px; }
        }

        @container pendant (max-width: 150px) {
            .dp-header-left { display: none; }
            .dp-leds { gap: 2px; }
            .dp-led { width: 6px; height: 12px; }
        }

        /* Titlebar adjustments */
        @container pendant (max-width: 200px) {
            .docked-origin { font-size: 10px; }
        }

        @container pendant (max-width: 150px) {
            .docked-origin::before { display: none; }
            .docked-titlebar { padding: 4px 8px; }
        }

        @container pendant (max-width: 120px) {
            .docked-origin { display: none; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            body { padding: 6px; }
            .top-bezel { padding: 8px 12px; }
            .brand-model { display: none; }
            .capture-btn { padding: 14px 24px; font-size: 12px; }
            .panel-section { padding: 10px; }
            .fn-key { padding: 5px 3px; font-size: 9px; }
            .action-btn { padding: 8px 6px; font-size: 8px; }
        }
    </style>
</head>
<body>
    <div class="browser-warning" id="browserWarning">
        WEB BLUETOOTH NOT SUPPORTED ‚Äî USE CHROME OR EDGE
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay" onclick="closeHelp(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span id="helpTitle">Help</span>
                <button class="fn-key" onclick="closeHelp()" style="padding: 4px 8px;">√ó</button>
            </div>
            <div class="modal-body" id="helpBody"></div>
        </div>
    </div>

    <!-- Capture Overlay -->
    <div id="captureOverlay">
        <div class="cmd-mode-banner" id="cmdModeBanner">
            <span class="cmd-mode-icon">‚å®</span> COMMAND MODE <span class="cmd-mode-hint">Press key for action</span>
        </div>
        <div class="overlay-content">
            <div class="overlay-indicator"></div>
            <div class="overlay-title">Jacked In</div>
            <div class="overlay-subtitle" id="captureSubtitle">Direct control active</div>
            <div class="overlay-stats">
                <div class="stat-block">
                    <div class="stat-value" id="statMouse">0</div>
                    <div class="stat-label">Mouse</div>
                </div>
                <div class="stat-block">
                    <div class="stat-value" id="statClicks">0</div>
                    <div class="stat-label">Clicks</div>
                </div>
                <div class="stat-block">
                    <div class="stat-value" id="statKeys">0</div>
                    <div class="stat-label">Keys</div>
                </div>
                <div class="stat-block stat-fps" id="statFpsBlock">
                    <div class="stat-value" id="statFps">--</div>
                    <div class="stat-label">FPS</div>
                </div>
            </div>
        </div>
        <div class="overlay-exit">
            Press <kbd id="exitKeyDisplay">ESC</kbd> to jack out <span class="hardware-hint">or press G on Cardputer</span>
        </div>
    </div>

    <!-- Main Chassis -->
    <div class="chassis">
        <!-- Top Bezel -->
        <div class="top-bezel">
            <div class="brand">
                <svg class="brand-icon" viewBox="0 0 128 128" width="28" height="28">
                    <rect x="12" y="16" width="64" height="64" rx="8" fill="var(--logo-block1)"/>
                    <rect x="52" y="48" width="64" height="64" rx="8" fill="var(--logo-block2)"/>
                    <rect x="52" y="48" width="24" height="32" fill="var(--logo-relay)"/>
                </svg>
                <span class="brand-logo">RelayKVM</span>
                <span class="brand-model">BT-HID-01</span>
                <a href="https://github.com/endarthur/RelayKVM" target="_blank" title="View on GitHub" style="display: flex; color: var(--text-dim); transition: color 0.2s;" onmouseover="this.style.color='var(--text-bright)'" onmouseout="this.style.color='var(--text-dim)'">
                    <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                </a>
            </div>
            <div class="status-cluster">
                <div class="led-cluster">
                    <div class="led-bar" title="Link - Connected to device">
                        <span class="led-label">L</span>
                        <div class="led" id="ledLink"></div>
                    </div>
                    <div class="led-bar" title="TX - Sending data">
                        <span class="led-label">T</span>
                        <div class="led blue" id="ledTx"></div>
                    </div>
                    <div class="led-bar" title="RX - Receiving data">
                        <span class="led-label">R</span>
                        <div class="led amber" id="ledRx"></div>
                    </div>
                </div>
                <button class="settings-btn" onclick="openSettingsModal()" title="Settings">&#9881;</button>
                <button class="hw-btn" id="dipBtn" onclick="togglePendant()" title="Open Pendant (DIP)" style="display: none;">DIP</button>
                <button class="hw-btn primary" id="connectBtn" onclick="toggleConnection()" style="min-width: 95px;">Connect</button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settingsModal" onclick="closeSettingsModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>Settings</h3>
                    <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Theme Section -->
                    <div class="settings-section">
                        <div class="settings-section-title">Theme</div>
                        <div class="theme-grid" id="themeGrid">
                            <div class="theme-option" onclick="setThemeFromModal('')" title="Default">
                                <div class="theme-btn active" data-theme=""></div>
                                <div class="theme-btn-label">Default</div>
                            </div>
                            <div class="theme-option" onclick="setThemeFromModal('industrial')" title="Industrial">
                                <div class="theme-btn" data-theme="industrial"></div>
                                <div class="theme-btn-label">Industrial</div>
                            </div>
                            <div class="theme-option" onclick="setThemeFromModal('signal')" title="Signal">
                                <div class="theme-btn" data-theme="signal"></div>
                                <div class="theme-btn-label">Signal</div>
                            </div>
                            <div class="theme-option" onclick="setThemeFromModal('amber')" title="Amber">
                                <div class="theme-btn" data-theme="amber"></div>
                                <div class="theme-btn-label">Amber</div>
                            </div>
                            <div class="theme-option" onclick="setThemeFromModal('koma')" title="Koma">
                                <div class="theme-btn" data-theme="koma"></div>
                                <div class="theme-btn-label">Koma</div>
                            </div>
                            <div class="theme-option" onclick="setThemeFromModal('light')" title="Light">
                                <div class="theme-btn" data-theme="light"></div>
                                <div class="theme-btn-label">Light</div>
                            </div>
                            <div class="theme-option" onclick="setThemeFromModal('ctp-mocha')" title="Catppuccin Mocha">
                                <div class="theme-btn" data-theme="ctp-mocha"></div>
                                <div class="theme-btn-label">Mocha</div>
                            </div>
                            <div class="theme-option" onclick="setThemeFromModal('ctp-macchiato')" title="Catppuccin Macchiato">
                                <div class="theme-btn" data-theme="ctp-macchiato"></div>
                                <div class="theme-btn-label">Macchiato</div>
                            </div>
                            <div class="theme-option" onclick="setThemeFromModal('ctp-frappe')" title="Catppuccin Frapp√©">
                                <div class="theme-btn" data-theme="ctp-frappe"></div>
                                <div class="theme-btn-label">Frapp√©</div>
                            </div>
                            <div class="theme-option" onclick="setThemeFromModal('ctp-latte')" title="Catppuccin Latte">
                                <div class="theme-btn" data-theme="ctp-latte"></div>
                                <div class="theme-btn-label">Latte</div>
                            </div>
                            <!-- Custom theme slots -->
                            <div class="theme-option custom-slot" onclick="selectCustomTheme(1)" oncontextmenu="editCustomTheme(1); return false;" title="Custom 1 (right-click to edit)">
                                <div class="theme-btn" data-theme="custom-1" id="customThemeBtn1"></div>
                                <div class="theme-btn-label" id="customThemeLabel1">Custom 1</div>
                            </div>
                            <div class="theme-option custom-slot" onclick="selectCustomTheme(2)" oncontextmenu="editCustomTheme(2); return false;" title="Custom 2 (right-click to edit)">
                                <div class="theme-btn" data-theme="custom-2" id="customThemeBtn2"></div>
                                <div class="theme-btn-label" id="customThemeLabel2">Custom 2</div>
                            </div>
                            <div class="theme-option custom-slot" onclick="selectCustomTheme(3)" oncontextmenu="editCustomTheme(3); return false;" title="Custom 3 (right-click to edit)">
                                <div class="theme-btn" data-theme="custom-3" id="customThemeBtn3"></div>
                                <div class="theme-btn-label" id="customThemeLabel3">Custom 3</div>
                            </div>
                            <div class="theme-option custom-slot" onclick="selectCustomTheme(4)" oncontextmenu="editCustomTheme(4); return false;" title="Custom 4 (right-click to edit)">
                                <div class="theme-btn" data-theme="custom-4" id="customThemeBtn4"></div>
                                <div class="theme-btn-label" id="customThemeLabel4">Custom 4</div>
                            </div>
                            <div class="theme-option custom-slot" onclick="selectCustomTheme(5)" oncontextmenu="editCustomTheme(5); return false;" title="Custom 5 (right-click to edit)">
                                <div class="theme-btn" data-theme="custom-5" id="customThemeBtn5"></div>
                                <div class="theme-btn-label" id="customThemeLabel5">Custom 5</div>
                            </div>
                        </div>
                        <div style="font-size: 8px; color: var(--text-dim); margin-top: 6px; text-align: center;">
                            Right-click custom slots to edit
                        </div>
                    </div>

                    <!-- Input Section -->
                    <div class="settings-section">
                        <div class="settings-section-title">Input</div>
                        <div class="settings-row">
                            <span class="settings-label">Mouse Sensitivity</span>
                            <div class="settings-value">
                                <input type="range" id="modalMouseSpeed" class="sensitivity-slider settings-slider" min="0.5" max="5" step="0.5" value="2" oninput="updateMouseSpeedFromModal(this.value)">
                                <span class="settings-display" id="modalMouseSpeedVal">2.0x</span>
                            </div>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Scroll Sensitivity</span>
                            <div class="settings-value">
                                <input type="range" id="modalScrollSpeed" class="sensitivity-slider settings-slider" min="1" max="10" step="1" value="3" oninput="updateScrollSpeedFromModal(this.value)">
                                <span class="settings-display" id="modalScrollSpeedVal">3</span>
                            </div>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Exit Capture Key</span>
                            <div class="settings-value">
                                <select id="modalExitKey" class="text-input" style="padding: 4px 8px; font-size: 11px;" onchange="updateExitKeyFromModal(this.value)">
                                    <option value="Escape">ESC</option>
                                    <option value="F12">F12</option>
                                    <option value="ScrollLock">ScrLk</option>
                                    <option value="Pause">Pause</option>
                                </select>
                            </div>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">CapsLock Command Mode</span>
                            <div class="settings-value">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="modalCapsLockMode" onchange="updateCapsLockModeFromModal(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Keyboard Lock (Fullscreen)</span>
                            <div class="settings-value">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="modalKeyboardLock" onchange="updateKeyboardLockFromModal(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Fullscreen on Jack-In</span>
                            <div class="settings-value">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="modalFullscreenOnJackIn" onchange="updateFullscreenOnJackInFromModal(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Edge Release (Jack-In)</span>
                            <div class="settings-value">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="modalEdgeRelease" onchange="updateEdgeReleaseFromModal(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Show Log (no video)</span>
                            <div class="settings-value">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="modalAutoShowLog" onchange="updateAutoShowLogFromModal(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Clipboard Bridge (P)</span>
                            <div class="settings-value">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="modalClipboardBridge" onchange="updateClipboardBridgeFromModal(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Display Section -->
                    <div class="settings-section" id="displaySection" style="display: none;">
                        <div class="settings-section-title">Display</div>
                        <div class="settings-row">
                            <span class="settings-label">DIP Pendant</span>
                            <span class="settings-value" style="font-size: 9px; color: var(--text-dim);">Recommended: 320√ó220</span>
                        </div>
                        <div style="font-size: 9px; color: var(--text-dim); text-align: center;">
                            Browser remembers pendant size. Clear site data to reset.
                        </div>
                    </div>

                    <!-- Data Section -->
                    <div class="settings-section">
                        <div class="settings-section-title">Data</div>
                        <div class="settings-row" style="gap: 8px;">
                            <button class="btn-secondary" onclick="exportSettings()" style="flex: 1;">Export Settings</button>
                            <button class="btn-secondary" onclick="document.getElementById('importSettingsFile').click()" style="flex: 1;">Import Settings</button>
                            <input type="file" id="importSettingsFile" accept=".json" onchange="importSettings(this)" style="display: none;">
                        </div>
                        <div style="font-size: 9px; color: var(--text-dim); margin-bottom: 12px; text-align: center;">
                            Backup or restore all settings, themes, macros, and scripts
                        </div>
                        <div class="danger-zone">
                            <button class="btn-danger-sm" onclick="clearLocalStorage()">Clear All Saved Data</button>
                            <div style="font-size: 9px; color: var(--text-dim); margin-top: 6px; text-align: center;">
                                Resets everything to defaults
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen Manager Modal -->
        <div class="modal-overlay" id="screenManagerModal" onclick="closeScreenManager(event)">
            <div class="modal screen-manager-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>Screen Manager</h3>
                    <button class="modal-close" onclick="closeScreenManager()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="screenManagerContent">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Theme Editor Modal -->
        <div class="theme-editor-overlay" id="themeEditorModal" onclick="closeThemeEditor(event)">
            <div class="theme-editor" onclick="event.stopPropagation()">
                <div class="theme-editor-header">
                    <h3>Edit Custom Theme <span id="themeEditorSlot">1</span></h3>
                    <button class="modal-close" onclick="closeThemeEditor()">&times;</button>
                </div>
                <div class="theme-editor-body">
                    <div class="theme-editor-row">
                        <label>Import from URL</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="themeImportUrl" placeholder="https://example.com/theme.json">
                            <button class="btn-apply" onclick="importThemeFromUrl()" style="flex: 0 0 auto; padding: 8px 12px;">Import</button>
                        </div>
                    </div>
                    <div class="theme-editor-row">
                        <label>Colors (click to pick)</label>
                        <div class="color-picker-grid">
                            <div class="color-picker-item" onmouseenter="highlightJsonKey('accent-primary')" onmouseleave="clearJsonHighlight()">
                                <label>Primary</label>
                                <input type="color" id="colorPrimary" data-key="accent-primary" onchange="updateJsonFromPicker(this)">
                            </div>
                            <div class="color-picker-item" onmouseenter="highlightJsonKey('accent-secondary')" onmouseleave="clearJsonHighlight()">
                                <label>Secondary</label>
                                <input type="color" id="colorSecondary" data-key="accent-secondary" onchange="updateJsonFromPicker(this)">
                            </div>
                            <div class="color-picker-item" onmouseenter="highlightJsonKey('surface-base')" onmouseleave="clearJsonHighlight()">
                                <label>Surface</label>
                                <input type="color" id="colorSurface" data-key="surface-base" onchange="updateJsonFromPicker(this)">
                            </div>
                            <div class="color-picker-item" onmouseenter="highlightJsonKey('panel-bg')" onmouseleave="clearJsonHighlight()">
                                <label>Panel BG</label>
                                <input type="color" id="colorPanelBg" data-key="panel-bg" onchange="updateJsonFromPicker(this)">
                            </div>
                            <div class="color-picker-item" onmouseenter="highlightJsonKey('panel-surface')" onmouseleave="clearJsonHighlight()">
                                <label>Panel Surface</label>
                                <input type="color" id="colorPanelSurface" data-key="panel-surface" onchange="updateJsonFromPicker(this)">
                            </div>
                            <div class="color-picker-item" onmouseenter="highlightJsonKey('display-text')" onmouseleave="clearJsonHighlight()">
                                <label>Display</label>
                                <input type="color" id="colorDisplay" data-key="display-text" onchange="updateJsonFromPicker(this)">
                            </div>
                            <div class="color-picker-item" onmouseenter="highlightJsonKey('text-bright')" onmouseleave="clearJsonHighlight()">
                                <label>Text Bright</label>
                                <input type="color" id="colorTextBright" data-key="text-bright" onchange="updateJsonFromPicker(this)">
                            </div>
                            <div class="color-picker-item" onmouseenter="highlightJsonKey('text-normal')" onmouseleave="clearJsonHighlight()">
                                <label>Text Normal</label>
                                <input type="color" id="colorTextNormal" data-key="text-normal" onchange="updateJsonFromPicker(this)">
                            </div>
                            <div class="color-picker-item" onmouseenter="highlightJsonKey('pendant-btn-bg')" onmouseleave="clearJsonHighlight()">
                                <label>Pendant Btn</label>
                                <input type="color" id="colorPendantBtnBg" data-key="pendant-btn-bg" onchange="updateJsonFromPicker(this)">
                            </div>
                            <div class="color-picker-item" onmouseenter="highlightJsonKey('pendant-btn-text')" onmouseleave="clearJsonHighlight()">
                                <label>Pendant Text</label>
                                <input type="color" id="colorPendantBtnText" data-key="pendant-btn-text" onchange="updateJsonFromPicker(this)">
                            </div>
                        </div>
                    </div>
                    <div class="theme-editor-row">
                        <label>Theme JSON</label>
                        <textarea id="themeJsonEditor" placeholder='{
  "name": "My Theme",
  "accent-primary": "#00ff66",
  "accent-secondary": "#ff6600",
  "surface-base": "#0d0f12",
  "panel-bg": "#1a1d21",
  "display-text": "#00ff66"
}'></textarea>
                    </div>
                    <div class="theme-editor-actions">
                        <button class="btn-cancel" onclick="closeThemeEditor()">Cancel</button>
                        <button class="btn-apply" onclick="saveCustomTheme()">Save Theme</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Panel -->
        <div class="main-panel">
            <!-- Left Column: Video Panel + Quick Actions -->
            <div class="left-column">
                <!-- Jack In Panel - video area -->
                <div class="capture-panel" id="capturePanel">
                    <video id="videoFeed" autoplay playsinline muted></video>
                    <div class="capture-title" id="captureTitle">No Signal</div>
                    <button class="capture-btn" id="captureBtn" onclick="startCapture()" disabled>
                        Jack In
                    </button>
                    <div class="capture-hint">Press <kbd id="exitKeyHint">ESC</kbd> to jack out</div>
                </div>

                <!-- Video Settings -->
                <div class="module">
                    <div class="module-header">
                        <span>Video</span>
                        <div class="led dot" id="ledVideo"></div>
                    </div>
                    <div class="module-body">
                        <div class="video-grid">
                            <!-- Off row -->
                            <label class="radio-btn" id="radioOff">
                                <input type="radio" name="videoMode" value="off" checked onchange="setVideoMode('off')">
                                <span>Off</span>
                            </label>
                            <span class="video-hint">No video capture</span>
                            <!-- USB row -->
                            <label class="radio-btn" id="radioUsb">
                                <input type="radio" name="videoMode" value="usb" onchange="setVideoMode('usb')">
                                <span>USB</span>
                            </label>
                            <div style="display: flex; gap: 4px;">
                                <select id="captureDevice" class="text-input" style="flex: 1; padding: 3px; font-size: 9px;" disabled onchange="queryDeviceCapabilities()">
                                    <option value="">Select device...</option>
                                </select>
                                <button class="fn-key green" id="startCaptureBtn" onclick="toggleCapture()" style="padding: 3px 8px; font-size: 9px;" disabled>Start</button>
                            </div>
                            <!-- WebRTC row -->
                            <label class="radio-btn" id="radioWebrtc">
                                <input type="radio" name="videoMode" value="webrtc" onchange="setVideoMode('webrtc')">
                                <span>RTC</span>
                            </label>
                            <div style="display: flex; gap: 4px;">
                                <input type="text" id="peerId" class="text-input" style="flex: 1; padding: 3px; font-size: 9px;" placeholder="Peer ID..." disabled>
                                <button class="fn-key green" id="connectPeerBtn" onclick="connectPeer()" style="padding: 3px 8px; font-size: 9px;" disabled>Connect</button>
                            </div>
                            <!-- Screen Share row -->
                            <label class="radio-btn" id="radioScreen">
                                <input type="radio" name="videoMode" value="screen" onchange="setVideoMode('screen')">
                                <span>Screen</span>
                            </label>
                            <div style="display: flex; gap: 4px;">
                                <span class="video-hint" style="flex: 1; font-size: 8px;">Share any screen/window</span>
                                <button class="fn-key green" id="startScreenBtn" onclick="toggleScreenShare()" style="padding: 3px 8px; font-size: 9px;" disabled>Share</button>
                            </div>
                        </div>
                        <!-- Resolution/FPS row -->
                        <div id="videoParams" class="video-params disabled" style="display: flex; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--panel-border);">
                            <div style="flex: 1;">
                                <label class="led-label" style="font-size: 8px;">Resolution</label>
                                <select id="videoRes" class="text-input" style="width: 100%; padding: 3px; font-size: 9px;">
                                    <option value="1080">1080p</option>
                                    <option value="720" selected>720p</option>
                                    <option value="480">480p</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label class="led-label" style="font-size: 8px;">FPS</label>
                                <select id="videoFps" class="text-input" style="width: 100%; padding: 3px; font-size: 9px;">
                                    <option value="60">60</option>
                                    <option value="30" selected>30</option>
                                    <option value="15">15</option>
                                </select>
                            </div>
                        </div>
                        <!-- Seamless Mode -->
                        <div style="display: flex; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--panel-border); align-items: flex-start;">
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <button class="fn-key" id="seamlessBtn" onclick="toggleSeamlessMode()" style="padding: 4px 8px; font-size: 9px;" title="Mouse flows naturally (Pico 2W only)">Seamless</button>
                                <span style="font-size: 7px; color: var(--text-dim); margin-top: 2px;">PICO ONLY</span>
                            </div>
                            <button class="fn-key blue" onclick="openSeamlessWindow()" style="padding: 4px 8px; font-size: 9px;" title="Open capture window for dummy monitor">Portal</button>
                            <button class="fn-key" id="screensBtn" onclick="openScreenManager()" style="padding: 4px 8px; font-size: 9px;" title="Manage screens for portal">Screens</button>
                            <button class="fn-key red" onclick="closePortal()" style="padding: 4px 8px; font-size: 9px;" title="Close portal window">‚úï</button>
                            <select id="seamlessEdgeSelect" class="text-input" style="flex: 1; padding: 3px; font-size: 9px;" onchange="setSeamlessEdge(this.value)" title="Where is the portal window?">
                                <option value="left">Portal ‚Üê Left</option>
                                <option value="right">Right ‚Üí Portal</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions below video -->
                <div class="extras-row" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="module">
                        <div class="module-header"><span>System</span></div>
                        <div class="module-body">
                            <div class="btn-grid cols-2">
                                <button class="action-btn red" onclick="sendCombo(['ctrl', 'alt', 'delete'])">
                                    C+A+Del
                                    <span class="shortcut">Security</span>
                                </button>
                                <button class="action-btn" onclick="sendCombo(['ctrl', 'shift', 'escape'])">
                                    TaskMgr
                                    <span class="shortcut">C+S+Esc</span>
                                </button>
                                <button class="action-btn red" onclick="sendCombo(['alt', 'f4'])">
                                    Close
                                    <span class="shortcut">Alt+F4</span>
                                </button>
                                <button class="action-btn blue" onclick="sendCombo(['alt', 'tab'])">
                                    Switch
                                    <span class="shortcut">Alt+Tab</span>
                                </button>
                                <button class="action-btn amber" onclick="sendCombo(['gui', 'l'])">
                                    Lock
                                    <span class="shortcut">Win+L</span>
                                </button>
                                <button class="action-btn blue" onclick="sendCombo(['gui', 'd'])">
                                    Desktop
                                    <span class="shortcut">Win+D</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="module">
                        <div class="module-header"><span>Clipboard</span></div>
                        <div class="module-body">
                            <div class="btn-grid cols-2">
                                <button class="action-btn green" onclick="sendCombo(['ctrl', 'c'])">
                                    Copy
                                    <span class="shortcut">Ctrl+C</span>
                                </button>
                                <button class="action-btn green" onclick="sendCombo(['ctrl', 'v'])">
                                    Paste
                                    <span class="shortcut">Ctrl+V</span>
                                </button>
                                <button class="action-btn" onclick="sendCombo(['ctrl', 'x'])">
                                    Cut
                                    <span class="shortcut">Ctrl+X</span>
                                </button>
                                <button class="action-btn" onclick="sendCombo(['ctrl', 'a'])">
                                    Sel All
                                    <span class="shortcut">Ctrl+A</span>
                                </button>
                                <button class="action-btn" onclick="sendCombo(['ctrl', 'z'])">
                                    Undo
                                    <span class="shortcut">Ctrl+Z</span>
                                </button>
                                <button class="action-btn" onclick="sendCombo(['ctrl', 'y'])">
                                    Redo
                                    <span class="shortcut">Ctrl+Y</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Grid layout -->
            <div class="right-column">
                <!-- Text Input -->
                <div class="module area-tinput">
                    <div class="module-header"><span>Text Input</span></div>
                    <div class="module-body">
                        <div class="text-input-row">
                            <input type="text" class="text-input" id="textInput" placeholder="Type to send...">
                            <button class="hw-btn primary" id="sendTextBtn" onclick="sendText()" disabled>Send</button>
                        </div>
                    </div>
                </div>

                <!-- Keypad -->
                <div class="module area-keys">
                    <div class="module-header"><span>Keypad</span></div>
                    <div class="module-body">
                        <!-- F-keys block -->
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 2px;">
                            <button class="fn-key red" onclick="sendKey('esc')">Esc</button>
                            <button class="fn-key amber fkey" data-base="1" onclick="sendFKey(1)">F1</button>
                            <button class="fn-key amber fkey" data-base="2" onclick="sendFKey(2)">F2</button>
                            <button class="fn-key amber fkey" data-base="3" onclick="sendFKey(3)">F3</button>
                            <button class="fn-key amber fkey" data-base="4" onclick="sendFKey(4)">F4</button>
                        </div>
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 2px;">
                            <button class="fn-key red" onclick="sendKey('delete')">Del</button>
                            <button class="fn-key amber fkey" data-base="5" onclick="sendFKey(5)">F5</button>
                            <button class="fn-key amber fkey" data-base="6" onclick="sendFKey(6)">F6</button>
                            <button class="fn-key amber fkey" data-base="7" onclick="sendFKey(7)">F7</button>
                            <button class="fn-key amber fkey" data-base="8" onclick="sendFKey(8)">F8</button>
                        </div>
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 4px;">
                            <button class="fn-key" onclick="sendKey('printscreen')">Prt</button>
                            <button class="fn-key amber fkey" data-base="9" onclick="sendFKey(9)">F9</button>
                            <button class="fn-key amber fkey" data-base="10" onclick="sendFKey(10)">F10</button>
                            <button class="fn-key amber fkey" data-base="11" onclick="sendFKey(11)">F11</button>
                            <button class="fn-key amber fkey" data-base="12" onclick="sendFKey(12)">F12</button>
                        </div>
                        <!-- Navigation keys -->
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 2px;">
                            <button class="fn-key" onclick="sendKey('insert')">Ins</button>
                            <button class="fn-key blue" onclick="sendKey('home')">Home</button>
                            <button class="fn-key blue" onclick="sendKey('end')">End</button>
                            <button class="fn-key" onclick="sendKey('backspace')">Bksp</button>
                            <button class="fn-key blue" onclick="sendKey('pageup')">PgUp</button>
                        </div>
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 4px;">
                            <button class="fn-key green" onclick="sendKey('tab')">Tab</button>
                            <button class="fn-key" onclick="sendKey('space')" style="grid-column: span 3;">Space</button>
                            <button class="fn-key blue" onclick="sendKey('pagedown')">PgDn</button>
                        </div>
                        <!-- Arrows + Modifiers combined -->
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 2px;">
                            <button class="fn-key" id="modCtrl" onclick="toggleModifier('ctrl')">Ctrl</button>
                            <button class="fn-key" id="modShift" onclick="toggleModifier('shift')">Shift</button>
                            <button class="fn-key blue" onclick="sendKey('up')">‚Üë</button>
                            <button class="fn-key" id="modAlt" onclick="toggleModifier('alt')">Alt</button>
                            <button class="fn-key" id="modGui" onclick="toggleModifier('gui')">Super</button>
                        </div>
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr);">
                            <button class="fn-key" id="modHyper" onclick="toggleHyper()">Hyper</button>
                            <button class="fn-key blue" onclick="sendKey('left')">‚Üê</button>
                            <button class="fn-key blue" onclick="sendKey('down')">‚Üì</button>
                            <button class="fn-key blue" onclick="sendKey('right')">‚Üí</button>
                            <button class="fn-key green" onclick="sendKey('enter')">Enter</button>
                        </div>
                        <!-- Media keys -->
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-top: 4px; font-size: 16px;">
                            <button class="fn-key" onclick="sendMediaKey('prevTrack')">‚èÆ</button>
                            <button class="fn-key" onclick="sendMediaKey('playPause')">‚èØ</button>
                            <button class="fn-key" onclick="sendMediaKey('stop')">‚èπ</button>
                            <button class="fn-key" onclick="sendMediaKey('nextTrack')">‚è≠</button>
                            <button class="fn-key" onclick="sendCombo(['ctrl','shift','m'])" title="Teams Mute">‚ìÇ</button>
                        </div>
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-top: 2px; font-size: 16px;">
                            <button class="fn-key" onclick="sendMediaKey('mute')">üîá</button>
                            <button class="fn-key" onclick="sendMediaKey('volumeDown')">üîâ</button>
                            <button class="fn-key" onclick="sendMediaKey('volumeUp')">üîä</button>
                            <button class="fn-key amber" id="fnLayerBtn" onclick="toggleFnLayer()" style="grid-column: span 2; font-size: 11px;">Fn Layer</button>
                        </div>
                    </div>
                </div>

                <!-- Mouse -->
                <div class="module area-mouse">
                    <div class="module-header">
                        <span>Mouse</span>
                        <span class="seg-display dim" id="mouseCoords">0, 0</span>
                    </div>
                    <div class="module-body" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="trackpad" id="trackpad" style="flex: 1; height: auto; min-height: 120px;">
                            <div class="trackpad-center" id="trackpadCenter">+</div>
                        </div>
                        <div class="btn-grid cols-3" style="margin-top: 8px;">
                            <button class="hw-btn" id="mouseBtnL" data-button="left">L</button>
                            <button class="hw-btn" id="mouseBtnM" data-button="middle">M</button>
                            <button class="hw-btn" id="mouseBtnR" data-button="right">R</button>
                        </div>
                        <div class="btn-grid cols-2" style="margin-top: 4px;">
                            <button class="hw-btn" onclick="mouseScroll(scrollSensitivity)">‚ñ≤</button>
                            <button class="hw-btn" onclick="mouseScroll(-scrollSensitivity)">‚ñº</button>
                        </div>
                    </div>
                </div>

                <!-- Jiggler -->
                <div class="module area-jiggler">
                    <div class="module-header">
                        <span>Jiggler</span>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <button class="fn-key" onclick="showHelp('jiggler')" style="padding: 2px 6px; font-size: 8px;">?</button>
                            <div class="led dot" id="ledJiggler"></div>
                        </div>
                    </div>
                    <div class="module-body">
                        <button class="hw-btn" id="jigglerBtn" onclick="toggleJiggler()" style="width: 100%; margin-bottom: 4px; padding: 5px;">
                            Start
                        </button>
                        <div style="margin-bottom: 4px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <label class="led-label" style="font-size: 8px;">Range</label>
                                <span class="seg-display" style="padding: 1px 4px; font-size: 9px;" id="jigglerRangeVal">5</span>
                            </div>
                            <input type="range" id="jigglerRange" min="1" max="20" step="1" value="5" class="sensitivity-slider">
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <label class="led-label" style="font-size: 8px;">Interval</label>
                                <span class="seg-display" style="padding: 1px 4px; font-size: 9px;" id="jigglerIntervalVal">30</span>
                            </div>
                            <input type="range" id="jigglerInterval" min="1" max="120" step="1" value="30" class="sensitivity-slider">
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; padding-top: 6px; border-top: 1px solid var(--border-color);">
                            <label class="led-label" style="font-size: 8px;">Wake Lock</label>
                            <label class="toggle-switch" style="transform: scale(0.8);">
                                <input type="checkbox" id="wakeLockToggle" onchange="updateWakeLockSetting(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Sensitivity -->
                <div class="module area-settings">
                    <div class="module-header"><span>Sensitivity</span></div>
                    <div class="module-body">
                        <div style="margin-bottom: 4px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <label class="led-label" style="font-size: 8px;">Mouse</label>
                                <span class="seg-display" style="padding: 1px 4px; font-size: 9px;" id="mouseSpeedVal">2.0x</span>
                            </div>
                            <input type="range" id="mouseSpeed" min="0.5" max="5" step="0.5" value="2" class="sensitivity-slider">
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <label class="led-label" style="font-size: 8px;">Scroll</label>
                                <span class="seg-display" style="padding: 1px 4px; font-size: 9px;" id="scrollSpeedVal">3</span>
                            </div>
                            <input type="range" id="scrollSpeed" min="1" max="10" step="1" value="3" class="sensitivity-slider">
                        </div>
                    </div>
                </div>

                <!-- Wake/Power -->
                <div class="module area-wakepower">
                    <div class="module-header">
                        <span>Wake/Power</span>
                        <button class="fn-key" onclick="sendSleep()" style="padding: 2px 6px; font-size: 8px;" title="Windows: Win+X,U,S">Sleep</button>
                    </div>
                    <div class="module-body" style="padding: 6px;">
                        <div class="wakepower-grid">
                            <button class="fn-key green wake-btn" onclick="sendWake()">Wake</button>
                            <button class="fn-key wake-btn" onclick="sendUsbWake()" style="background: var(--panel-raised);">USB Wake</button>
                            <button class="arm-btn" id="powerArm" onclick="togglePowerArm()">‚ö†</button>
                            <button class="fn-key red power-btn" id="powerBtn" onclick="sendPower()">PWR</button>
                        </div>
                    </div>
                </div>

                <!-- Device Control -->
                <div class="module area-cardputer">
                    <div class="module-header">
                        <span>Device</span>
                        <span class="seg-display dim" id="connLatency" style="padding: 1px 4px; font-size: 9px;">--ms</span>
                    </div>
                    <div class="module-body">
                        <!-- Connection row -->
                        <div style="display: flex; gap: 4px; align-items: center; margin-bottom: 4px;">
                            <div class="signal-bars" id="signalBars">
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                            </div>
                            <span class="led-label" id="connStatus" style="flex: 1;">Disconnected</span>
                            <button class="fn-key" onclick="reconnect()" style="padding: 3px 6px; font-size: 8px;">Reconnect</button>
                        </div>
                        <!-- Device recovery controls -->
                        <div class="btn-grid cols-2" style="margin-bottom: 4px;">
                            <button class="fn-key" onclick="recoverUsb()" title="Attempt USB recovery (may reset device)">USB Recovery</button>
                            <button class="fn-key red" onclick="resetDevice()" title="Full device restart">Reset Device</button>
                        </div>
                        <!-- Cardputer-specific display controls -->
                        <div style="margin-top: 4px; padding-top: 4px; border-top: 1px solid var(--panel-border);">
                            <label class="led-label" style="font-size: 8px; margin-bottom: 4px; display: block; color: var(--text-dim);">Cardputer Display</label>
                            <div class="btn-grid cols-3" style="margin-bottom: 4px;">
                                <button class="fn-key" id="dispOff" onclick="setDisplay('off')">Off</button>
                                <button class="fn-key" id="dispDim" onclick="setDisplay('dim')">Dim</button>
                                <button class="fn-key blue" id="dispOn" onclick="setDisplay('on')">On</button>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <label class="led-label" style="font-size: 8px;">Timeout</label>
                                <span class="seg-display" style="padding: 1px 4px; font-size: 9px;" id="dispTimeoutVal">30s</span>
                            </div>
                            <input type="range" id="dispTimeout" min="0" max="300" step="10" value="30" class="sensitivity-slider">
                        </div>
                    </div>
                </div>

                <!-- Scripts -->
                <div class="module area-scripts">
                    <div class="module-header">
                        <span>Scripts</span>
                        <div style="display: flex; gap: 4px;">
                            <button class="fn-key" onclick="showHelp('scripts')" style="padding: 2px 6px; font-size: 8px;">?</button>
                            <button class="fn-key green" id="runScriptBtn" onclick="runScript()" style="padding: 2px 6px; font-size: 8px;">Run</button>
                        </div>
                    </div>
                    <div class="module-body" style="flex: 1; display: flex; flex-direction: column;">
                        <textarea id="scriptEditor" class="script-editor" placeholder="type Hello World&#10;delay 500&#10;key enter&#10;combo ctrl+s"></textarea>
                        <div style="display: flex; gap: 4px; margin-top: 4px;">
                            <select id="scriptSlot" class="text-input" style="width: 40px; padding: 2px; font-size: 9px;">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                            <button class="fn-key" onclick="loadScript()" style="padding: 2px 6px; font-size: 8px;">Load</button>
                            <button class="fn-key" onclick="saveScript()" style="padding: 2px 6px; font-size: 8px;">Save</button>
                        </div>
                    </div>
                </div>


                <!-- Macros -->
                <div class="module area-macros">
                    <div class="module-header">
                        <span>Macros</span>
                        <button class="fn-key" onclick="showHelp('macros')" style="padding: 2px 6px; font-size: 8px;">?</button>
                    </div>
                    <div class="module-body">
                        <div class="btn-grid cols-4" style="margin-bottom: 6px;">
                            <button class="fn-key" id="macroBtn1" onclick="playMacro(1)" oncontextmenu="editMacro(1, event)">1</button>
                            <button class="fn-key" id="macroBtn2" onclick="playMacro(2)" oncontextmenu="editMacro(2, event)">2</button>
                            <button class="fn-key" id="macroBtn3" onclick="playMacro(3)" oncontextmenu="editMacro(3, event)">3</button>
                            <button class="fn-key" id="macroBtn4" onclick="playMacro(4)" oncontextmenu="editMacro(4, event)">4</button>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <select id="macroSelect" class="text-input" style="width: 40px; padding: 4px; font-size: 10px;">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                            <input type="text" id="macroEdit" class="text-input" style="flex: 1; padding: 4px; font-size: 10px;" placeholder="Macro text...">
                            <button class="fn-key green" onclick="saveMacro()" style="padding: 4px 8px;">Set</button>
                        </div>
                    </div>
                </div>

                <!-- Log -->
                <div class="module area-log">
                    <div class="module-header">
                        <span>Log</span>
                        <button class="fn-key" onclick="clearLog()" style="padding: 2px 6px; font-size: 8px;">CLR</button>
                    </div>
                    <div class="module-body" style="padding: 0; flex: 1; display: flex; min-height: 0;">
                        <div class="log-display" id="log" style="flex: 1; min-height: 0;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Bezel -->
        <div class="bottom-bezel">
            <div class="bezel-text">Bluetooth HID Relay</div>
            <div style="display: flex; gap: 8px;">
                <div class="screw"></div>
                <div class="screw"></div>
            </div>
            <div class="bezel-text">GCU ¬∑ v1.0</div>
        </div>

        <!-- Docked Pendant -->
        <div class="docked-pendant" id="dockedPendant" style="display: none;">
            <div class="docked-titlebar">
                <span class="docked-origin">localhost:6502</span>
                <div class="docked-controls">
                    <button class="docked-popout" onclick="popOutPendant()" title="Pop out to floating window">‚ßâ</button>
                </div>
            </div>
            <div class="docked-content">
                <div class="dp-header">
                    <div class="dp-header-left">
                        <svg class="dp-logo" viewBox="0 0 128 128" width="18" height="18">
                            <rect x="12" y="16" width="64" height="64" rx="8" fill="var(--accent-primary)"/>
                            <rect x="52" y="48" width="64" height="64" rx="8" fill="var(--accent-secondary)"/>
                            <rect x="52" y="48" width="24" height="32" fill="#ffffff"/>
                        </svg>
                        <button class="dp-help" onclick="showHelp('pendant')" title="Help">?</button>
                    </div>
                    <div class="dp-lcd" id="dpLcd">READY</div>
                    <div class="dp-leds">
                        <div class="dp-led" id="dpLedLink" title="Link"></div>
                        <div class="dp-led blue" id="dpLedTx" title="TX"></div>
                        <div class="dp-led amber" id="dpLedRx" title="RX"></div>
                    </div>
                </div>
                <div class="dp-grid">
                    <div class="dp-idl dp-status-item"><div class="dp-dot" id="dpDotJacked"></div><span id="dpStatusJacked">IDL</span></div>
                    <div class="dp-cmd dp-status-item"><div class="dp-dot" id="dpDotCmd"></div><span id="dpStatusCmd">CMD</span></div>
                    <button class="dp-cad dp-danger" onclick="sendCombo(['ctrl','alt','delete'])" title="Ctrl+Alt+Delete">CAD</button>
                    <button class="dp-esc" onclick="dpEscape()" title="Escape / Clear calc">Esc</button>
                    <button class="dp-lck" onclick="sendCombo(['gui','l'])" title="Lock">Lck</button>
                    <button class="dp-slp" onclick="sendSleep()" title="Sleep">Slp</button>
                    <button class="dp-wke" onclick="sendWake()" title="Wake">Wke</button>
                    <button class="dp-ptl dp-portal" onclick="openPortal()" title="Open Portal">Ptl</button>
                    <button class="dp-calc" id="dpCalcBtn" onclick="toggleCalcMode()" title="Calculator mode">Calc</button>
                    <div class="dp-trackpad" id="dpTrackpad">
                        <span class="dp-crosshair">+</span>
                    </div>
                    <div class="dp-numpad">
                        <button onclick="dpNumpadKey('7')">7</button>
                        <button onclick="dpNumpadKey('8')">8</button>
                        <button onclick="dpNumpadKey('9')">9</button>
                        <button class="dp-mod" id="dpModShift" onclick="dpToggleMod('shift')">Shft</button>
                        <button onclick="dpNumpadKey('4')">4</button>
                        <button onclick="dpNumpadKey('5')">5</button>
                        <button onclick="dpNumpadKey('6')">6</button>
                        <button class="dp-mod" id="dpModCtrl" onclick="dpToggleMod('ctrl')">Ctrl</button>
                        <button onclick="dpNumpadKey('1')">1</button>
                        <button onclick="dpNumpadKey('2')">2</button>
                        <button onclick="dpNumpadKey('3')">3</button>
                        <button class="dp-mod" id="dpModAlt" onclick="dpToggleMod('alt')">Alt</button>
                        <button onclick="dpNumpadKey('0')">0</button>
                        <button onclick="dpNumpadKey('.')">.</button>
                        <button onclick="dpNumpadKey('enter')">‚Üµ</button>
                        <button class="dp-mod" id="dpModGui" onclick="dpToggleMod('gui')">Win</button>
                    </div>
                    <button class="dp-popout" onclick="popOutPendant()">Pop Out</button>
                    <button class="dp-jig dp-primary" id="dpJigglerBtn" onclick="toggleJiggler()">Jig</button>
                    <button class="dp-conn dp-primary" id="dpConnectBtn" onclick="toggleConnection()">Conn</button>
                </div>
            </div>
        </div>
    </div>

    <script src="relaykvm-adapter.js"></script>
    <script>
        // ============================================
        // RelayKVM Industrial Controller
        // ============================================

        let kvm = null;
        let knownDevice = null;  // For quick reconnect
        let isDragging = false;
        let lastX = 0, lastY = 0;
        let txTimeout = null, rxTimeout = null;

        // Theme management
        function setTheme(theme) {
            if (theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('relaykvm-theme', theme);
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.removeItem('relaykvm-theme');
            }
            updateThemeButtons(theme);
            updatePwaThemeColor();
            updatePendantTheme();
        }

        // Update PWA title bar color to match current theme
        function updatePwaThemeColor() {
            const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme && accentColor) {
                metaTheme.setAttribute('content', accentColor);
            }
        }

        function setThemeFromModal(theme) {
            setTheme(theme);
        }

        function updateThemeButtons(activeTheme) {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                const btnTheme = btn.getAttribute('data-theme');
                btn.classList.toggle('active', btnTheme === activeTheme);
            });
        }

        // Custom Theme System
        let currentEditingSlot = 1;
        const customThemes = {};

        // Default custom theme template
        const defaultCustomTheme = {
            name: "Custom Theme",
            "accent-primary": "#00ff66",
            "accent-secondary": "#ff6600",
            "surface-base": "#0d0f12",
            "panel-bg": "#1a1d21",
            "panel-surface": "#22262b",
            "display-text": "#00ff66",
            "text-bright": "#e8eaed",
            "text-normal": "#9aa0a6"
        };

        // Load custom themes from localStorage
        function loadCustomThemes() {
            for (let i = 1; i <= 5; i++) {
                const saved = localStorage.getItem(`customTheme${i}`);
                if (saved) {
                    try {
                        customThemes[i] = JSON.parse(saved);
                        updateCustomSlotAppearance(i);
                    } catch (e) {
                        console.error(`Failed to parse custom theme ${i}:`, e);
                    }
                }
            }
        }

        // Update the visual appearance of a custom slot
        function updateCustomSlotAppearance(slot) {
            const theme = customThemes[slot];
            const btn = document.getElementById(`customThemeBtn${slot}`);
            const label = document.getElementById(`customThemeLabel${slot}`);

            if (theme && btn) {
                btn.classList.add('has-theme');
                btn.style.setProperty('--custom-primary', theme['accent-primary'] || '#666');
                btn.style.setProperty('--custom-secondary', theme['accent-secondary'] || '#444');
                btn.style.background = theme['surface-base'] || '#0d0f12';
                // Set pseudo-element colors via CSS custom properties
                btn.style.cssText = `
                    background: ${theme['surface-base'] || '#0d0f12'};
                `;
                // We need to use a different approach for ::before and ::after
                const style = document.createElement('style');
                style.textContent = `
                    .theme-btn[data-theme="custom-${slot}"]::before { background: ${theme['accent-primary'] || '#666'} !important; }
                    .theme-btn[data-theme="custom-${slot}"]::after { background: ${theme['accent-secondary'] || '#444'} !important; }
                `;
                style.id = `custom-theme-style-${slot}`;
                const existing = document.getElementById(`custom-theme-style-${slot}`);
                if (existing) existing.remove();
                document.head.appendChild(style);

                if (label) label.textContent = theme.name || `Custom ${slot}`;
            } else if (btn) {
                btn.classList.remove('has-theme');
                if (label) label.textContent = `Custom ${slot}`;
            }
        }

        // Select a custom theme
        function selectCustomTheme(slot) {
            const theme = customThemes[slot];
            if (!theme) {
                // No theme defined, open editor
                editCustomTheme(slot);
                return;
            }
            applyCustomTheme(slot);
        }

        // Apply a custom theme
        function applyCustomTheme(slot) {
            const theme = customThemes[slot];
            if (!theme) return;

            // Create dynamic CSS for this custom theme
            let styleEl = document.getElementById('custom-theme-active');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'custom-theme-active';
                document.head.appendChild(styleEl);
            }

            const css = `
                [data-theme="custom-${slot}"] {
                    --accent-primary: ${theme['accent-primary'] || '#00ff66'};
                    --accent-secondary: ${theme['accent-secondary'] || '#ff6600'};
                    --surface-base: ${theme['surface-base'] || '#0d0f12'};
                    --panel-bg: ${theme['panel-bg'] || '#1a1d21'};
                    --panel-surface: ${theme['panel-surface'] || '#22262b'};
                    --display-text: ${theme['display-text'] || '#00ff66'};
                    --text-bright: ${theme['text-bright'] || '#e8eaed'};
                    --text-normal: ${theme['text-normal'] || '#9aa0a6'};
                    --logo-block1: ${theme['accent-primary'] || '#00ff66'};
                    --logo-block2: ${theme['accent-secondary'] || '#ff6600'};
                    --btn-primary-text: ${theme['accent-primary'] || '#00ff66'};
                }
            `;
            styleEl.textContent = css;

            document.documentElement.setAttribute('data-theme', `custom-${slot}`);
            localStorage.setItem('relaykvm-theme', `custom-${slot}`);
            updateThemeButtons(`custom-${slot}`);
        }

        // Open theme editor
        function editCustomTheme(slot) {
            currentEditingSlot = slot;
            document.getElementById('themeEditorSlot').textContent = slot;

            const theme = customThemes[slot] || defaultCustomTheme;
            document.getElementById('themeJsonEditor').value = JSON.stringify(theme, null, 2);
            document.getElementById('themeImportUrl').value = '';

            updateThemePreview(theme);
            document.getElementById('themeEditorModal').classList.add('active');
        }

        // Close theme editor
        function closeThemeEditor(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('themeEditorModal').classList.remove('active');
        }

        // Update color pickers from theme
        function updateThemePreview(theme) {
            updateColorPickers(theme);
        }

        // Sync color pickers with theme values
        function updateColorPickers(theme) {
            const pickers = document.querySelectorAll('.color-picker-grid input[type="color"]');
            pickers.forEach(picker => {
                const key = picker.dataset.key;
                if (theme[key]) {
                    picker.value = theme[key];
                }
            });
        }

        // Update JSON when color picker changes
        function updateJsonFromPicker(input) {
            const key = input.dataset.key;
            const value = input.value;
            const editor = document.getElementById('themeJsonEditor');

            try {
                const theme = JSON.parse(editor.value);
                theme[key] = value;
                editor.value = JSON.stringify(theme, null, 2);
            } catch (e) {
                // Invalid JSON, ignore
            }
        }

        // Highlight corresponding JSON line on color picker hover
        function highlightJsonKey(key) {
            const editor = document.getElementById('themeJsonEditor');
            const text = editor.value;

            // Find the key in the JSON
            const pattern = new RegExp(`"${key}"\\s*:\\s*"[^"]*"`);
            const match = text.match(pattern);

            if (match) {
                const start = text.indexOf(match[0]);
                const end = start + match[0].length;
                editor.focus();
                editor.setSelectionRange(start, end);
            }
        }

        // Clear JSON highlight
        function clearJsonHighlight() {
            const editor = document.getElementById('themeJsonEditor');
            // Move cursor to end to clear selection
            editor.setSelectionRange(editor.value.length, editor.value.length);
        }

        // Save custom theme
        function saveCustomTheme() {
            const jsonText = document.getElementById('themeJsonEditor').value;
            try {
                const theme = JSON.parse(jsonText);
                customThemes[currentEditingSlot] = theme;
                localStorage.setItem(`customTheme${currentEditingSlot}`, JSON.stringify(theme));
                updateCustomSlotAppearance(currentEditingSlot);
                closeThemeEditor();
                log(`Custom theme ${currentEditingSlot} saved: ${theme.name || 'Unnamed'}`, 'info');
            } catch (e) {
                alert('Invalid JSON: ' + e.message);
            }
        }

        // Import theme from URL
        async function importThemeFromUrl() {
            const url = document.getElementById('themeImportUrl').value.trim();
            if (!url) {
                alert('Please enter a URL');
                return;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const theme = await response.json();
                document.getElementById('themeJsonEditor').value = JSON.stringify(theme, null, 2);
                updateThemePreview(theme);
                log(`Theme imported from ${url}`, 'info');
            } catch (e) {
                alert('Failed to import theme: ' + e.message);
            }
        }

        // Live preview while editing
        document.addEventListener('DOMContentLoaded', () => {
            const editor = document.getElementById('themeJsonEditor');
            if (editor) {
                editor.addEventListener('input', () => {
                    try {
                        const theme = JSON.parse(editor.value);
                        updateThemePreview(theme);
                    } catch (e) {
                        // Invalid JSON, ignore
                    }
                });
            }
            loadCustomThemes();
        });

        // Settings Modal
        function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.classList.add('active');
            syncSettingsModal();
        }

        function closeSettingsModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('settingsModal').classList.remove('active');
        }

        function syncSettingsModal() {
            // Sync theme buttons
            const currentTheme = document.documentElement.getAttribute('data-theme') || '';
            updateThemeButtons(currentTheme);

            // Sync input settings - these reference variables defined later in the code
            const savedMouse = parseFloat(localStorage.getItem('mouseSensitivity')) || 2;
            const savedScroll = parseInt(localStorage.getItem('scrollSensitivity')) || 3;
            const savedExitKey = localStorage.getItem('exitKey') || 'Escape';
            const savedCapsLock = localStorage.getItem('capsLockCmdMode') === 'true';
            const savedKeyboardLock = localStorage.getItem('keyboardLockEnabled') !== 'false'; // default true
            const savedFullscreenOnJackIn = localStorage.getItem('fullscreenOnJackIn') === 'true'; // default false
            const savedEdgeRelease = localStorage.getItem('edgeRelease') !== 'false'; // default true
            const savedAutoShowLog = localStorage.getItem('autoShowLogNoVideo') !== 'false'; // default true
            const savedClipboardBridge = localStorage.getItem('clipboardBridgeEnabled') === 'true'; // default false

            document.getElementById('modalMouseSpeed').value = savedMouse;
            document.getElementById('modalMouseSpeedVal').textContent = savedMouse.toFixed(1) + 'x';
            document.getElementById('modalScrollSpeed').value = savedScroll;
            document.getElementById('modalScrollSpeedVal').textContent = savedScroll;
            document.getElementById('modalExitKey').value = savedExitKey;
            document.getElementById('modalCapsLockMode').checked = savedCapsLock;
            document.getElementById('modalKeyboardLock').checked = savedKeyboardLock;
            document.getElementById('modalFullscreenOnJackIn').checked = savedFullscreenOnJackIn;
            document.getElementById('modalEdgeRelease').checked = savedEdgeRelease;
            document.getElementById('modalAutoShowLog').checked = savedAutoShowLog;
            document.getElementById('modalClipboardBridge').checked = savedClipboardBridge;
        }

        function updateMouseSpeedFromModal(value) {
            const val = parseFloat(value);
            localStorage.setItem('mouseSensitivity', val);
            document.getElementById('modalMouseSpeedVal').textContent = val.toFixed(1) + 'x';
            // Update global variable and panel slider if they exist
            if (typeof mouseSensitivity !== 'undefined') mouseSensitivity = val;
            const panelSlider = document.getElementById('mouseSpeed');
            const panelVal = document.getElementById('mouseSpeedVal');
            if (panelSlider) panelSlider.value = val;
            if (panelVal) panelVal.textContent = val.toFixed(1) + 'x';
        }

        function updateScrollSpeedFromModal(value) {
            const val = parseInt(value);
            localStorage.setItem('scrollSensitivity', val);
            document.getElementById('modalScrollSpeedVal').textContent = val;
            // Update global variable and panel slider if they exist
            if (typeof scrollSensitivity !== 'undefined') scrollSensitivity = val;
            const panelSlider = document.getElementById('scrollSpeed');
            const panelVal = document.getElementById('scrollSpeedVal');
            if (panelSlider) panelSlider.value = val;
            if (panelVal) panelVal.textContent = val;
        }

        function updateExitKeyFromModal(value) {
            localStorage.setItem('exitKey', value);
            // Update global variable if it exists
            if (typeof exitKey !== 'undefined') exitKey = value;
            const keyNames = { 'Escape': 'ESC', 'F12': 'F12', 'ScrollLock': 'ScrLk', 'Pause': 'Pause' };
            const displayName = keyNames[value] || value;
            // Update all hints
            const hint = document.getElementById('exitKeyHint');
            const display = document.getElementById('exitKeyDisplay');
            if (hint) hint.textContent = displayName;
            if (display) display.textContent = displayName;
            // Also update panel select if it exists
            const panelSelect = document.getElementById('exitKeySelect');
            if (panelSelect) panelSelect.value = value;
        }

        function updateCapsLockModeFromModal(checked) {
            localStorage.setItem('capsLockCmdMode', checked);
            // Update global variable if it exists
            if (typeof capsLockCmdMode !== 'undefined') capsLockCmdMode = checked;
            // Also update panel checkbox if it exists
            const panelCheckbox = document.getElementById('capsLockMode');
            if (panelCheckbox) panelCheckbox.checked = checked;
            log('CapsLock commands: ' + (checked ? 'ON' : 'OFF'), 'info');
        }

        function updateAutoShowLogFromModal(checked) {
            localStorage.setItem('autoShowLogNoVideo', checked);
            autoShowLogNoVideo = checked;
            log('Auto-show log (no video): ' + (checked ? 'ON' : 'OFF'), 'info');
        }

        function updateClipboardBridgeFromModal(checked) {
            localStorage.setItem('clipboardBridgeEnabled', checked);
            clipboardBridgeEnabled = checked;
            log('Clipboard bridge: ' + (checked ? 'ON' : 'OFF'), 'info');
        }

        function updateEdgeReleaseFromModal(checked) {
            localStorage.setItem('edgeRelease', checked);
            edgeRelease = checked;
            log('Edge release (jack-in): ' + (checked ? 'ON' : 'OFF'), 'info');
        }

        function updateKeyboardLockFromModal(checked) {
            localStorage.setItem('keyboardLockEnabled', checked);
            keyboardLockEnabled = checked;
            log('Keyboard lock (fullscreen): ' + (checked ? 'ON' : 'OFF'), 'info');
            // If disabling while locked, unlock immediately
            if (!checked && keyboardLocked) {
                releaseKeyboardLock();
            }
            // If enabling while already fullscreen and capturing, lock now
            if (checked && document.fullscreenElement && isCapturing) {
                requestKeyboardLock();
            }
        }

        function updateFullscreenOnJackInFromModal(checked) {
            localStorage.setItem('fullscreenOnJackIn', checked);
            fullscreenOnJackIn = checked;
            log('Fullscreen on jack-in: ' + (checked ? 'ON' : 'OFF'), 'info');
        }

        // Screen Manager
        let screenManagerData = JSON.parse(localStorage.getItem('screenManager') || '{"screens":{},"globalSettings":{"autoPortalOnConnect":false}}');
        let currentScreenDetails = null;
        let selectedScreenIndex = -1;

        function hasScreenManagementAPI() {
            return 'getScreenDetails' in window && typeof window.getScreenDetails === 'function';
        }

        async function openScreenManager() {
            const modal = document.getElementById('screenManagerModal');
            modal.classList.add('active');

            if (!hasScreenManagementAPI()) {
                renderScreenManagerUnavailable();
                return;
            }

            try {
                currentScreenDetails = await window.getScreenDetails();
                selectedScreenIndex = -1;
                renderScreenManager();

                // Listen for screen changes
                currentScreenDetails.addEventListener('screenschange', () => {
                    renderScreenManager();
                });
            } catch (err) {
                if (err.name === 'NotAllowedError') {
                    renderScreenManagerPermissionDenied();
                } else {
                    renderScreenManagerError(err.message);
                }
            }
        }

        function closeScreenManager(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('screenManagerModal').classList.remove('active');
            currentScreenDetails = null;
        }

        function renderScreenManagerUnavailable() {
            document.getElementById('screenManagerContent').innerHTML = `
                <div class="screen-unavailable">
                    <div class="screen-unavailable-icon">üñ•Ô∏è</div>
                    <div style="margin-bottom: 8px; color: var(--text-normal);">Screen Management API not available</div>
                    <div>This feature requires Chrome or Edge browser.</div>
                    <div style="margin-top: 12px;">You can still use the portal manually with the edge selector.</div>
                </div>
            `;
        }

        function renderScreenManagerPermissionDenied() {
            document.getElementById('screenManagerContent').innerHTML = `
                <div class="screen-unavailable">
                    <div class="screen-unavailable-icon">üîí</div>
                    <div style="margin-bottom: 8px; color: var(--text-normal);">Permission Required</div>
                    <div>Allow window management permission to configure screens.</div>
                    <button class="btn-secondary" onclick="openScreenManager()" style="margin-top: 12px;">Try Again</button>
                </div>
            `;
        }

        function renderScreenManagerError(message) {
            document.getElementById('screenManagerContent').innerHTML = `
                <div class="screen-unavailable">
                    <div class="screen-unavailable-icon">‚ö†Ô∏è</div>
                    <div style="margin-bottom: 8px; color: var(--text-normal);">Error</div>
                    <div>${message}</div>
                    <button class="btn-secondary" onclick="openScreenManager()" style="margin-top: 12px;">Try Again</button>
                </div>
            `;
        }

        function renderScreenManager() {
            if (!currentScreenDetails) return;

            const screens = currentScreenDetails.screens;
            const currentScreen = currentScreenDetails.currentScreen;

            // Calculate bounds for scaling
            let minLeft = Infinity, minTop = Infinity, maxRight = -Infinity, maxBottom = -Infinity;
            screens.forEach(s => {
                minLeft = Math.min(minLeft, s.left);
                minTop = Math.min(minTop, s.top);
                maxRight = Math.max(maxRight, s.left + s.width);
                maxBottom = Math.max(maxBottom, s.top + s.height);
            });

            const totalWidth = maxRight - minLeft;
            const totalHeight = maxBottom - minTop;
            const mapWidth = 500;
            const scale = Math.min(mapWidth / totalWidth, 130 / totalHeight);
            const mapHeight = totalHeight * scale;

            // Build screen boxes
            let screenBoxesHtml = '';
            screens.forEach((screen, index) => {
                const config = getScreenConfig(screen);
                const isSelected = index === selectedScreenIndex;
                const isCurrent = screen === currentScreen;

                const left = (screen.left - minLeft) * scale;
                const top = (screen.top - minTop) * scale;
                const width = screen.width * scale;
                const height = screen.height * scale;

                let roleClass = '';
                let roleLabel = '';
                if (config.role === 'controller') {
                    roleClass = 'role-controller';
                    roleLabel = '<span class="screen-role controller">Ctrl</span>';
                } else if (config.role === 'portal') {
                    roleClass = 'role-portal';
                    roleLabel = '<span class="screen-role portal">Portal</span>';
                }

                screenBoxesHtml += `
                    <div class="screen-box ${roleClass} ${isSelected ? 'selected' : ''} ${isCurrent ? 'current' : ''}"
                         style="left: ${left}px; top: ${top}px; width: ${width}px; height: ${height}px;"
                         onclick="selectScreen(${index})"
                         title="${screen.label}">
                        <span class="screen-label">${config.alias || screen.label || 'Screen ' + (index + 1)}</span>
                        <span class="screen-size">${screen.width}√ó${screen.height}</span>
                        ${roleLabel}
                    </div>
                `;
            });

            // Build config panel
            let configHtml = '';
            if (selectedScreenIndex >= 0 && selectedScreenIndex < screens.length) {
                const screen = screens[selectedScreenIndex];
                const config = getScreenConfig(screen);

                configHtml = `
                    <div class="screen-config">
                        <div class="screen-config-title">
                            ${screen.label || 'Screen ' + (selectedScreenIndex + 1)}
                            <span class="screen-badge">${screen.width}√ó${screen.height}</span>
                            ${screen.isPrimary ? '<span class="screen-badge">Primary</span>' : ''}
                        </div>
                        <div class="screen-config-row">
                            <span class="screen-config-label">Alias</span>
                            <input type="text" class="text-input screen-config-input"
                                   value="${config.alias || ''}"
                                   placeholder="${screen.label || 'Screen name'}"
                                   onchange="updateScreenAlias(${selectedScreenIndex}, this.value)"
                                   style="font-size: 10px; padding: 4px 8px;">
                        </div>
                        <div class="screen-config-row">
                            <span class="screen-config-label">Role</span>
                            <div class="role-selector">
                                <button class="role-btn ${config.role === 'controller' ? 'active controller' : ''}"
                                        onclick="setScreenRole(${selectedScreenIndex}, 'controller')">Controller</button>
                                <button class="role-btn ${config.role === 'portal' ? 'active' : ''}"
                                        onclick="setScreenRole(${selectedScreenIndex}, 'portal')">Portal</button>
                                <button class="role-btn ${!config.role || config.role === 'none' ? 'active' : ''}"
                                        onclick="setScreenRole(${selectedScreenIndex}, 'none')">None</button>
                            </div>
                        </div>
                        ${config.role === 'portal' ? `
                        <div class="screen-config-row">
                            <span class="screen-config-label">Options</span>
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--text-normal); cursor: pointer;">
                                <input type="checkbox" ${config.autoFullscreen ? 'checked' : ''}
                                       onchange="updateScreenOption(${selectedScreenIndex}, 'autoFullscreen', this.checked)">
                                Auto-fullscreen portal
                            </label>
                        </div>
                        <div class="screen-config-row">
                            <span class="screen-config-label"></span>
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--text-normal); cursor: pointer;">
                                <input type="checkbox" ${config.isVirtual ? 'checked' : ''}
                                       onchange="updateScreenOption(${selectedScreenIndex}, 'isVirtual', this.checked)">
                                Mark as virtual/dummy
                            </label>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else {
                configHtml = `
                    <div class="screen-config" style="text-align: center; padding: 20px;">
                        <div style="color: var(--text-dim); font-size: 10px;">Click a screen above to configure</div>
                    </div>
                `;
            }

            // Global settings
            const globalHtml = `
                <div class="settings-section" style="margin-top: 8px;">
                    <div class="settings-section-title">Portal Settings</div>
                    <div class="screen-config-row">
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--text-normal); cursor: pointer;">
                            <input type="checkbox" ${screenManagerData.globalSettings.autoPortalOnConnect ? 'checked' : ''}
                                   onchange="updateGlobalScreenSetting('autoPortalOnConnect', this.checked)">
                            Auto-open portal on device connect
                        </label>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="btn-secondary" onclick="refreshScreens()" style="flex: 1;">Refresh</button>
                    <button class="btn-secondary" onclick="closeScreenManager()" style="flex: 1; background: var(--accent-primary); border-color: var(--accent-primary); color: #fff;">Done</button>
                </div>
            `;

            document.getElementById('screenManagerContent').innerHTML = `
                <div class="screen-map">
                    <div class="screen-map-inner" style="width: ${totalWidth * scale}px; height: ${mapHeight}px;">
                        ${screenBoxesHtml}
                    </div>
                </div>
                ${configHtml}
                ${globalHtml}
            `;
        }

        function getScreenConfig(screen) {
            // Try to match by label first, then by position
            const byLabel = Object.values(screenManagerData.screens).find(s => s.label === screen.label);
            if (byLabel) return byLabel;

            // Position match (within tolerance)
            const tolerance = 100;
            const byPosition = Object.values(screenManagerData.screens).find(s =>
                Math.abs(s.position.left - screen.left) < tolerance &&
                Math.abs(s.position.top - screen.top) < tolerance
            );
            if (byPosition) return byPosition;

            return { role: 'none' };
        }

        function getScreenId(screen) {
            return `screen-${screen.label || ''}-${screen.left}-${screen.top}`.replace(/\s+/g, '_');
        }

        function selectScreen(index) {
            selectedScreenIndex = index;
            renderScreenManager();
        }

        function setScreenRole(index, role) {
            if (!currentScreenDetails) return;
            const screen = currentScreenDetails.screens[index];
            const id = getScreenId(screen);

            // Clear role from other screens if setting controller or portal
            if (role === 'controller' || role === 'portal') {
                Object.keys(screenManagerData.screens).forEach(key => {
                    if (screenManagerData.screens[key].role === role) {
                        screenManagerData.screens[key].role = 'none';
                    }
                });
            }

            // Set or create config
            if (!screenManagerData.screens[id]) {
                screenManagerData.screens[id] = {
                    label: screen.label,
                    position: { left: screen.left, top: screen.top },
                    size: { width: screen.width, height: screen.height }
                };
            }
            screenManagerData.screens[id].role = role;

            saveScreenManagerData();
            renderScreenManager();
            updateSeamlessEdgeFromScreens();
        }

        function updateScreenAlias(index, alias) {
            if (!currentScreenDetails) return;
            const screen = currentScreenDetails.screens[index];
            const id = getScreenId(screen);

            if (!screenManagerData.screens[id]) {
                screenManagerData.screens[id] = {
                    label: screen.label,
                    position: { left: screen.left, top: screen.top },
                    size: { width: screen.width, height: screen.height },
                    role: 'none'
                };
            }
            screenManagerData.screens[id].alias = alias;

            saveScreenManagerData();
            renderScreenManager();
        }

        function updateScreenOption(index, option, value) {
            if (!currentScreenDetails) return;
            const screen = currentScreenDetails.screens[index];
            const id = getScreenId(screen);

            if (screenManagerData.screens[id]) {
                screenManagerData.screens[id][option] = value;
                saveScreenManagerData();
            }
        }

        function updateGlobalScreenSetting(key, value) {
            screenManagerData.globalSettings[key] = value;
            saveScreenManagerData();
        }

        function saveScreenManagerData() {
            localStorage.setItem('screenManager', JSON.stringify(screenManagerData));
        }

        function refreshScreens() {
            openScreenManager();
        }

        function updateSeamlessEdgeFromScreens() {
            // Find controller and portal screens
            const controllerConfig = Object.values(screenManagerData.screens).find(s => s.role === 'controller');
            const portalConfig = Object.values(screenManagerData.screens).find(s => s.role === 'portal');

            if (!controllerConfig || !portalConfig) return;

            // Calculate edge based on positions
            const controllerRight = controllerConfig.position.left + controllerConfig.size.width;
            const portalRight = portalConfig.position.left + portalConfig.size.width;

            if (portalConfig.position.left >= controllerRight - 100) {
                // Portal is to the right
                setSeamlessEdge('right');
            } else if (portalRight <= controllerConfig.position.left + 100) {
                // Portal is to the left
                setSeamlessEdge('left');
            }
        }

        function getPortalScreen() {
            // Returns the configured portal screen from current screens, or null
            if (!currentScreenDetails) return null;

            const portalConfig = Object.values(screenManagerData.screens).find(s => s.role === 'portal');
            if (!portalConfig) return null;

            // Find matching screen
            return currentScreenDetails.screens.find(screen => {
                if (portalConfig.label && screen.label === portalConfig.label) return true;
                const tolerance = 100;
                return Math.abs(portalConfig.position.left - screen.left) < tolerance &&
                       Math.abs(portalConfig.position.top - screen.top) < tolerance;
            });
        }

        // Screen Wake Lock
        let wakeLock = null;
        let wakeLockEnabled = localStorage.getItem('wakeLockEnabled') === 'true'; // default false

        // Initialize wake lock toggle
        document.getElementById('wakeLockToggle').checked = wakeLockEnabled;

        function updateWakeLockSetting(checked) {
            localStorage.setItem('wakeLockEnabled', checked);
            wakeLockEnabled = checked;
            log('Wake Lock: ' + (checked ? 'ON' : 'OFF'), 'info');
            // If disabling and we have a lock, release it
            if (!checked && wakeLock) {
                releaseWakeLock();
            }
        }

        async function requestWakeLock() {
            if (!wakeLockEnabled || !('wakeLock' in navigator)) return;
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.addEventListener('release', () => {
                    wakeLock = null;
                });
                log('Wake lock acquired', 'info');
            } catch (err) {
                // Wake lock request failed (e.g., low battery, permission denied)
                log('Wake lock failed: ' + err.message, 'warn');
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                log('Wake lock released', 'info');
            }
        }

        // Re-acquire wake lock when page becomes visible again
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && wakeLockEnabled && document.pointerLockElement) {
                // We're visible and still in capture mode - re-acquire
                await requestWakeLock();
            }
        });

        function clearLocalStorage() {
            if (confirm('Clear all saved data? This will reset theme, device preferences, macros, and scripts.')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Export all settings to JSON file
        function exportSettings() {
            const settings = {};

            // Collect all localStorage items with our prefix
            const keys = [
                'relaykvm-theme',
                'relaykvm-lastDevice',
                'relaykvm-videoRes',
                'relaykvm-videoFps',
                'relaykvm-exitKey',
                'relaykvm-capsLockMode',
                'mouseSensitivity',
                'scrollSensitivity',
                'autoShowLogNoVideo',
                'capsLockCmdMode',
                'keyboardLockEnabled',
                'fullscreenOnJackIn',
                'edgeRelease',
                'clipboardBridgeEnabled',
                'wakeLockEnabled',
                'exitKey',
                'macros',
                'scripts',
                'customTheme1',
                'customTheme2',
                'customTheme3',
                'customTheme4',
                'customTheme5',
                'screenManager'
            ];

            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value !== null) {
                    settings[key] = value;
                }
            });

            // Create and download the file
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relaykvm-settings-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log('Settings exported', 'info');
        }

        // Import settings from JSON file
        function importSettings(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const settings = JSON.parse(e.target.result);

                    if (confirm(`Import ${Object.keys(settings).length} settings? This will overwrite current settings.`)) {
                        Object.entries(settings).forEach(([key, value]) => {
                            localStorage.setItem(key, value);
                        });

                        log('Settings imported, reloading...', 'info');
                        setTimeout(() => location.reload(), 500);
                    }
                } catch (err) {
                    alert('Invalid settings file: ' + err.message);
                }
            };
            reader.readAsText(file);

            // Reset input so same file can be selected again
            input.value = '';
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('settingsModal').classList.contains('active')) {
                closeSettingsModal();
            }
        });

        // Restore saved theme
        (function() {
            const savedTheme = localStorage.getItem('relaykvm-theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                // Update theme buttons after DOM loads
                document.addEventListener('DOMContentLoaded', () => {
                    updateThemeButtons(savedTheme);
                    // If it's a custom theme, re-apply it to inject the CSS
                    if (savedTheme.startsWith('custom-')) {
                        const slot = parseInt(savedTheme.replace('custom-', ''));
                        if (customThemes[slot]) {
                            applyCustomTheme(slot);
                        }
                    }
                    // Update PWA title bar color to match theme
                    updatePwaThemeColor();
                });
            }
        })();

        // Check browser support
        if (!RelayKVMAdapter.isSupported()) {
            document.getElementById('browserWarning').style.display = 'block';
        }

        // Handle PWA shortcut URL hashes
        function handleUrlHash() {
            const hash = window.location.hash.slice(1);
            if (!hash) return;

            // Clear hash so it doesn't retrigger
            history.replaceState(null, '', window.location.pathname);

            switch (hash) {
                case 'connect':
                    if (!kvm.connected) connect();
                    break;
                case 'jackin':
                    if (kvm.connected && !isCapturing) startCapture();
                    break;
                case 'portal':
                    if (kvm.connected) openSeamlessWindow();
                    break;
                case 'jiggler':
                    toggleJiggler();
                    break;
                case 'pendant':
                case 'dip':
                    togglePendant();
                    break;
            }
        }
        // Handle on load and hash changes
        window.addEventListener('hashchange', handleUrlHash);
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(handleUrlHash, 500); // Delay to ensure everything is initialized
        });

        // Sensitivity settings
        let mouseSensitivity = parseFloat(localStorage.getItem('mouseSensitivity')) || 2;
        let scrollSensitivity = parseInt(localStorage.getItem('scrollSensitivity')) || 3;

        const mouseSpeedSlider = document.getElementById('mouseSpeed');
        const mouseSpeedVal = document.getElementById('mouseSpeedVal');
        const scrollSpeedSlider = document.getElementById('scrollSpeed');
        const scrollSpeedVal = document.getElementById('scrollSpeedVal');

        // Initialize slider values
        mouseSpeedSlider.value = mouseSensitivity;
        mouseSpeedVal.textContent = mouseSensitivity.toFixed(1) + 'x';
        scrollSpeedSlider.value = scrollSensitivity;
        scrollSpeedVal.textContent = scrollSensitivity;

        mouseSpeedSlider.addEventListener('input', () => {
            mouseSensitivity = parseFloat(mouseSpeedSlider.value);
            mouseSpeedVal.textContent = mouseSensitivity.toFixed(1) + 'x';
            localStorage.setItem('mouseSensitivity', mouseSensitivity);
        });

        scrollSpeedSlider.addEventListener('input', () => {
            scrollSensitivity = parseInt(scrollSpeedSlider.value);
            scrollSpeedVal.textContent = scrollSensitivity;
            localStorage.setItem('scrollSensitivity', scrollSensitivity);
        });

        // Initialize adapter
        kvm = new RelayKVMAdapter();

        kvm.onConnectionChange = (connected) => {
            updateUI(connected);
            log(connected ? 'Link established' : 'Link down', 'info');
        };

        kvm.onDataReceived = (data) => {
            flashLed('ledRx');

            // Check for jack out command from device (G key)
            // Format: [0x57, 0xAB, 0x00, 0x80, 0x00, 0x00]
            if (data.length >= 4 && data[0] === 0x57 && data[1] === 0xAB && data[3] === 0x80) {
                log('Device: Jack out (G)', 'info');
                if (isCapturing) {
                    stopCapture();
                }
                return;
            }

            log('RX: ' + data.length + ' bytes', 'receive');
        };

        // LED flash helper
        function flashLed(id) {
            const led = document.getElementById(id);
            led.classList.add('on');
            clearTimeout(id === 'ledTx' ? txTimeout : rxTimeout);

            // TX stays on longer (jiggler interval * 1.5), RX quick flash
            const duration = id === 'ledTx' ? Math.round(jigglerInterval * 1.5) : 100;
            const timeout = setTimeout(() => led.classList.remove('on'), duration);

            if (id === 'ledTx') txTimeout = timeout;
            else rxTimeout = timeout;

            // Also update pendant LEDs (DIP and docked)
            if (dipWindow && !dipWindow.closed) {
                const dipId = id === 'ledTx' ? 'dipLedTx' : 'dipLedRx';
                const dipLed = dipWindow.document.getElementById(dipId);
                if (dipLed) {
                    dipLed.classList.add('on');
                    setTimeout(() => dipLed.classList.remove('on'), duration);
                }
            }

            // Docked pendant LEDs
            const dpId = id === 'ledTx' ? 'dpLedTx' : 'dpLedRx';
            const dpLed = document.getElementById(dpId);
            if (dpLed) {
                dpLed.classList.add('on');
                setTimeout(() => dpLed.classList.remove('on'), duration);
            }
        }

        // UI Updates
        function updateUI(connected) {
            const btn = document.getElementById('connectBtn');
            const ledLink = document.getElementById('ledLink');
            const sendTextBtn = document.getElementById('sendTextBtn');
            const captureBtn = document.getElementById('captureBtn');

            if (connected) {
                btn.textContent = 'Disconnect';
                btn.classList.remove('primary');
                btn.classList.add('danger');
                ledLink.classList.add('on');
                sendTextBtn.disabled = false;
                captureBtn.disabled = false;
            } else {
                btn.textContent = knownDevice ? 'Quick Connect' : 'Connect';
                btn.classList.remove('danger');
                btn.classList.add('primary');
                ledLink.classList.remove('on');
                sendTextBtn.disabled = true;
                captureBtn.disabled = true;
                if (isCapturing) stopCapture();
                if (jigglerActive) toggleJiggler(); // Stop jiggler on disconnect
            }
            btn.disabled = false;
        }

        async function toggleConnection() {
            const btn = document.getElementById('connectBtn');

            if (kvm.connected) {
                kvm.disconnect();
            } else {
                btn.disabled = true;
                btn.textContent = 'Connecting...';
                try {
                    if (knownDevice) {
                        // Quick reconnect to known device (no picker)
                        log('Quick connecting to ' + knownDevice.name + '...', 'info');
                        await kvm.reconnect(knownDevice);
                    } else {
                        // Show picker for new device
                        await kvm.connect();
                        // After successful connection, check for known devices again
                        checkKnownDevices();
                    }
                } catch (error) {
                    log('Error: ' + error.message, 'error');
                    updateUI(false);
                    // If quick connect failed, clear known device and try fresh
                    if (knownDevice) {
                        log('Quick connect failed, try regular Connect', 'info');
                        knownDevice = null;
                        btn.textContent = 'Connect';
                        btn.title = '';
                    }
                }
            }
        }

        // Keyboard
        async function sendText() {
            const input = document.getElementById('textInput');
            const text = input.value;
            if (text && kvm.connected) {
                flashLed('ledTx');
                log('TX: "' + text + '"', 'send');
                await kvm.typeText(text);
                input.value = '';
            }
        }

        async function sendKey(key) {
            if (kvm.connected) {
                flashLed('ledTx');
                log('TX: ' + key.toUpperCase(), 'send');
                await kvm.sendKey(key);
            }
        }

        async function sendCombo(keys) {
            if (kvm.connected) {
                flashLed('ledTx');
                log('TX: ' + keys.join('+').toUpperCase(), 'send');
                await kvm.sendKeyCombo(keys);
            }
        }

        // Media key codes (USB HID Consumer Control)
        const MEDIA_KEYS = {
            volumeUp: 0xE9,
            volumeDown: 0xEA,
            mute: 0xE2,
            playPause: 0xCD,
            nextTrack: 0xB5,
            prevTrack: 0xB6,
            stop: 0xB7
        };

        async function sendMediaKey(keyName) {
            if (kvm.connected) {
                const code = MEDIA_KEYS[keyName];
                if (code) {
                    flashLed('ledTx');
                    log('TX: MEDIA ' + keyName.toUpperCase(), 'send');
                    await kvm.sendMediaKey(code);
                }
            }
        }

        // Fn Layer - shifts F1-F12 to F13-F24
        let fnLayerActive = false;

        function toggleFnLayer() {
            fnLayerActive = !fnLayerActive;
            const btn = document.getElementById('fnLayerBtn');
            btn.classList.toggle('amber', !fnLayerActive);
            btn.classList.toggle('green', fnLayerActive);

            // Update F-key labels
            document.querySelectorAll('.fkey').forEach(el => {
                const base = parseInt(el.dataset.base);
                const num = fnLayerActive ? base + 12 : base;
                el.textContent = 'F' + num;
            });
        }

        function sendFKey(base) {
            const num = fnLayerActive ? base + 12 : base;
            sendKey('f' + num);
        }

        document.getElementById('textInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendText();
        });

        // Mouse trackpad - drag to move, click to click
        const trackpad = document.getElementById('trackpad');
        const mouseCoords = document.getElementById('mouseCoords');
        let totalX = 0, totalY = 0;
        let trackpadLocked = false;
        let trackpadMoved = 0; // Track total movement to distinguish click vs drag
        let trackpadButton = 0; // Which button was pressed

        trackpad.addEventListener('mousedown', (e) => {
            e.preventDefault();

            // Request pointer lock for unlimited movement (even if disconnected for discoverability)
            if (!trackpadLocked) {
                trackpad.requestPointerLock();
            }

            // Remember which button, but don't send it yet
            const btnMap = { 0: 1, 1: 4, 2: 2 };
            trackpadButton = btnMap[e.button] || 1;
            trackpadMoved = 0;

            isDragging = true;
            lastX = e.clientX;
            lastY = e.clientY;
        });

        trackpad.addEventListener('mousemove', (e) => {
            if (!kvm.connected || !isDragging) return;

            let dx, dy;
            if (trackpadLocked) {
                dx = e.movementX;
                dy = e.movementY;
            } else {
                dx = e.clientX - lastX;
                dy = e.clientY - lastY;
                lastX = e.clientX;
                lastY = e.clientY;
            }

            if (dx !== 0 || dy !== 0) {
                // Just move, no buttons - apply sensitivity
                kvm.moveMouse(Math.round(dx * mouseSensitivity), Math.round(dy * mouseSensitivity));
                flashLed('ledTx');
                trackpadMoved += Math.abs(dx) + Math.abs(dy);
                totalX += dx; totalY += dy;
                mouseCoords.textContent = totalX + ', ' + totalY;
                mouseCoords.classList.remove('dim');
            }
        });

        trackpad.addEventListener('mouseup', (e) => {
            // If barely moved and connected, treat as a click
            if (trackpadMoved < 5 && kvm.connected) {
                const btnName = { 1: 'left', 2: 'right', 4: 'middle' };
                kvm.click(btnName[trackpadButton] || 'left');
                flashLed('ledTx');
                log('TX: Click ' + (btnName[trackpadButton] || 'left'), 'send');
            }

            // Exit pointer lock (even if disconnected)
            if (trackpadLocked) {
                document.exitPointerLock();
            }
            isDragging = false;
            trackpadButton = 0;
        });

        trackpad.addEventListener('contextmenu', (e) => e.preventDefault());

        // Scroll wheel on trackpad
        trackpad.addEventListener('wheel', (e) => {
            if (!kvm.connected) return;
            e.preventDefault();
            const scroll = e.deltaY > 0 ? -scrollSensitivity : scrollSensitivity;
            kvm.scroll(scroll);
            flashLed('ledTx');
        }, { passive: false });

        // Handle pointer lock changes for trackpad
        document.addEventListener('pointerlockchange', () => {
            if (document.pointerLockElement === trackpad) {
                trackpadLocked = true;
                trackpad.style.cursor = 'none';
            } else if (document.pointerLockElement !== overlay) {
                trackpadLocked = false;
                trackpad.style.cursor = 'crosshair';
                isDragging = false;
            }
        });

        // Touch support - tap to click, drag to move
        let touchMoved = 0;

        trackpad.addEventListener('touchstart', (e) => {
            if (!kvm.connected) return;
            e.preventDefault();
            isDragging = true;
            touchMoved = 0;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
        });

        trackpad.addEventListener('touchmove', (e) => {
            if (!isDragging || !kvm.connected) return;
            e.preventDefault();
            const dx = e.touches[0].clientX - lastX;
            const dy = e.touches[0].clientY - lastY;
            if (dx !== 0 || dy !== 0) {
                kvm.moveMouse(Math.round(dx * mouseSensitivity), Math.round(dy * mouseSensitivity));
                flashLed('ledTx');
                touchMoved += Math.abs(dx) + Math.abs(dy);
                lastX = e.touches[0].clientX;
                lastY = e.touches[0].clientY;
            }
        });

        trackpad.addEventListener('touchend', () => {
            if (!kvm.connected) return;
            // Tap = click
            if (touchMoved < 5) {
                kvm.click('left');
                flashLed('ledTx');
            }
            isDragging = false;
        });

        async function mouseClick(button) {
            if (kvm.connected) {
                flashLed('ledTx');
                log('TX: Click ' + button, 'send');
                await kvm.click(button);
            }
        }

        async function mouseScroll(amount) {
            if (kvm.connected) {
                flashLed('ledTx');
                await kvm.scroll(amount);
            }
        }

        // Drag-to-trackpad functionality for L/M/R buttons
        const trackpadCenter = document.getElementById('trackpadCenter');
        let dragToTrackpad = {
            active: false,
            button: null,
            dragging: false
        };

        ['mouseBtnL', 'mouseBtnM', 'mouseBtnR'].forEach(id => {
            const btn = document.getElementById(id);
            const buttonName = btn.dataset.button;

            // Mouse events
            btn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startDragToTrackpad(buttonName, e.clientX, e.clientY);
            });

            // Touch events
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                startDragToTrackpad(buttonName, touch.clientX, touch.clientY);
            });
        });

        function startDragToTrackpad(button, x, y) {
            if (!kvm.connected) {
                mouseClick(button); // Just click if not connected
                return;
            }
            dragToTrackpad.active = true;
            dragToTrackpad.button = button;
            dragToTrackpad.dragging = false;
            dragToTrackpad.startX = x;
            dragToTrackpad.startY = y;
            dragToTrackpad.moved = 0;
        }

        function isOverTrackpadCenter(x, y) {
            const rect = trackpadCenter.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const radius = 20; // Detection radius
            const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
            return dist < radius;
        }

        function isOverTrackpad(x, y) {
            const rect = trackpad.getBoundingClientRect();
            return x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
        }

        // Global mouse/touch move for drag detection
        document.addEventListener('mousemove', (e) => {
            if (!dragToTrackpad.active) return;

            dragToTrackpad.moved += Math.abs(e.clientX - dragToTrackpad.startX) + Math.abs(e.clientY - dragToTrackpad.startY);
            dragToTrackpad.startX = e.clientX;
            dragToTrackpad.startY = e.clientY;

            if (!dragToTrackpad.dragging) {
                // Check if over center to activate drag mode
                if (isOverTrackpadCenter(e.clientX, e.clientY)) {
                    activateDragMode();
                } else if (isOverTrackpad(e.clientX, e.clientY)) {
                    // Show ready state when over trackpad but not center
                    trackpadCenter.classList.add('drag-ready');
                } else {
                    trackpadCenter.classList.remove('drag-ready');
                }
            } else {
                // Already dragging - move mouse
                const dx = e.movementX * mouseSensitivity;
                const dy = e.movementY * mouseSensitivity;
                if (dx !== 0 || dy !== 0) {
                    kvm.moveMouse(Math.round(dx), Math.round(dy));
                    totalX += dx; totalY += dy;
                    mouseCoords.textContent = Math.round(totalX) + ', ' + Math.round(totalY);
                    mouseCoords.classList.remove('dim');
                    flashLed('ledTx');
                }
            }
        });

        document.addEventListener('touchmove', (e) => {
            if (!dragToTrackpad.active) return;

            const touch = e.touches[0];
            const dx = touch.clientX - dragToTrackpad.startX;
            const dy = touch.clientY - dragToTrackpad.startY;
            dragToTrackpad.moved += Math.abs(dx) + Math.abs(dy);

            if (!dragToTrackpad.dragging) {
                if (isOverTrackpadCenter(touch.clientX, touch.clientY)) {
                    activateDragMode();
                    dragToTrackpad.startX = touch.clientX;
                    dragToTrackpad.startY = touch.clientY;
                } else if (isOverTrackpad(touch.clientX, touch.clientY)) {
                    trackpadCenter.classList.add('drag-ready');
                } else {
                    trackpadCenter.classList.remove('drag-ready');
                }
            } else {
                // Move mouse during drag
                const moveDx = dx * mouseSensitivity;
                const moveDy = dy * mouseSensitivity;
                if (moveDx !== 0 || moveDy !== 0) {
                    kvm.moveMouse(Math.round(moveDx), Math.round(moveDy));
                    totalX += moveDx; totalY += moveDy;
                    mouseCoords.textContent = Math.round(totalX) + ', ' + Math.round(totalY);
                    mouseCoords.classList.remove('dim');
                    flashLed('ledTx');
                }
                dragToTrackpad.startX = touch.clientX;
                dragToTrackpad.startY = touch.clientY;
            }
        }, { passive: false });

        function activateDragMode() {
            dragToTrackpad.dragging = true;
            trackpadCenter.classList.remove('drag-ready');
            trackpadCenter.classList.add('drag-active', dragToTrackpad.button);

            // Send mouse button down
            const btnCode = { left: 1, middle: 4, right: 2 }[dragToTrackpad.button];
            kvm.mouseDown(btnCode);
            log('TX: Drag ' + dragToTrackpad.button, 'send');
            flashLed('ledTx');

            // Request pointer lock for smooth dragging
            trackpad.requestPointerLock();
        }

        function endDragToTrackpad() {
            if (!dragToTrackpad.active) return;

            if (dragToTrackpad.dragging) {
                // Release mouse button
                const btnCode = { left: 1, middle: 4, right: 2 }[dragToTrackpad.button];
                kvm.mouseUp(btnCode);
                log('TX: Drop ' + dragToTrackpad.button, 'send');
                flashLed('ledTx');

                // Exit pointer lock
                if (document.pointerLockElement === trackpad) {
                    document.exitPointerLock();
                }
            } else if (dragToTrackpad.moved < 10) {
                // Didn't drag far enough - treat as click
                mouseClick(dragToTrackpad.button);
            }

            // Reset state
            trackpadCenter.classList.remove('drag-ready', 'drag-active', 'left', 'middle', 'right');
            dragToTrackpad.active = false;
            dragToTrackpad.button = null;
            dragToTrackpad.dragging = false;
        }

        document.addEventListener('mouseup', endDragToTrackpad);
        document.addEventListener('touchend', endDragToTrackpad);
        document.addEventListener('touchcancel', endDragToTrackpad);

        // Capture Mode
        let isCapturing = false;
        let captureStats = { mouse: 0, clicks: 0, keys: 0 };
        const overlay = document.getElementById('captureOverlay');

        // Seamless Mode - virtual cursor tracking for edge detection
        let seamlessMode = localStorage.getItem('seamlessMode') === 'true';
        let vCursorX = 0, vCursorY = 0;  // Virtual cursor position on target
        let targetWidth = 1920, targetHeight = 1080;  // Will be updated from video
        let seamlessEdge = localStorage.getItem('seamlessEdge') || 'right';  // Which edge releases to controller

        function toggleSeamlessMode() {
            seamlessMode = !seamlessMode;
            localStorage.setItem('seamlessMode', seamlessMode);
            updateSeamlessUI();
            log('Seamless mode: ' + (seamlessMode ? 'ON' : 'OFF'), 'info');
        }

        function setSeamlessEdge(edge) {
            seamlessEdge = edge;
            localStorage.setItem('seamlessEdge', edge);
            log('Seamless exit edge: ' + edge, 'info');
        }

        function updateSeamlessUI() {
            const btn = document.getElementById('seamlessBtn');
            if (btn) {
                btn.classList.toggle('green', seamlessMode);
            }
            const select = document.getElementById('seamlessEdgeSelect');
            if (select) {
                select.value = seamlessEdge;
            }
        }

        // Initialize seamless UI on load
        setTimeout(updateSeamlessUI, 0);

        // Expose variables for portal window access
        Object.defineProperties(window, {
            kvm: { get: () => kvm },
            seamlessMode: { get: () => seamlessMode },
            seamlessEdge: { get: () => seamlessEdge },
            targetWidth: { get: () => targetWidth },
            targetHeight: { get: () => targetHeight },
            mouseSensitivity: { get: () => mouseSensitivity },
            scrollSensitivity: { get: () => scrollSensitivity },
            edgeRelease: { get: () => edgeRelease },
            CODE_TO_KEY: { get: () => CODE_TO_KEY },
            RelayKVMAdapter: { get: () => RelayKVMAdapter }
        });

        // Seamless Portal Window
        let portalWindow = null;

        // Called by portal when jacked in/out (for PWA badge)
        window.setPortalJackedIn = function(jackedIn) {
            if (jackedIn) {
                if ('setAppBadge' in navigator) {
                    navigator.setAppBadge().catch(() => {});
                }
            } else {
                if ('clearAppBadge' in navigator) {
                    navigator.clearAppBadge().catch(() => {});
                }
            }
        };

        async function openSeamlessWindow() {
            // Close existing portal if open
            if (portalWindow && !portalWindow.closed) {
                portalWindow.focus();
                return;
            }

            // Try to get configured portal screen
            let portalScreen = null;
            let portalConfig = null;

            if (hasScreenManagementAPI()) {
                try {
                    // Get fresh screen details if we don't have them
                    if (!currentScreenDetails) {
                        currentScreenDetails = await window.getScreenDetails();
                    }
                    portalScreen = getPortalScreen();
                    if (portalScreen) {
                        // Get the config for this screen
                        portalConfig = Object.values(screenManagerData.screens).find(s => s.role === 'portal');
                    }
                } catch (e) {
                    // Permission denied or API failed, continue without positioning
                    console.log('Screen details not available:', e.message);
                }
            }

            // Calculate window size and position
            let windowFeatures = 'width=1200,height=700,menubar=no,toolbar=no,location=no,status=no';

            if (portalScreen) {
                // Position on portal screen, slightly inset from edges
                const w = Math.min(portalScreen.width - 40, 1200);
                const h = Math.min(portalScreen.height - 80, 700);
                const x = portalScreen.left + Math.round((portalScreen.width - w) / 2);
                const y = portalScreen.top + Math.round((portalScreen.height - h) / 2);
                windowFeatures = `width=${w},height=${h},left=${x},top=${y},menubar=no,toolbar=no,location=no,status=no`;
            }

            // Open portal.html in popup window
            portalWindow = window.open('portal.html', 'RelayKVM_Portal', windowFeatures);

            if (portalWindow) {
                if (portalScreen) {
                    log(`Portal opened on ${portalConfig?.alias || portalScreen.label || 'configured screen'}`, 'info');

                    // If auto-fullscreen is configured, request it after portal loads
                    if (portalConfig?.autoFullscreen) {
                        portalWindow.addEventListener('load', () => {
                            // Send message to portal to enter fullscreen
                            setTimeout(() => {
                                portalWindow.postMessage({ type: 'requestFullscreen' }, '*');
                            }, 100);
                        });
                    }
                } else {
                    log('Portal window opened - drag to dummy monitor', 'info');
                }
            } else {
                log('Popup blocked - allow popups for this site', 'error');
            }
        }

        function closePortal() {
            if (portalWindow && !portalWindow.closed) {
                portalWindow.close();
                portalWindow = null;
                log('Portal closed', 'info');
            }
        }

        // Alias for pendant/DIP buttons
        function openPortal() {
            openSeamlessWindow();
        }

        // Configurable exit key
        let exitKey = localStorage.getItem('exitKey') || 'Escape';
        updateExitKeyDisplay();

        function updateExitKeyDisplay() {
            const displayMap = {
                'Escape': 'ESC',
                'F12': 'F12',
                'F11': 'F11',
                'F10': 'F10',
                'ScrollLock': 'SCROLL LOCK',
                'Pause': 'PAUSE'
            };
            // Update both overlay and main hint
            const displayEl = document.getElementById('exitKeyDisplay');
            if (displayEl) displayEl.textContent = displayMap[exitKey] || exitKey;
            const hintEl = document.getElementById('exitKeyHint');
            if (hintEl) hintEl.textContent = displayMap[exitKey] || exitKey;
        }

        // CapsLock command mode
        let capsLockCmdMode = localStorage.getItem('capsLockCmdMode') === 'true';
        let clipboardBridgeEnabled = localStorage.getItem('clipboardBridgeEnabled') === 'true'; // default false
        let edgeRelease = localStorage.getItem('edgeRelease') !== 'false'; // default true

        // Keyboard Lock API - capture system keys in fullscreen
        let keyboardLockEnabled = localStorage.getItem('keyboardLockEnabled') !== 'false'; // default true
        let fullscreenOnJackIn = localStorage.getItem('fullscreenOnJackIn') === 'true'; // default false
        let keyboardLocked = false; // true when keyboard.lock() is active
        let capsLockHeld = false; // track CapsLock as modifier when locked
        const cmdModeBanner = document.getElementById('cmdModeBanner');
        const captureSubtitle = document.getElementById('captureSubtitle');

        // Command mode commands
        const CMD_MODE_COMMANDS = {
            'c': () => { toggleConnection(); return 'Connect/Disconnect'; },
            'j': () => { toggleJiggler(); return 'Toggle Jiggler'; },
            'q': () => { stopCapture(); return 'Jack Out'; },
            'r': () => { resetDevice(); return 'Reset Device'; },
            'w': () => { sendWake(); return 'Wake'; },
            's': () => { sendSleep(); return 'Sleep'; },
            'l': () => { sendCombo(['gui', 'l']); return 'Lock (Win+L)'; },
            'd': () => { sendCombo(['gui', 'd']); return 'Desktop (Win+D)'; },
            't': () => { sendCombo(['alt', 'tab']); return 'Alt+Tab'; },
            'a': () => { sendCombo(['ctrl', 'alt', 'delete']); return 'Ctrl+Alt+Del'; },
            'v': () => { toggleCapture(); return 'Toggle Video'; },
            'f': () => { toggleFullscreen(); return 'Toggle Fullscreen'; },
            '1': () => { playMacro(1); return 'Macro 1'; },
            '2': () => { playMacro(2); return 'Macro 2'; },
            '3': () => { playMacro(3); return 'Macro 3'; },
            '4': () => { playMacro(4); return 'Macro 4'; },
            'h': () => { showCmdModeHelp(); return 'Help'; },
            '?': () => { showCmdModeHelp(); return 'Help'; },
            'm': () => { return 'Mouse: ' + mouseSensitivity.toFixed(1) + 'x  Scroll: ' + scrollSensitivity; },
            '+': () => { adjustMouseSensitivity(0.5); return 'Mouse: ' + mouseSensitivity.toFixed(1) + 'x'; },
            '=': () => { adjustMouseSensitivity(0.5); return 'Mouse: ' + mouseSensitivity.toFixed(1) + 'x'; },
            '-': () => { adjustMouseSensitivity(-0.5); return 'Mouse: ' + mouseSensitivity.toFixed(1) + 'x'; },
            '[': () => { adjustScrollSensitivity(-1); return 'Scroll: ' + scrollSensitivity; },
            ']': () => { adjustScrollSensitivity(1); return 'Scroll: ' + scrollSensitivity; },
            'o': () => { return toggleCaptureLog(); },
            'p': () => { return typeClipboard(); },
        };

        function adjustMouseSensitivity(delta) {
            mouseSensitivity = Math.max(0.5, Math.min(5, mouseSensitivity + delta));
            document.getElementById('mouseSpeed').value = mouseSensitivity;
            document.getElementById('mouseSpeedVal').textContent = mouseSensitivity.toFixed(1) + 'x';
            localStorage.setItem('mouseSensitivity', mouseSensitivity);
        }

        function adjustScrollSensitivity(delta) {
            scrollSensitivity = Math.max(1, Math.min(10, scrollSensitivity + delta));
            document.getElementById('scrollSpeed').value = scrollSensitivity;
            document.getElementById('scrollSpeedVal').textContent = scrollSensitivity;
            localStorage.setItem('scrollSensitivity', scrollSensitivity);
        }

        // Clipboard bridge - read controller clipboard and type it on target
        let clipboardTyping = false;
        function typeClipboard() {
            if (!clipboardBridgeEnabled) {
                return 'Clipboard bridge disabled (enable in Settings)';
            }
            if (!kvm || !kvm.connected) {
                return 'Not connected';
            }
            if (clipboardTyping) {
                return 'Already typing...';
            }

            // Read clipboard and type it out
            navigator.clipboard.readText().then(async (text) => {
                if (!text || text.length === 0) {
                    log('Clipboard empty', 'warn');
                    return;
                }

                clipboardTyping = true;
                const maxLen = 10000; // Safety limit
                if (text.length > maxLen) {
                    text = text.substring(0, maxLen);
                    log('Clipboard truncated to ' + maxLen + ' chars', 'warn');
                }

                log('Typing ' + text.length + ' chars from clipboard...', 'info');
                showCmdToast('Pasting ' + text.length + ' chars...');

                const charDelay = 5; // ms between characters
                const lineDelay = 20; // extra ms after newlines

                for (let i = 0; i < text.length; i++) {
                    if (!kvm.connected) {
                        log('Clipboard paste aborted - disconnected', 'warn');
                        break;
                    }

                    const char = text[i];

                    // Handle newlines - send Enter key
                    if (char === '\n') {
                        await kvm.pressKey('Enter');
                        await new Promise(r => setTimeout(r, lineDelay));
                    } else if (char === '\r') {
                        // Skip carriage returns (Windows line endings are \r\n)
                        continue;
                    } else if (char === '\t') {
                        await kvm.pressKey('Tab');
                        await new Promise(r => setTimeout(r, charDelay));
                    } else {
                        // Type regular character
                        await kvm.typeText(char);
                        await new Promise(r => setTimeout(r, charDelay));
                    }
                }

                clipboardTyping = false;
                log('Clipboard paste complete', 'info');
                showCmdToast('Paste complete');
            }).catch((err) => {
                clipboardTyping = false;
                log('Clipboard read failed: ' + err.message, 'error');
            });

            return 'Reading clipboard...';
        }

        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        }

        function showCmdModeHelp() {
            // Show help overlay on screen (visible during capture)
            let helpOverlay = document.getElementById('cmdHelpOverlay');
            if (!helpOverlay) {
                helpOverlay = document.createElement('div');
                helpOverlay.id = 'cmdHelpOverlay';
                helpOverlay.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    border: 1px solid var(--accent-primary);
                    border-radius: 8px;
                    padding: 20px;
                    z-index: 100000;
                    font-family: 'IBM Plex Mono', monospace;
                    color: var(--text-bright);
                    text-align: left;
                    font-size: 12px;
                    line-height: 1.6;
                `;
                helpOverlay.innerHTML = `
                    <div style="color: var(--accent-primary); font-weight: bold; margin-bottom: 12px; font-size: 14px;">
                        CapsLock Command Mode ${keyboardLocked ? '(HOLD)' : '(TOGGLE)'}
                    </div>
                    <div style="display: grid; grid-template-columns: auto auto; gap: 4px 16px;">
                        <span style="color: var(--accent-secondary);">C</span><span>Connect/Disconnect</span>
                        <span style="color: var(--accent-secondary);">J</span><span>Toggle Jiggler</span>
                        <span style="color: var(--accent-secondary);">Q / Esc</span><span>Jack Out</span>
                        <span style="color: var(--accent-secondary);">R</span><span>Reset Device</span>
                        <span style="color: var(--accent-secondary);">W</span><span>Wake</span>
                        <span style="color: var(--accent-secondary);">S</span><span>Sleep</span>
                        <span style="color: var(--accent-secondary);">L</span><span>Lock (Win+L)</span>
                        <span style="color: var(--accent-secondary);">D</span><span>Desktop (Win+D)</span>
                        <span style="color: var(--accent-secondary);">T / Tab</span><span>Alt+Tab</span>
                        <span style="color: var(--accent-secondary);">A / Del</span><span>Ctrl+Alt+Del</span>
                        <span style="color: var(--accent-secondary);">V</span><span>Toggle Video</span>
                        <span style="color: var(--accent-secondary);">F</span><span>Fullscreen</span>
                        <span style="color: var(--accent-secondary);">O</span><span>Toggle Log</span>
                        <span style="color: var(--accent-secondary);">P</span><span>Paste Clipboard</span>
                        <span style="color: var(--accent-secondary);">1-4</span><span>Macros</span>
                        <span style="color: var(--accent-secondary);">M</span><span>Show Sensitivity</span>
                        <span style="color: var(--accent-secondary);">+ / -</span><span>Mouse Speed</span>
                        <span style="color: var(--accent-secondary);">[ / ]</span><span>Scroll Speed</span>
                    </div>
                    <div style="color: var(--text-dim); margin-top: 12px; font-size: 10px; text-align: center;">
                        ${keyboardLocked ? 'Fullscreen: CapsLock = hold modifier, system keys captured' : 'Toggle CapsLock to enter/exit command mode'}
                    </div>
                `;
                document.body.appendChild(helpOverlay);

                // Close on any key press
                const closeHelp = () => {
                    helpOverlay.remove();
                    document.removeEventListener('keydown', closeHelp);
                };
                setTimeout(() => document.addEventListener('keydown', closeHelp), 100);
            }
        }

        function updateCmdModeDisplay(active) {
            if (active) {
                cmdModeBanner.classList.add('active');
                captureSubtitle.textContent = 'Command mode - keys are shortcuts';
                // LED: command mode pattern
                if (kvm.setLed) kvm.setLed('cmd').catch(() => {});
            } else {
                cmdModeBanner.classList.remove('active');
                captureSubtitle.textContent = 'Direct control active';
                // LED: back to solid if still capturing
                if (isCapturing && kvm.setLed) kvm.setLed('jacked').catch(() => {});
            }
        }

        function handleCmdModeKey(key, code) {
            // Special key codes (when keyboard locked, these keys are captured)
            if (code === 'Delete') {
                sendCombo(['ctrl', 'alt', 'delete']);
                showCmdToast('Ctrl+Alt+Del');
                log('CMD: Ctrl+Alt+Del', 'info');
                return true;
            }
            if (code === 'Tab') {
                sendCombo(['alt', 'tab']);
                showCmdToast('Alt+Tab');
                log('CMD: Alt+Tab', 'info');
                return true;
            }
            if (code === 'Escape') {
                stopCapture();
                showCmdToast('Jack Out');
                log('CMD: Jack Out', 'info');
                return true;
            }

            const cmd = CMD_MODE_COMMANDS[key.toLowerCase()];
            if (cmd) {
                const desc = cmd();
                showCmdToast(desc);
                log('CMD: ' + desc, 'info');
                return true;
            }
            return false;
        }

        // Toast notification for command feedback
        let toastTimeout = null;
        function showCmdToast(msg) {
            let toast = document.getElementById('cmdToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'cmdToast';
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.85);
                    border: 1px solid var(--accent-primary);
                    border-radius: 4px;
                    padding: 8px 16px;
                    z-index: 100000;
                    font-family: 'IBM Plex Mono', monospace;
                    color: var(--accent-primary);
                    font-size: 13px;
                    font-weight: bold;
                    pointer-events: none;
                    transition: opacity 0.3s;
                `;
                document.body.appendChild(toast);
            }
            toast.textContent = msg;
            toast.style.opacity = '1';

            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.style.opacity = '0';
            }, 1500);
        }

        // Capture log panel (floating log visible during capture)
        let captureLogPanel = null;
        let captureLogVisible = false;
        let autoShowLogNoVideo = localStorage.getItem('autoShowLogNoVideo') !== 'false'; // default true

        function initCaptureLog() {
            if (captureLogPanel) return;
            captureLogPanel = document.createElement('div');
            captureLogPanel.id = 'captureLogPanel';
            captureLogPanel.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                width: 320px;
                max-height: calc(100vh - 40px);
                background: var(--panel-bg);
                border: 1px solid var(--panel-border);
                border-radius: 4px;
                z-index: 99999;
                overflow: hidden;
                display: none;
                flex-direction: column;
                box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            `;
            captureLogPanel.innerHTML = `
                <div style="padding: 6px 10px; background: var(--panel-surface); border-bottom: 1px solid var(--panel-border); display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 10px; color: var(--text-dim); text-transform: uppercase;">Log</span>
                    <span style="font-size: 9px; color: var(--accent-secondary);">O to toggle</span>
                </div>
                <div id="captureLogContent" class="log-display" style="flex: 1; min-height: 0; max-height: calc(100vh - 80px); border: none; border-radius: 0;"></div>
            `;
            document.body.appendChild(captureLogPanel);
        }

        function syncCaptureLog() {
            initCaptureLog();
            const mainLog = document.getElementById('log');
            const captureContent = document.getElementById('captureLogContent');
            if (mainLog && captureContent) {
                captureContent.innerHTML = mainLog.innerHTML;
                captureContent.scrollTop = captureContent.scrollHeight;
            }
        }

        function toggleCaptureLog() {
            initCaptureLog();
            captureLogVisible = !captureLogVisible;
            if (captureLogVisible) {
                syncCaptureLog();
            }
            captureLogPanel.style.display = captureLogVisible ? 'flex' : 'none';
            return captureLogVisible ? 'Log visible' : 'Log hidden';
        }

        function showCaptureLog(show) {
            initCaptureLog();
            captureLogVisible = show;
            if (show) {
                syncCaptureLog();
            }
            captureLogPanel.style.display = show ? 'flex' : 'none';
        }

        function startCapture() {
            if (!kvm.connected) return;

            // Request fullscreen first if enabled (keyboard lock requires fullscreen)
            if (fullscreenOnJackIn && !document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    doStartCapture();
                }).catch(() => {
                    // Fullscreen denied, continue without it
                    doStartCapture();
                });
            } else {
                doStartCapture();
            }
        }

        function doStartCapture() {
            overlay.classList.add('active');
            document.getElementById('capturePanel').classList.add('captured');
            // If video is streaming, make overlay transparent
            const videoEl = document.getElementById('videoFeed');
            const hasVideo = videoEl && videoEl.srcObject;
            if (hasVideo) {
                overlay.classList.add('video-active');
            } else if (autoShowLogNoVideo) {
                // Auto-show log when jacking in without video
                showCaptureLog(true);
            }
            overlay.requestPointerLock();
            // PWA badge - show when jacked in
            if ('setAppBadge' in navigator) {
                navigator.setAppBadge().catch(() => {});
            }
        }

        function stopCapture() {
            if (!isCapturing) return; // Already stopped
            isCapturing = false;
            overlay.classList.remove('active', 'video-active');
            document.getElementById('capturePanel').classList.remove('captured');
            updateCmdModeDisplay(false); // Clear command mode display
            // Hide capture log when jacking out
            if (captureLogPanel) {
                captureLogPanel.style.display = 'none';
                captureLogVisible = false;
            }
            // Only exit pointer lock if overlay has it (not trackpad)
            if (document.pointerLockElement === overlay) document.exitPointerLock();
            resetCaptureKeyboardState();
            captureButtons = 0;
            // Exit fullscreen if we auto-entered it
            if (fullscreenOnJackIn && document.fullscreenElement) {
                document.exitFullscreen().catch(() => {});
            }
            // PWA badge - clear when jacked out
            if ('clearAppBadge' in navigator) {
                navigator.clearAppBadge().catch(() => {});
            }
            // LED: back to connected pattern when jacking out
            if (kvm.setLed) kvm.setLed('connected').catch(() => {});
            log('Jacked out', 'info');
        }

        document.addEventListener('pointerlockchange', () => {
            if (document.pointerLockElement === overlay) {
                // Capture overlay got pointer lock - start capture mode
                isCapturing = true;
                captureStats = { mouse: 0, clicks: 0, keys: 0 };
                // LED: heartbeat when jacked in
                if (kvm.setLed) kvm.setLed('jacked').catch(() => {});
                // Wake lock: keep screen on while capturing
                requestWakeLock();
                updateCaptureStats();

                // Seamless mode: initialize cursor position from entry edge
                if (seamlessMode) {
                    // Update target dimensions from video if available
                    const videoEl = document.getElementById('videoFeed');
                    if (videoEl && videoEl.videoWidth) {
                        targetWidth = videoEl.videoWidth;
                        targetHeight = videoEl.videoHeight;
                    }
                    // Position cursor at entry edge
                    if (seamlessEdge === 'left') {
                        vCursorX = targetWidth - 10;  // Enter from right
                        vCursorY = targetHeight / 2;
                    } else {
                        vCursorX = 10;  // Enter from left
                        vCursorY = targetHeight / 2;
                    }
                    log('Seamless: entered at ' + vCursorX + ',' + vCursorY, 'info');
                }

                log('Jacked in', 'info');
                document.addEventListener('mousemove', onCaptureMouseMove);
                document.addEventListener('mousedown', onCaptureMouseDown);
                document.addEventListener('mouseup', onCaptureMouseUp);
                document.addEventListener('wheel', onCaptureWheel);
                document.addEventListener('keydown', onCaptureKeyDown);
                document.addEventListener('keyup', onCaptureKeyUp);

                // Request keyboard lock if already fullscreen
                if (document.fullscreenElement) {
                    requestKeyboardLock();
                }
            } else if (document.pointerLockElement === null && isCapturing) {
                // Pointer lock released while in capture mode - stop capture
                document.removeEventListener('mousemove', onCaptureMouseMove);
                document.removeEventListener('mousedown', onCaptureMouseDown);
                document.removeEventListener('mouseup', onCaptureMouseUp);
                document.removeEventListener('wheel', onCaptureWheel);
                document.removeEventListener('keydown', onCaptureKeyDown);
                document.removeEventListener('keyup', onCaptureKeyUp);
                // Wake lock: release when jacking out
                releaseWakeLock();
                stopCapture();
            }
            // If pointerLockElement is trackpad, do nothing here (trackpad handler handles it)
        });

        // Keyboard Lock API - capture system keys when fullscreen
        async function requestKeyboardLock() {
            if (!keyboardLockEnabled || !navigator.keyboard || !navigator.keyboard.lock) return;
            if (!document.fullscreenElement) return;

            try {
                // Lock CapsLock and system keys
                await navigator.keyboard.lock([
                    'CapsLock',
                    'AltLeft', 'AltRight',
                    'Tab',
                    'MetaLeft', 'MetaRight',
                    'Escape',
                    'ControlLeft', 'ControlRight'
                ]);
                keyboardLocked = true;
                capsLockHeld = false;
                log('Keyboard locked - CapsLock is now hold-modifier', 'info');
            } catch (err) {
                log('Keyboard lock failed: ' + err.message, 'warn');
            }
        }

        function releaseKeyboardLock() {
            if (!navigator.keyboard || !navigator.keyboard.unlock) return;
            if (!keyboardLocked) return;

            navigator.keyboard.unlock();
            keyboardLocked = false;
            capsLockHeld = false;
            log('Keyboard unlocked', 'info');
        }

        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement && isCapturing) {
                requestKeyboardLock();
            } else {
                releaseKeyboardLock();
            }
        });

        function onCaptureMouseMove(e) {
            if (!isCapturing || !kvm.connected) return;
            if (e.movementX !== 0 || e.movementY !== 0) {
                // Include button state so drag works correctly - apply sensitivity
                const dx = Math.round(e.movementX * mouseSensitivity);
                const dy = Math.round(e.movementY * mouseSensitivity);

                // Seamless mode: track virtual cursor and check edges
                if (seamlessMode) {
                    vCursorX += dx;
                    vCursorY += dy;

                    // Clamp Y to screen bounds
                    vCursorY = Math.max(0, Math.min(targetHeight, vCursorY));

                    // Check edge - release pointer lock to return to controller
                    if (seamlessEdge === 'left' && vCursorX < 0) {
                        document.exitPointerLock();
                        log('Seamless: exited left edge', 'info');
                        return;
                    } else if (seamlessEdge === 'right' && vCursorX > targetWidth) {
                        document.exitPointerLock();
                        log('Seamless: exited right edge', 'info');
                        return;
                    }

                    // Clamp X within bounds (don't let it go too far if wrong edge)
                    vCursorX = Math.max(0, Math.min(targetWidth, vCursorX));

                    // Update cursor indicator if visible
                    updateSeamlessCursor();
                }

                kvm.moveMouse(dx, dy, 0, captureButtons);
                captureStats.mouse++;
                updateCaptureStats();
            }
        }

        function updateSeamlessCursor() {
            const cursor = document.getElementById('seamlessCursor');
            if (!cursor || !seamlessMode) return;
            const videoEl = document.getElementById('videoFeed');
            if (!videoEl) return;

            // Map virtual cursor to video element position
            const rect = videoEl.getBoundingClientRect();
            const scaleX = rect.width / targetWidth;
            const scaleY = rect.height / targetHeight;
            cursor.style.left = (rect.left + vCursorX * scaleX) + 'px';
            cursor.style.top = (rect.top + vCursorY * scaleY) + 'px';
            cursor.style.display = 'block';
        }

        let captureButtons = 0;

        function onCaptureMouseDown(e) {
            if (!isCapturing || !kvm.connected) return;
            e.preventDefault();
            const btnMap = { 0: 1, 1: 4, 2: 2 };
            captureButtons |= btnMap[e.button] || 0;
            kvm.moveMouse(0, 0, 0, captureButtons);
            captureStats.clicks++;
            updateCaptureStats();
        }

        function onCaptureMouseUp(e) {
            if (!isCapturing || !kvm.connected) return;
            e.preventDefault();
            const btnMap = { 0: 1, 1: 4, 2: 2 };
            captureButtons &= ~(btnMap[e.button] || 0);
            kvm.moveMouse(0, 0, 0, captureButtons);
        }

        function onCaptureWheel(e) {
            if (!isCapturing || !kvm.connected) return;
            e.preventDefault();
            kvm.scroll(e.deltaY > 0 ? -scrollSensitivity : scrollSensitivity);
        }

        let heldModifiers = 0, heldKeys = [];

        async function updateKeyboardState() {
            await kvm.sendKeyboardReport(heldModifiers, heldKeys);
        }

        // Map e.code (physical key) to KEYCODE key names
        const CODE_TO_KEY = {
            // Letters
            'KeyA': 'a', 'KeyB': 'b', 'KeyC': 'c', 'KeyD': 'd', 'KeyE': 'e', 'KeyF': 'f',
            'KeyG': 'g', 'KeyH': 'h', 'KeyI': 'i', 'KeyJ': 'j', 'KeyK': 'k', 'KeyL': 'l',
            'KeyM': 'm', 'KeyN': 'n', 'KeyO': 'o', 'KeyP': 'p', 'KeyQ': 'q', 'KeyR': 'r',
            'KeyS': 's', 'KeyT': 't', 'KeyU': 'u', 'KeyV': 'v', 'KeyW': 'w', 'KeyX': 'x',
            'KeyY': 'y', 'KeyZ': 'z',
            // Numbers
            'Digit1': '1', 'Digit2': '2', 'Digit3': '3', 'Digit4': '4', 'Digit5': '5',
            'Digit6': '6', 'Digit7': '7', 'Digit8': '8', 'Digit9': '9', 'Digit0': '0',
            // Punctuation
            'Minus': '-', 'Equal': '=', 'BracketLeft': '[', 'BracketRight': ']', 'Backslash': '\\',
            'Semicolon': ';', 'Quote': "'", 'Backquote': '`', 'Comma': ',', 'Period': '.', 'Slash': '/',
            // Special keys
            'Enter': 'enter', 'Escape': 'escape', 'Backspace': 'backspace', 'Tab': 'tab', 'Space': 'space',
            // Function keys
            'F1': 'f1', 'F2': 'f2', 'F3': 'f3', 'F4': 'f4', 'F5': 'f5', 'F6': 'f6',
            'F7': 'f7', 'F8': 'f8', 'F9': 'f9', 'F10': 'f10', 'F11': 'f11', 'F12': 'f12',
            // Control keys
            'PrintScreen': 'printscreen', 'ScrollLock': 'scrolllock', 'Pause': 'pause',
            'Insert': 'insert', 'Home': 'home', 'PageUp': 'pageup',
            'Delete': 'delete', 'End': 'end', 'PageDown': 'pagedown',
            // Arrow keys
            'ArrowRight': 'right', 'ArrowLeft': 'left', 'ArrowDown': 'down', 'ArrowUp': 'up',
            // Modifiers
            'ControlLeft': 'ctrl', 'ControlRight': 'rctrl',
            'ShiftLeft': 'shift', 'ShiftRight': 'rshift',
            'AltLeft': 'alt', 'AltRight': 'ralt',
            'MetaLeft': 'gui', 'MetaRight': 'rgui',
            // Numpad
            'NumLock': 'numlock', 'NumpadDivide': 'num/', 'NumpadMultiply': 'num*',
            'NumpadSubtract': 'num-', 'NumpadAdd': 'num+', 'NumpadEnter': 'numenter',
            'Numpad1': 'num1', 'Numpad2': 'num2', 'Numpad3': 'num3', 'Numpad4': 'num4', 'Numpad5': 'num5',
            'Numpad6': 'num6', 'Numpad7': 'num7', 'Numpad8': 'num8', 'Numpad9': 'num9', 'Numpad0': 'num0',
            'NumpadDecimal': 'num.'
        };

        function onCaptureKeyDown(e) {
            if (!isCapturing || !kvm.connected) return;
            // Check for configurable exit key (use e.key for this since user expects character)
            // When keyboard locked, Escape is captured - only exit if not locked
            if (e.key === exitKey && !keyboardLocked) {
                stopCapture();
                return;
            }
            e.preventDefault();

            // CapsLock command mode handling
            if (capsLockCmdMode) {
                // When keyboard locked, CapsLock is a hold-modifier
                if (keyboardLocked) {
                    if (e.code === 'CapsLock') {
                        capsLockHeld = true;
                        updateCmdModeDisplay(true);
                        return;
                    }
                    if (capsLockHeld) {
                        handleCmdModeKey(e.key, e.code);
                        return;
                    }
                } else {
                    // Original toggle behavior when not locked
                    const capsLockOn = e.getModifierState('CapsLock');
                    if (capsLockOn) {
                        updateCmdModeDisplay(true);
                        if (e.code !== 'CapsLock') {
                            handleCmdModeKey(e.key, e.code);
                        }
                        return;
                    } else {
                        updateCmdModeDisplay(false);
                    }
                }
            }

            // Use e.code for physical key mapping
            const key = CODE_TO_KEY[e.code];
            if (!key) return;

            const mod = RelayKVMAdapter.MODIFIER_MAP[key];
            if (mod) { heldModifiers |= mod; updateKeyboardState(); return; }

            const code = RelayKVMAdapter.KEYCODE[key];
            if (code && !heldKeys.includes(code) && heldKeys.length < 6) {
                heldKeys.push(code);
                updateKeyboardState();
                captureStats.keys++;
                updateCaptureStats();
            }
        }

        function onCaptureKeyUp(e) {
            if (!isCapturing || !kvm.connected) return;
            e.preventDefault();

            // CapsLock command mode handling
            if (capsLockCmdMode) {
                if (keyboardLocked) {
                    // When keyboard locked, CapsLock release exits command mode
                    if (e.code === 'CapsLock') {
                        capsLockHeld = false;
                        updateCmdModeDisplay(false);
                        return;
                    }
                    if (capsLockHeld) return; // Don't process key releases in command mode
                } else {
                    // Original toggle behavior
                    const capsLockOn = e.getModifierState('CapsLock');
                    updateCmdModeDisplay(capsLockOn);
                    if (capsLockOn) return; // Don't process key releases in command mode
                }
            }

            const key = CODE_TO_KEY[e.code];
            if (!key) return;

            const mod = RelayKVMAdapter.MODIFIER_MAP[key];
            if (mod) { heldModifiers &= ~mod; updateKeyboardState(); return; }

            const code = RelayKVMAdapter.KEYCODE[key];
            if (code) { heldKeys = heldKeys.filter(k => k !== code); updateKeyboardState(); }
        }

        function resetCaptureKeyboardState() {
            heldModifiers = 0; heldKeys = [];
            if (kvm.connected) kvm.sendKeyboardReport(0, []);
        }

        function updateCaptureStats() {
            document.getElementById('statMouse').textContent = captureStats.mouse;
            document.getElementById('statClicks').textContent = captureStats.clicks;
            document.getElementById('statKeys').textContent = captureStats.keys;
        }

        overlay.addEventListener('contextmenu', e => e.preventDefault());

        // Logging
        function log(msg, type = 'info') {
            const el = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            entry.innerHTML = '<span class="time">' + time + '</span> ' + msg;
            el.appendChild(entry);
            el.scrollTop = el.scrollHeight;
            while (el.children.length > 50) el.removeChild(el.firstChild);

            // Sync to capture log if visible
            if (captureLogVisible) {
                const captureContent = document.getElementById('captureLogContent');
                if (captureContent) {
                    const clone = entry.cloneNode(true);
                    captureContent.appendChild(clone);
                    captureContent.scrollTop = captureContent.scrollHeight;
                    while (captureContent.children.length > 50) captureContent.removeChild(captureContent.firstChild);
                }
            }
        }

        function clearLog() { document.getElementById('log').innerHTML = ''; }

        // Mouse Jiggler
        let jigglerActive = false;
        let jigglerTimer = null;
        let jigglerRange = parseInt(localStorage.getItem('jigglerRange')) || 5;
        let jigglerInterval = parseInt(localStorage.getItem('jigglerInterval')) || 30;
        let jigglerDirection = 1;

        const jigglerRangeSlider = document.getElementById('jigglerRange');
        const jigglerRangeVal = document.getElementById('jigglerRangeVal');
        const jigglerIntervalSlider = document.getElementById('jigglerInterval');
        const jigglerIntervalVal = document.getElementById('jigglerIntervalVal');
        const jigglerBtn = document.getElementById('jigglerBtn');
        const ledJiggler = document.getElementById('ledJiggler');

        // Initialize jiggler sliders
        jigglerRangeSlider.value = jigglerRange;
        jigglerRangeVal.textContent = jigglerRange;
        jigglerIntervalSlider.value = jigglerInterval;
        jigglerIntervalVal.textContent = jigglerInterval;

        jigglerRangeSlider.addEventListener('input', () => {
            jigglerRange = parseInt(jigglerRangeSlider.value);
            jigglerRangeVal.textContent = jigglerRange;
            localStorage.setItem('jigglerRange', jigglerRange);
        });

        jigglerIntervalSlider.addEventListener('input', () => {
            jigglerInterval = parseInt(jigglerIntervalSlider.value);
            jigglerIntervalVal.textContent = jigglerInterval;
            localStorage.setItem('jigglerInterval', jigglerInterval);
            // New interval takes effect on next scheduled jiggle
        });

        function toggleJiggler() {
            if (!kvm.connected) {
                log('Connect first to use jiggler', 'error');
                return;
            }

            jigglerActive = !jigglerActive;

            if (jigglerActive) {
                jigglerBtn.textContent = 'Stop';
                jigglerBtn.classList.add('danger');
                ledJiggler.classList.add('on');
                scheduleJiggle();
                log('Jiggler: ' + jigglerRange + 'px/~' + jigglerInterval + 's', 'info');
            } else {
                jigglerBtn.textContent = 'Start';
                jigglerBtn.classList.remove('danger');
                ledJiggler.classList.remove('on');
                clearTimeout(jigglerTimer);
                jigglerTimer = null;
                log('Jiggler off', 'info');
            }
        }

        function getJitteredInterval() {
            // Add ¬±30% jitter to interval
            const jitter = 0.3;
            const base = jigglerInterval * 1000;
            const variance = base * jitter;
            return base + (Math.random() * 2 - 1) * variance;
        }

        function scheduleJiggle() {
            jigglerTimer = setTimeout(doJiggle, getJitteredInterval());
        }

        function doJiggle() {
            if (!kvm.connected || !jigglerActive) {
                if (jigglerActive) toggleJiggler(); // Stop if disconnected
                return;
            }
            // Move in alternating directions
            const move = jigglerRange * jigglerDirection;
            kvm.moveMouse(move, move);
            jigglerDirection *= -1;
            flashLed('ledTx');
            // Schedule next jiggle with jitter
            scheduleJiggle();
        }

        // Modifier toggles
        let activeModifiers = { ctrl: false, alt: false, shift: false, gui: false };

        function toggleModifier(mod) {
            activeModifiers[mod] = !activeModifiers[mod];
            const btn = document.getElementById('mod' + mod.charAt(0).toUpperCase() + mod.slice(1));
            if (activeModifiers[mod]) {
                btn.classList.add('green');
            } else {
                btn.classList.remove('green');
            }
            updateHyperState();
        }

        function toggleHyper() {
            const allOn = activeModifiers.ctrl && activeModifiers.alt && activeModifiers.shift && activeModifiers.gui;
            const newState = !allOn;
            ['ctrl', 'alt', 'shift', 'gui'].forEach(mod => {
                activeModifiers[mod] = newState;
                const btn = document.getElementById('mod' + mod.charAt(0).toUpperCase() + mod.slice(1));
                if (newState) {
                    btn.classList.add('green');
                } else {
                    btn.classList.remove('green');
                }
            });
            updateHyperState();
            log('Hyper: ' + (newState ? 'ON' : 'OFF'), 'info');
        }

        function updateHyperState() {
            const allOn = activeModifiers.ctrl && activeModifiers.alt && activeModifiers.shift && activeModifiers.gui;
            const hyperBtn = document.getElementById('modHyper');
            if (allOn) {
                hyperBtn.classList.add('green');
            } else {
                hyperBtn.classList.remove('green');
            }
        }

        // Get active modifiers for combo
        function getActiveModifiers() {
            return Object.keys(activeModifiers).filter(m => activeModifiers[m]);
        }

        // Override sendKey to include active modifiers
        const originalSendKey = sendKey;
        sendKey = async function(key) {
            const mods = getActiveModifiers();
            if (mods.length > 0 && kvm.connected) {
                flashLed('ledTx');
                log('TX: ' + [...mods, key].join('+').toUpperCase(), 'send');
                await kvm.sendKeyCombo([...mods, key]);
            } else {
                await originalSendKey(key);
            }
        };

        // Macros (stores in localStorage)
        let macros = JSON.parse(localStorage.getItem('macros')) || {
            1: 'Hello World',
            2: '',
            3: '',
            4: ''
        };

        const macroSelect = document.getElementById('macroSelect');
        const macroEdit = document.getElementById('macroEdit');

        // Load macro into editor when selection changes
        macroSelect.addEventListener('change', () => {
            macroEdit.value = macros[macroSelect.value] || '';
        });

        // Initialize editor with first macro
        macroEdit.value = macros[1] || '';

        // Update macro button styles based on content
        function updateMacroButtons() {
            for (let i = 1; i <= 4; i++) {
                const btn = document.getElementById('macroBtn' + i);
                if (macros[i]) {
                    btn.classList.add('amber');
                    btn.title = macros[i].substring(0, 50);
                } else {
                    btn.classList.remove('amber');
                    btn.title = 'Empty';
                }
            }
        }
        updateMacroButtons();

        function saveMacro() {
            const num = macroSelect.value;
            macros[num] = macroEdit.value;
            localStorage.setItem('macros', JSON.stringify(macros));
            updateMacroButtons();
            log('Macro ' + num + ' saved', 'info');
        }

        function editMacro(num, event) {
            event.preventDefault();
            macroSelect.value = num;
            macroEdit.value = macros[num] || '';
            macroEdit.focus();
            macroEdit.select();
        }

        function playMacro(num) {
            if (!kvm.connected) {
                log('Connect first', 'error');
                return;
            }
            const text = macros[num];
            if (text) {
                flashLed('ledTx');
                log('Macro ' + num + ': "' + text.substring(0, 20) + (text.length > 20 ? '...' : '') + '"', 'send');
                kvm.typeText(text);
            } else {
                log('Macro ' + num + ' empty', 'info');
                // Select this macro for editing
                macroSelect.value = num;
                macroEdit.value = '';
                macroEdit.focus();
            }
        }

        // Video module
        let videoMode = 'off';
        let videoStreaming = false;

        function setVideoMode(mode) {
            videoMode = mode;
            // Stop any active stream when switching modes
            if (videoStreaming) {
                stopVideoStream();
            }
            updateVideoUI();
            // Re-enumerate devices when switching to USB
            if (mode === 'usb') {
                enumerateCaptureDevices();
            }
            log('Video: ' + mode.toUpperCase(), 'info');
        }

        function updateVideoUI() {
            const ledVideo = document.getElementById('ledVideo');
            const captureDevice = document.getElementById('captureDevice');
            const startCaptureBtn = document.getElementById('startCaptureBtn');
            const peerId = document.getElementById('peerId');
            const connectPeerBtn = document.getElementById('connectPeerBtn');
            const videoParams = document.getElementById('videoParams');

            // Update LED: amber=off, blue=ready, green=streaming
            ledVideo.classList.remove('on', 'amber', 'blue');
            if (videoMode === 'off') {
                ledVideo.classList.add('amber');
            } else if (videoStreaming) {
                ledVideo.classList.add('on'); // green = active
            } else {
                ledVideo.classList.add('blue', 'on'); // blue = ready
            }

            // Enable/disable USB controls
            captureDevice.disabled = videoMode !== 'usb';
            startCaptureBtn.disabled = videoMode !== 'usb';
            startCaptureBtn.textContent = videoStreaming && videoMode === 'usb' ? 'Stop' : 'Start';
            startCaptureBtn.classList.toggle('red', videoStreaming && videoMode === 'usb');
            startCaptureBtn.classList.toggle('green', !videoStreaming || videoMode !== 'usb');

            // Enable/disable WebRTC controls
            peerId.disabled = videoMode !== 'webrtc';
            connectPeerBtn.disabled = videoMode !== 'webrtc';
            connectPeerBtn.textContent = videoStreaming && videoMode === 'webrtc' ? 'Stop' : 'Connect';
            connectPeerBtn.classList.toggle('red', videoStreaming && videoMode === 'webrtc');
            connectPeerBtn.classList.toggle('green', !videoStreaming || videoMode !== 'webrtc');

            // Enable/disable Screen Share controls
            const startScreenBtn = document.getElementById('startScreenBtn');
            if (startScreenBtn) {
                startScreenBtn.disabled = videoMode !== 'screen';
                startScreenBtn.textContent = videoStreaming && videoMode === 'screen' ? 'Stop' : 'Share';
                startScreenBtn.classList.toggle('red', videoStreaming && videoMode === 'screen');
                startScreenBtn.classList.toggle('green', !videoStreaming || videoMode !== 'screen');
            }

            // Dim resolution/FPS when off
            if (videoMode === 'off') {
                videoParams.classList.add('disabled');
            } else {
                videoParams.classList.remove('disabled');
            }
        }

        function toggleCapture() {
            if (videoStreaming) {
                stopVideoStream();
            } else {
                const device = document.getElementById('captureDevice').value;
                if (!device) {
                    log('Select a capture device', 'error');
                    return;
                }
                startVideoStream('usb');
            }
        }

        function connectPeer() {
            if (videoStreaming) {
                stopVideoStream();
            } else {
                const peerId = document.getElementById('peerId').value;
                if (!peerId) {
                    log('Enter peer ID', 'error');
                    return;
                }
                startVideoStream('webrtc');
                log('WebRTC: connecting to ' + peerId + '... (not implemented)', 'info');
            }
        }

        async function toggleScreenShare() {
            if (videoStreaming) {
                stopVideoStream();
            } else {
                try {
                    log('Video: requesting screen share...', 'info');
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            cursor: 'always'
                        },
                        audio: false
                    });

                    videoStream = stream;
                    videoFeed.srcObject = stream;
                    videoFeed.style.display = 'block';
                    videoStreaming = true;

                    // Handle stream end (user clicks "Stop sharing")
                    stream.getVideoTracks()[0].onended = () => {
                        stopVideoStream();
                        // Reset to off mode
                        videoMode = 'off';
                        document.querySelector('input[name="videoMode"][value="off"]').checked = true;
                        updateVideoUI();
                    };

                    // Get actual resolution
                    const track = stream.getVideoTracks()[0];
                    const settings = track.getSettings();
                    log('Screen share: ' + settings.width + 'x' + settings.height, 'info');

                    updateVideoUI();
                } catch (err) {
                    log('Screen share failed: ' + err.message, 'error');
                }
            }
        }

        let videoStream = null;
        const videoFeed = document.getElementById('videoFeed');
        const capturePanel = document.getElementById('capturePanel');
        const captureTitle = document.getElementById('captureTitle');

        // FPS tracking
        let fpsFrameCount = 0;
        let fpsLastTime = performance.now();
        let fpsCallbackId = null;

        function trackVideoFps() {
            if (!videoFeed.srcObject) return;

            fpsFrameCount++;
            const now = performance.now();
            const elapsed = now - fpsLastTime;

            if (elapsed >= 1000) {
                const fps = Math.round((fpsFrameCount * 1000) / elapsed);
                document.getElementById('statFps').textContent = fps;
                fpsFrameCount = 0;
                fpsLastTime = now;
            }

            // Use requestVideoFrameCallback if available, else requestAnimationFrame
            if ('requestVideoFrameCallback' in HTMLVideoElement.prototype) {
                fpsCallbackId = videoFeed.requestVideoFrameCallback(trackVideoFps);
            } else {
                fpsCallbackId = requestAnimationFrame(trackVideoFps);
            }
        }

        function startFpsTracking() {
            fpsFrameCount = 0;
            fpsLastTime = performance.now();
            document.getElementById('statFps').textContent = '--';
            trackVideoFps();
        }

        function stopFpsTracking() {
            if (fpsCallbackId) {
                if ('requestVideoFrameCallback' in HTMLVideoElement.prototype) {
                    videoFeed.cancelVideoFrameCallback(fpsCallbackId);
                } else {
                    cancelAnimationFrame(fpsCallbackId);
                }
                fpsCallbackId = null;
            }
            document.getElementById('statFps').textContent = '--';
        }

        async function startVideoStream(type) {
            if (type === 'usb') {
                const deviceId = document.getElementById('captureDevice').value;
                if (!deviceId) {
                    log('Select a capture device first', 'error');
                    return;
                }

                // Save as last used device and settings
                localStorage.setItem('relayKvmCaptureDevice', deviceId);
                localStorage.setItem('relayKvmVideoRes', document.getElementById('videoRes').value);
                localStorage.setItem('relayKvmVideoFps', document.getElementById('videoFps').value);

                // Get resolution and FPS settings
                const resSelect = document.getElementById('videoRes');
                const fpsSelect = document.getElementById('videoFps');
                const height = parseInt(resSelect.value);
                const fps = parseInt(fpsSelect.value);
                const width = Math.round(height * 16 / 9); // Assume 16:9

                try {
                    log('Video: starting capture...', 'info');
                    videoStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            deviceId: { exact: deviceId },
                            width: { ideal: width },
                            height: { ideal: height },
                            frameRate: { ideal: fps }
                        },
                        audio: false
                    });

                    videoFeed.srcObject = videoStream;
                    await videoFeed.play();

                    // Get actual resolution
                    const track = videoStream.getVideoTracks()[0];
                    const settings = track.getSettings();
                    log('Video: ' + settings.width + 'x' + settings.height + '@' + Math.round(settings.frameRate) + 'fps', 'info');

                    videoStreaming = true;
                    capturePanel.classList.add('streaming');
                    startFpsTracking();
                    updateVideoUI();
                } catch (e) {
                    log('Video error: ' + e.message, 'error');
                    videoStreaming = false;
                    updateVideoUI();
                }
            } else if (type === 'webrtc') {
                // WebRTC implementation placeholder
                log('WebRTC: not yet implemented', 'info');
                videoStreaming = true;
                updateVideoUI();
            }
        }

        function stopVideoStream() {
            stopFpsTracking();
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            videoFeed.srcObject = null;
            capturePanel.classList.remove('streaming');
            videoStreaming = false;
            updateVideoUI();
            log('Video: stopped', 'info');
        }

        // Initialize video LED state (off = amber)
        document.getElementById('ledVideo').classList.add('amber');

        // Query device capabilities when a device is selected
        async function queryDeviceCapabilities() {
            const deviceId = document.getElementById('captureDevice').value;
            const resSelect = document.getElementById('videoRes');
            const fpsSelect = document.getElementById('videoFps');

            if (!deviceId) {
                // Reset to defaults
                resSelect.innerHTML = `
                    <option value="480">480p</option>
                    <option value="720" selected>720p</option>
                    <option value="1080">1080p</option>
                    <option value="1440">1440p</option>
                `;
                return;
            }

            try {
                // Get temporary stream to query capabilities
                const tempStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: deviceId } }
                });

                const track = tempStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();

                // Stop the temporary stream
                tempStream.getTracks().forEach(t => t.stop());

                // Build resolution options based on capabilities
                const maxHeight = capabilities.height?.max || 1080;
                const maxWidth = capabilities.width?.max || 1920;
                const maxFps = capabilities.frameRate?.max || 30;

                // Standard resolutions to offer (if supported)
                const standardRes = [
                    { label: '480p', height: 480, width: 854 },
                    { label: '720p', height: 720, width: 1280 },
                    { label: '1080p', height: 1080, width: 1920 },
                    { label: '1440p', height: 1440, width: 2560 },
                    { label: '4K', height: 2160, width: 3840 }
                ];

                // Filter to supported resolutions
                const supported = standardRes.filter(r => r.height <= maxHeight && r.width <= maxWidth);

                // Get saved preferences
                const savedRes = localStorage.getItem('relayKvmVideoRes');
                const savedFps = localStorage.getItem('relayKvmVideoFps');

                if (supported.length > 0) {
                    resSelect.innerHTML = supported.map(r =>
                        `<option value="${r.height}">${r.label}</option>`
                    ).join('');

                    // Restore saved resolution, or default to 720p, or highest supported
                    if (savedRes && supported.find(r => r.height === parseInt(savedRes))) {
                        resSelect.value = savedRes;
                    } else if (supported.find(r => r.height === 720)) {
                        resSelect.value = 720;
                    } else {
                        resSelect.value = supported[supported.length - 1].height;
                    }
                }

                // Update FPS options
                const standardFps = [15, 30, 60, 120];
                const supportedFps = standardFps.filter(f => f <= maxFps);

                if (supportedFps.length > 0) {
                    fpsSelect.innerHTML = supportedFps.map(f =>
                        `<option value="${f}">${f}</option>`
                    ).join('');

                    // Restore saved FPS, or default to 30, or highest supported
                    if (savedFps && supportedFps.includes(parseInt(savedFps))) {
                        fpsSelect.value = savedFps;
                    } else if (supportedFps.includes(30)) {
                        fpsSelect.value = 30;
                    } else {
                        fpsSelect.value = supportedFps[supportedFps.length - 1];
                    }
                }

                log('Device: up to ' + maxWidth + 'x' + maxHeight + '@' + Math.round(maxFps) + 'fps', 'info');

            } catch (e) {
                log('Could not query device: ' + e.message, 'warn');
            }
        }

        // Enumerate USB capture devices (if available)
        async function enumerateCaptureDevices() {
            const select = document.getElementById('captureDevice');
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                    select.innerHTML = '<option value="">Media API not available</option>';
                    log('MediaDevices API not available', 'error');
                    return;
                }

                // First try to enumerate - labels may be empty without permission
                let devices = await navigator.mediaDevices.enumerateDevices();
                let videoDevices = devices.filter(d => d.kind === 'videoinput');
                log('Found ' + videoDevices.length + ' video device(s)', 'info');

                // If labels are empty, we need to request permission first
                if (videoDevices.length > 0 && !videoDevices[0].label) {
                    try {
                        log('Requesting camera permission...', 'info');
                        // Request a temporary stream to get permission
                        const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                        tempStream.getTracks().forEach(t => t.stop());
                        // Re-enumerate with labels now available
                        devices = await navigator.mediaDevices.enumerateDevices();
                        videoDevices = devices.filter(d => d.kind === 'videoinput');
                        log('Got ' + videoDevices.length + ' device(s) with labels', 'info');
                    } catch (e) {
                        log('Camera permission denied: ' + e.message, 'error');
                        // Continue with generic names
                    }
                }

                select.innerHTML = '<option value="">Select capture device...</option>';
                videoDevices.forEach((device, i) => {
                    const opt = document.createElement('option');
                    opt.value = device.deviceId;
                    opt.textContent = device.label || ('Video Input ' + (i + 1));
                    select.appendChild(opt);
                });

                // Auto-select last used device if available
                const lastDevice = localStorage.getItem('relayKvmCaptureDevice');
                if (lastDevice) {
                    const option = select.querySelector(`option[value="${lastDevice}"]`);
                    if (option) {
                        select.value = lastDevice;
                        log('Auto-selected: ' + option.textContent, 'info');
                        queryDeviceCapabilities();
                    }
                }

                if (videoDevices.length === 0) {
                    select.innerHTML = '<option value="">No capture devices found</option>';
                    log('No video capture devices found', 'warn');
                }
            } catch (e) {
                select.innerHTML = '<option value="">Camera access denied</option>';
                log('Device enumeration failed: ' + e.message, 'error');
            }
        }

        // Re-enumerate when video mode is set to USB
        function requestCaptureDevices() {
            enumerateCaptureDevices();
        }

        // Note: Device enumeration happens when USB mode is selected (not on page load)

        // Wake/Power functions
        const powerArmBtn = document.getElementById('powerArm');
        const powerBtn = document.getElementById('powerBtn');
        let powerArmed = false;
        let armTimeout = null;

        function togglePowerArm() {
            powerArmed = !powerArmed;
            powerArmBtn.classList.toggle('armed', powerArmed);
            powerBtn.classList.toggle('armed', powerArmed);

            if (powerArmed) {
                log('Power armed - use with caution!', 'error');
                // Auto-disarm after 10 seconds
                armTimeout = setTimeout(() => {
                    if (powerArmed) {
                        powerArmed = false;
                        powerArmBtn.classList.remove('armed');
                        powerBtn.classList.remove('armed');
                        log('Power auto-disarmed', 'info');
                    }
                }, 10000);
            } else {
                if (armTimeout) clearTimeout(armTimeout);
                log('Power disarmed', 'info');
            }
        }

        // Sleep macro (Windows: Win+X, U, S)
        async function sendSleep() {
            if (!kvm.connected) {
                log('Connect first', 'error');
                return;
            }
            try {
                flashLed('ledTx');
                log('Sending sleep sequence (Win+X, U, S)...', 'info');
                // Win+X to open power menu
                await kvm.sendKeyboardReport(0x08, [0x1B]); // GUI + X
                await new Promise(r => setTimeout(r, 100));
                await kvm.sendKeyboardReport(0, []);
                await new Promise(r => setTimeout(r, 300)); // Wait for menu
                // U for Shut down or sign out
                await kvm.sendKeyboardReport(0, [0x18]); // U
                await new Promise(r => setTimeout(r, 50));
                await kvm.sendKeyboardReport(0, []);
                await new Promise(r => setTimeout(r, 200)); // Wait for submenu
                // S for Sleep
                await kvm.sendKeyboardReport(0, [0x16]); // S
                await new Promise(r => setTimeout(r, 50));
                await kvm.sendKeyboardReport(0, []);
                log('Sleep sequence sent', 'send');
            } catch (e) {
                log('Sleep error: ' + e.message, 'error');
            }
        }

        // Simple wake - just sends keyboard activity
        async function sendWake() {
            if (!kvm.connected) {
                log('Connect first', 'error');
                return;
            }
            try {
                flashLed('ledTx');
                // Send a shift key press/release to wake
                await kvm.sendKeyboardReport(0x02, []); // Left Shift down
                await new Promise(r => setTimeout(r, 50));
                await kvm.sendKeyboardReport(0, []); // Release
                log('Wake signal sent', 'send');
            } catch (e) {
                log('Wake error: ' + e.message, 'error');
            }
        }

        // USB Wake - sends command to Cardputer to trigger USB wake
        async function sendUsbWake() {
            if (!kvm.connected) {
                log('Connect first', 'error');
                return;
            }
            try {
                flashLed('ledTx');
                await kvm.sendUsbWake();
                log('USB wake signal sent', 'send');
            } catch (e) {
                log('USB wake error: ' + e.message, 'error');
            }
        }

        async function sendPower() {
            if (!kvm.connected || !powerArmed) return;
            flashLed('ledTx');
            // This would need firmware support for power button
            log('Power button pressed (not implemented in firmware)', 'info');
            // Disarm after use
            powerArmed = false;
            powerArmBtn.classList.remove('armed');
            powerBtn.classList.remove('armed');
        }

        // Connection monitoring
        let pingInterval = null;

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connStatus');
            const bars = document.getElementById('signalBars');
            const latency = document.getElementById('connLatency');

            if (connected) {
                status.textContent = 'Connected';
                bars.className = 'signal-bars strength-4';
                // Start ping interval
                if (!pingInterval) {
                    pingInterval = setInterval(measureLatency, 5000);
                    measureLatency();
                }
            } else {
                status.textContent = 'Disconnected';
                bars.className = 'signal-bars';
                latency.textContent = '--ms';
                latency.classList.add('dim');
                if (pingInterval) {
                    clearInterval(pingInterval);
                    pingInterval = null;
                }
            }
        }

        async function measureLatency() {
            if (!kvm.connected) return;
            const start = performance.now();
            try {
                // Send a minimal message and measure response time
                await kvm.sendKeyboardReport(0, []);
                const elapsed = Math.round(performance.now() - start);
                const latencyEl = document.getElementById('connLatency');
                latencyEl.textContent = elapsed + 'ms';
                latencyEl.classList.remove('dim');

                // Update signal bars based on latency
                const bars = document.getElementById('signalBars');
                if (elapsed < 50) bars.className = 'signal-bars strength-4';
                else if (elapsed < 100) bars.className = 'signal-bars strength-3';
                else if (elapsed < 200) bars.className = 'signal-bars strength-2';
                else bars.className = 'signal-bars strength-1';
            } catch (e) {
                // Connection might be lost
            }
        }

        function reconnect() {
            if (kvm.connected) {
                kvm.disconnect();
            }
            setTimeout(() => toggleConnection(), 100);
        }

        // Hook into existing connection change
        const originalOnConnectionChange = kvm.onConnectionChange;
        kvm.onConnectionChange = (connected) => {
            originalOnConnectionChange(connected);
            updateConnectionStatus(connected);
        };

        // Scripts
        let scripts = JSON.parse(localStorage.getItem('scripts')) || {
            1: 'type Hello World\ndelay 500\nkey enter',
            2: '',
            3: ''
        };
        let scriptRunning = false;

        function loadScript() {
            const slot = document.getElementById('scriptSlot').value;
            document.getElementById('scriptEditor').value = scripts[slot] || '';
            log('Script ' + slot + ' loaded', 'info');
        }

        function saveScript() {
            const slot = document.getElementById('scriptSlot').value;
            scripts[slot] = document.getElementById('scriptEditor').value;
            localStorage.setItem('scripts', JSON.stringify(scripts));
            log('Script ' + slot + ' saved', 'info');
        }

        async function runScript() {
            if (!kvm.connected) {
                log('Connect first', 'error');
                return;
            }
            if (scriptRunning) {
                scriptRunning = false;
                log('Script stopped', 'info');
                return;
            }

            const script = document.getElementById('scriptEditor').value;
            const lines = script.split('\n').filter(l => l.trim());

            if (!lines.length) {
                log('Script is empty', 'error');
                return;
            }

            scriptRunning = true;
            const runBtn = document.getElementById('runScriptBtn');
            runBtn.textContent = 'Stop';
            runBtn.classList.remove('green');
            runBtn.classList.add('red');
            log('Script running...', 'info');

            for (const line of lines) {
                if (!scriptRunning) break;

                const parts = line.trim().split(/\s+/);
                const cmd = parts[0].toLowerCase();
                const args = parts.slice(1).join(' ');

                try {
                    switch (cmd) {
                        case 'type':
                            await kvm.typeText(args);
                            flashLed('ledTx');
                            break;
                        case 'key':
                            await kvm.sendKey(args.toLowerCase());
                            flashLed('ledTx');
                            break;
                        case 'combo':
                            const keys = args.toLowerCase().split('+').map(k => k.trim());
                            await kvm.sendKeyCombo(keys);
                            flashLed('ledTx');
                            break;
                        case 'delay':
                        case 'wait':
                            await new Promise(r => setTimeout(r, parseInt(args) || 100));
                            break;
                        case 'click':
                            await kvm.click(args || 'left');
                            flashLed('ledTx');
                            break;
                        case 'move':
                            const [x, y] = args.split(/[,\s]+/).map(n => parseInt(n) || 0);
                            await kvm.moveMouse(x, y);
                            flashLed('ledTx');
                            break;
                        case 'log':
                            log(args, 'info');
                            break;
                        default:
                            log('Unknown command: ' + cmd, 'error');
                    }
                } catch (e) {
                    log('Script error: ' + e.message, 'error');
                    break;
                }

                // Small delay between commands
                await new Promise(r => setTimeout(r, 20));
            }

            scriptRunning = false;
            runBtn.textContent = 'Run';
            runBtn.classList.remove('red');
            runBtn.classList.add('green');
            log('Script finished', 'info');
        }

        // Load first script slot on init
        document.getElementById('scriptEditor').value = scripts[1] || '';

        // Display control (Cardputer screen)
        let displayMode = 'on';
        const dispTimeoutSlider = document.getElementById('dispTimeout');
        const dispTimeoutVal = document.getElementById('dispTimeoutVal');

        dispTimeoutSlider.addEventListener('input', async () => {
            const val = parseInt(dispTimeoutSlider.value);
            dispTimeoutVal.textContent = val === 0 ? 'Never' : val + 's';
            if (kvm.connected) {
                try {
                    await kvm.setDisplayTimeout(val);
                    flashLed('ledTx');
                    log('Display timeout: ' + (val === 0 ? 'disabled' : val + 's'), 'send');
                } catch (e) {
                    log('Timeout error: ' + e.message, 'error');
                }
            }
        });

        async function setDisplay(mode) {
            displayMode = mode;

            // Update button states
            document.getElementById('dispOff').classList.remove('red');
            document.getElementById('dispDim').classList.remove('amber');
            document.getElementById('dispOn').classList.remove('blue');

            if (mode === 'off') {
                document.getElementById('dispOff').classList.add('red');
            } else if (mode === 'dim') {
                document.getElementById('dispDim').classList.add('amber');
            } else {
                document.getElementById('dispOn').classList.add('blue');
            }

            if (kvm.connected) {
                try {
                    await kvm.setDisplayBrightness(mode);
                    flashLed('ledTx');
                    log('Display: ' + mode.toUpperCase(), 'send');
                } catch (e) {
                    log('Display error: ' + e.message, 'error');
                }
            } else {
                log('Connect first', 'error');
            }
        }

        async function recoverUsb() {
            if (kvm.connected) {
                try {
                    log('USB Recovery - attempting...', 'send');
                    await kvm.recoverUsb();
                    flashLed('ledTx');
                    log('USB Recovery sent (may reset device)', 'info');
                } catch (e) {
                    log('USB Recovery error: ' + e.message, 'error');
                }
            } else {
                log('Connect first', 'error');
            }
        }

        async function resetDevice() {
            if (kvm.connected) {
                if (confirm('Reset the Cardputer device?\n\nBLE connection will be lost.')) {
                    try {
                        log('Resetting device...', 'send');
                        await kvm.resetDevice();
                        flashLed('ledTx');
                        log('Reset command sent', 'info');
                    } catch (e) {
                        // Expected - connection will drop
                        log('Device resetting...', 'info');
                    }
                }
            } else {
                log('Connect first', 'error');
            }
        }

        // Help modal
        const helpContent = {
            scripts: {
                title: 'Script Commands',
                body: `
                    <h3>Text & Keys</h3>
                    <div class="cmd-row"><span class="cmd-name">type &lt;text&gt;</span><span class="cmd-desc">Type text characters</span></div>
                    <div class="cmd-row"><span class="cmd-name">key &lt;key&gt;</span><span class="cmd-desc">Press a single key</span></div>
                    <div class="cmd-row"><span class="cmd-name">combo &lt;k+k&gt;</span><span class="cmd-desc">Key combination</span></div>

                    <h3>Mouse</h3>
                    <div class="cmd-row"><span class="cmd-name">click &lt;btn&gt;</span><span class="cmd-desc">left, right, or middle</span></div>
                    <div class="cmd-row"><span class="cmd-name">move &lt;x&gt; &lt;y&gt;</span><span class="cmd-desc">Move mouse relative</span></div>

                    <h3>Timing</h3>
                    <div class="cmd-row"><span class="cmd-name">delay &lt;ms&gt;</span><span class="cmd-desc">Wait milliseconds</span></div>

                    <h3>Modifiers</h3>
                    <code>ctrl</code> <code>alt</code> <code>shift</code> <code>gui</code>

                    <h3>Examples</h3>
                    <code>type Hello World</code><br>
                    <code>combo ctrl+alt+delete</code><br>
                    <code>delay 1000</code><br>
                    <code>key enter</code>
                `
            },
            macros: {
                title: 'Macros Help',
                body: `
                    <h3>Quick Actions</h3>
                    <div class="cmd-row"><span class="cmd-name">Click</span><span class="cmd-desc">Play the macro</span></div>
                    <div class="cmd-row"><span class="cmd-name">Right-click</span><span class="cmd-desc">Edit the macro</span></div>

                    <h3>Editing</h3>
                    Macros store plain text that gets typed when played.
                    <br><br>
                    1. Right-click a macro button (or select slot)<br>
                    2. Type your text in the editor<br>
                    3. Click <code>Set</code> to save

                    <h3>Tips</h3>
                    ‚Ä¢ Great for passwords, emails, signatures<br>
                    ‚Ä¢ Use Scripts for complex automation<br>
                    ‚Ä¢ Macros persist in browser storage
                `
            },
            jiggler: {
                title: 'Keep Awake',
                body: `
                    <h3>Jiggler</h3>
                    Moves mouse periodically to prevent the <strong>target</strong> PC from sleeping or locking.
                    <br><br>
                    <div class="cmd-row"><span class="cmd-name">Range</span><span class="cmd-desc">Pixels to move (back and forth)</span></div>
                    <div class="cmd-row"><span class="cmd-name">Interval</span><span class="cmd-desc">Seconds between jiggles (¬±20% random)</span></div>

                    <h3>Wake Lock</h3>
                    Prevents the <strong>controller</strong> screen from dimming while jacked in.
                    <br><br>
                    Uses the Screen Wake Lock API to keep your browser's display awake during capture or seamless mode.

                    <h3>Summary</h3>
                    ‚Ä¢ <strong>Jiggler</strong> ‚Üí keeps <em>target</em> awake<br>
                    ‚Ä¢ <strong>Wake Lock</strong> ‚Üí keeps <em>controller</em> awake
                `
            },
            pendant: {
                title: 'Control Pendant',
                body: `
                    <h3>Overview</h3>
                    Floating always-on-top mini control panel using Document Picture-in-Picture API.
                    Perfect for seamless mode when the main window is hidden.

                    <h3>Header</h3>
                    <div class="cmd-row"><span class="cmd-name">LEDs</span><span class="cmd-desc">Link (green), TX (blue), RX (amber)</span></div>
                    <div class="cmd-row"><span class="cmd-name">Modifiers</span><span class="cmd-desc">Shows active Shift/Ctrl/Alt/Win</span></div>

                    <h3>Status Bar</h3>
                    <div class="cmd-row"><span class="cmd-name">IDLE</span><span class="cmd-desc">Lit when jiggler is active</span></div>
                    <div class="cmd-row"><span class="cmd-name">CMDM</span><span class="cmd-desc">Lit when CapsLock command mode active</span></div>

                    <h3>Quick Actions</h3>
                    <div class="cmd-row"><span class="cmd-name">Esc</span><span class="cmd-desc">Send Escape key</span></div>
                    <div class="cmd-row"><span class="cmd-name">Lck</span><span class="cmd-desc">Lock target (Win+L)</span></div>
                    <div class="cmd-row"><span class="cmd-name">Slp</span><span class="cmd-desc">Sleep target PC</span></div>
                    <div class="cmd-row"><span class="cmd-name">Wke</span><span class="cmd-desc">Wake target PC</span></div>
                    <div class="cmd-row"><span class="cmd-name">CAD</span><span class="cmd-desc">Ctrl+Alt+Delete</span></div>

                    <h3>Numpad</h3>
                    4x4 grid for Win+Number shortcuts (quick launch taskbar apps).
                    <br><br>
                    <strong>Modifiers:</strong> Shft, Ctrl, Alt, Win toggle on/off.
                    Active modifiers shown in header and apply to next key.

                    <h3>Trackpad</h3>
                    Mini trackpad for mouse movement. Drag to move cursor on target.

                    <h3>Tips</h3>
                    ‚Ä¢ Resize pendant to show/hide sections<br>
                    ‚Ä¢ Reset size in Settings ‚Üí Display<br>
                    ‚Ä¢ Pendant floats above other windows
                `
            }
        };

        function showHelp(topic) {
            const help = helpContent[topic];
            if (!help) return;
            document.getElementById('helpTitle').textContent = help.title;
            document.getElementById('helpBody').innerHTML = help.body;
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelp(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('helpModal').classList.remove('active');
            }
        }

        // Close modal on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('helpModal').classList.contains('active')) {
                closeHelp();
            }
        });

        // Check for known devices on startup
        async function checkKnownDevices() {
            try {
                const devices = await RelayKVMAdapter.getKnownDevices();
                if (devices.length > 0) {
                    knownDevice = devices[0];
                    log('Known device found: ' + knownDevice.name, 'info');
                    const btn = document.getElementById('connectBtn');
                    btn.textContent = 'Quick Connect';
                    btn.title = 'Reconnect to ' + knownDevice.name;
                }
            } catch (e) {
                console.log('Could not check known devices:', e);
            }
        }

        checkKnownDevices();
        log('System ready', 'info');

        // ========== Document Picture-in-Picture Pendant ==========
        let dipWindow = null;

        // Check if Document DIP is supported
        const dipSupported = 'documentPictureInPicture' in window;
        if (dipSupported) {
            document.getElementById('dipBtn').style.display = '';
            document.getElementById('displaySection').style.display = '';
            // Show docked pendant by default
            document.getElementById('dockedPendant').style.display = '';
            // Apply calculated theme colors to docked pendant
            setTimeout(updatePendantTheme, 0);
        }

        function resetPendant() {
            if (dipWindow && !dipWindow.closed) {
                dipWindow.close();
                dipWindow = null;
            }
            // Show docked pendant
            document.getElementById('dockedPendant').style.display = '';
        }

        async function togglePendant() {
            // If DIP is open, close it and show docked
            if (dipWindow && !dipWindow.closed) {
                dipWindow.close();
                dipWindow = null;
                document.getElementById('dockedPendant').style.display = '';
                return;
            }
            // Toggle docked pendant visibility
            const docked = document.getElementById('dockedPendant');
            if (docked.style.display === 'none') {
                docked.style.display = '';
            } else {
                docked.style.display = 'none';
            }
        }

        async function openPendant() {
            if (!dipSupported) {
                log('Document DIP not supported', 'error');
                return;
            }

            // Hide docked pendant when opening DIP
            document.getElementById('dockedPendant').style.display = 'none';

            try {
                dipWindow = await documentPictureInPicture.requestWindow({
                    width: 320,
                    height: 220
                });

                // Get current theme colors from computed styles
                const cs = getComputedStyle(document.documentElement);
                const themeVars = {
                    bg: cs.getPropertyValue('--surface-base').trim() || '#0d0f12',
                    moduleBg: cs.getPropertyValue('--panel-bg').trim() || '#1a1d21',
                    panelInset: cs.getPropertyValue('--panel-inset').trim() || '#13161a',
                    displayBg: cs.getPropertyValue('--display-bg').trim() || '#0a0c0e',
                    text: cs.getPropertyValue('--text-normal').trim() || '#9aa0a6',
                    textDim: cs.getPropertyValue('--text-dim').trim() || '#5f6368',
                    border: cs.getPropertyValue('--panel-border').trim() || '#2a2d31',
                    accent: cs.getPropertyValue('--accent-primary').trim() || '#00b894',
                    accent2: cs.getPropertyValue('--accent-secondary').trim() || '#e17055',
                    pendantBtnBg: cs.getPropertyValue('--pendant-btn-bg').trim() || '#2a2d31',
                    pendantBtnText: cs.getPropertyValue('--pendant-btn-text').trim() || '#9aa0a6',
                    ledGreen: cs.getPropertyValue('--led-green').trim() || '#00ff66',
                    ledGreenDim: cs.getPropertyValue('--led-green-dim').trim() || '#004d1f',
                    ledAmber: cs.getPropertyValue('--led-amber').trim() || '#ffaa00',
                    ledAmberDim: cs.getPropertyValue('--led-amber-dim').trim() || '#4d3300',
                    ledBlue: cs.getPropertyValue('--led-blue').trim() || '#0099ff',
                    ledBlueDim: cs.getPropertyValue('--led-blue-dim').trim() || '#003366',
                    fnkeyBlueBg: cs.getPropertyValue('--fnkey-blue-bg').trim() || '#2a5a8a'
                };

                // Calculate theme-complementary trackpad color (light gray tinted with accent)
                const accentHex = themeVars.accent;
                const r = parseInt(accentHex.slice(1,3), 16);
                const g = parseInt(accentHex.slice(3,5), 16);
                const b = parseInt(accentHex.slice(5,7), 16);
                // Blend: 85% light gray (#c8c8c8) + 15% accent
                const tr = Math.round(200 * 0.85 + r * 0.15);
                const tg = Math.round(200 * 0.85 + g * 0.15);
                const tb = Math.round(200 * 0.85 + b * 0.15);
                themeVars.trackpad = `rgb(${tr}, ${tg}, ${tb})`;
                // Darker version for crosshair
                themeVars.trackpadDark = `rgb(${Math.round(tr*0.5)}, ${Math.round(tg*0.5)}, ${Math.round(tb*0.5)})`;

                // Copy styles with theme
                const style = document.createElement('style');
                style.id = 'pendant-theme';
                style.textContent = `
                    :root {
                        --led-green: ${themeVars.ledGreen};
                        --led-green-dim: ${themeVars.ledGreenDim};
                        --led-amber: ${themeVars.ledAmber};
                        --led-amber-dim: ${themeVars.ledAmberDim};
                        --led-blue: ${themeVars.ledBlue};
                        --led-blue-dim: ${themeVars.ledBlueDim};
                    }
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body {
                        font-family: 'IBM Plex Mono', 'Consolas', monospace;
                        font-size: 11px;
                        background: ${themeVars.bg};
                        color: ${themeVars.text};
                        padding: 10px;
                        height: 100vh;
                        display: flex;
                        flex-direction: column;
                        gap: 6px;
                        user-select: none;
                        overflow: hidden;
                    }
                    body.minimal-dip {
                        padding: 6px;
                        gap: 4px;
                    }
                    .header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding-bottom: 6px;
                        border-bottom: 1px solid ${themeVars.border};
                        margin-bottom: 2px;
                    }
                    .logo {
                        width: 18px;
                        height: 18px;
                    }
                    .header-left {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }
                    .help-btn {
                        padding: 0 4px;
                        font-size: 8px;
                        min-width: 14px;
                        height: 14px;
                        line-height: 12px;
                        flex: none;
                    }
                    .lcd-display {
                        flex: 1;
                        margin: 0 8px;
                        background: ${themeVars.trackpad};
                        color: ${themeVars.trackpadDark};
                        font-family: 'IBM Plex Mono', monospace;
                        font-size: 9px;
                        font-weight: bold;
                        letter-spacing: 1px;
                        padding: 3px 6px;
                        border-radius: 2px;
                        text-align: left;
                        box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
                        overflow: hidden;
                        white-space: nowrap;
                    }
                    .led-group {
                        display: flex;
                        gap: 3px;
                        align-items: center;
                    }
                    .status-row {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 2px 0;
                    }
                    .led {
                        width: 8px;
                        height: 8px;
                        border-radius: 50%;
                        background: ${themeVars.border};
                        border: 1px solid rgba(255,255,255,0.1);
                    }
                    .led.on { background: ${themeVars.accent}; box-shadow: 0 0 6px ${themeVars.accent}; }
                    .led.warn { background: #fdcb6e; box-shadow: 0 0 6px #fdcb6e; }
                    .led.error { background: ${themeVars.accent2}; box-shadow: 0 0 6px ${themeVars.accent2}; }
                    .led-group .led {
                        width: 6px;
                        height: 16px;
                        border-radius: 2px;
                        background: var(--led-green-dim);
                    }
                    .led-group .led.on {
                        background: var(--led-green);
                        box-shadow: 0 0 6px var(--led-green);
                    }
                    .led-group .led.blue { background: var(--led-blue-dim); }
                    .led-group .led.blue.on {
                        background: var(--led-blue);
                        box-shadow: 0 0 6px var(--led-blue);
                    }
                    .led-group .led.amber { background: var(--led-amber-dim); }
                    .led-group .led.amber.on {
                        background: var(--led-amber);
                        box-shadow: 0 0 6px var(--led-amber);
                    }
                    .label {
                        flex: 1;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        font-size: 9px;
                        color: ${themeVars.textDim};
                    }
                    .label.active { color: ${themeVars.text}; }
                    .buttons {
                        display: flex;
                        gap: 4px;
                        margin-top: auto;
                    }
                    button {
                        flex: 1;
                        padding: 5px 8px;
                        border: 1px solid ${themeVars.border};
                        background: ${themeVars.pendantBtnBg};
                        color: ${themeVars.pendantBtnText};
                        border-radius: 3px;
                        cursor: pointer;
                        font-family: inherit;
                        font-size: 9px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        transition: all 0.15s;
                    }
                    button:hover { border-color: ${themeVars.accent}; color: ${themeVars.accent}; }
                    button:active {
                        transform: scale(0.95);
                        filter: brightness(1.2);
                    }
                    button.active { border-color: ${themeVars.accent}; color: ${themeVars.accent}; background: rgba(0,184,148,0.1); }
                    button.danger { border-color: ${themeVars.accent2}; color: ${themeVars.accent2}; }
                    button.danger:hover { background: ${themeVars.accent2}; color: #fff; }
                    .stats {
                        font-size: 9px;
                        color: ${themeVars.textDim};
                        text-align: center;
                        letter-spacing: 1px;
                    }
                    .content-grid {
                        display: grid;
                        grid-template-columns: repeat(9, 1fr);
                        grid-template-rows: auto 1fr auto;
                        grid-template-areas:
                            "idl cmd cad esc lck slp wke ptl calc"
                            "track track track numpad numpad numpad numpad numpad numpad"
                            "dock dock dock jig jig jig conn conn conn";
                        gap: 4px;
                        flex: 1;
                    }
                    .mini-trackpad, .numpad {
                        min-height: 0;
                    }
                    .dip-idl { grid-area: idl; }
                    .dip-cmd { grid-area: cmd; }
                    .dip-cad { grid-area: cad; }
                    .dip-esc { grid-area: esc; }
                    .dip-lck { grid-area: lck; }
                    .dip-slp { grid-area: slp; }
                    .dip-wke { grid-area: wke; }
                    .dip-ptl { grid-area: ptl; }
                    .dip-calc { grid-area: calc; }
                    .mini-trackpad { grid-area: track; }
                    .numpad { grid-area: numpad; }
                    .dip-dock { grid-area: dock; }
                    .dip-jig { grid-area: jig; }
                    .dip-conn { grid-area: conn; }
                    .status-item {
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    }
                    .content-grid button {
                        padding: 2px 6px;
                        font-size: 8px;
                    }
                    .content-grid button:hover {
                        border-color: ${themeVars.accent};
                    }
                    .content-grid button.active {
                        background: ${themeVars.accent};
                        color: #fff;
                        border-color: ${themeVars.accent};
                    }
                    .dip-calc.rpn {
                        background: ${themeVars.ledAmber} !important;
                        color: #000 !important;
                        border-color: ${themeVars.ledAmber} !important;
                    }
                    .danger-action {
                        border-color: ${themeVars.accent2};
                        color: ${themeVars.accent2};
                    }
                    .danger-action:hover {
                        background: ${themeVars.accent2};
                        color: #fff;
                    }
                    .portal-btn {
                        background: ${themeVars.fnkeyBlueBg};
                        border-color: ${themeVars.fnkeyBlueBg};
                        color: #fff;
                    }
                    .portal-btn:hover {
                        filter: brightness(1.2);
                    }
                    .mini-trackpad {
                        min-height: 80px;
                        background: ${themeVars.trackpad};
                        border: 2px solid ${themeVars.border};
                        border-radius: 3px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: crosshair;
                        user-select: none;
                        touch-action: none;
                        box-shadow: inset 0 2px 6px rgba(0,0,0,0.5);
                        position: relative;
                    }
                    .mini-trackpad:hover {
                        border-color: ${themeVars.accent};
                    }
                    .mini-trackpad:active .trackpad-crosshair {
                        opacity: 0.8;
                        transform: translate(-50%, -50%) scale(1.1);
                        border-color: ${themeVars.accent};
                        color: ${themeVars.accent};
                    }
                    .mini-trackpad.captured {
                        border-color: ${themeVars.accent};
                        cursor: none;
                    }
                    .mini-trackpad.captured .trackpad-crosshair {
                        opacity: 0.9;
                        transform: translate(-50%, -50%) scale(1.2);
                        border-color: ${themeVars.accent};
                        color: ${themeVars.accent};
                    }
                    .trackpad-crosshair {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 18px;
                        height: 18px;
                        border: 1px solid ${themeVars.trackpadDark};
                        border-radius: 50%;
                        opacity: 0.6;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        color: ${themeVars.trackpadDark};
                        pointer-events: none;
                        transition: all 0.15s;
                    }
                    .numpad {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        grid-auto-rows: 1fr;
                        gap: 2px;
                        background: ${themeVars.panelInset};
                        border-radius: 3px;
                        padding: 4px;
                        box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
                    }
                    .numpad button {
                        padding: 4px 6px;
                        font-size: 9px;
                        font-weight: bold;
                        min-width: 0;
                        min-height: 0;
                        overflow: hidden;
                    }
                    .numpad button.mod {
                        font-size: 7px;
                        font-weight: normal;
                        color: ${themeVars.textDim};
                    }
                    .numpad button.mod.active {
                        background: ${themeVars.accent};
                        color: #fff;
                        border-color: ${themeVars.accent};
                    }
                    .numpad button.mod.calc-op {
                        font-size: 14px;
                        font-weight: bold;
                        color: ${themeVars.accent};
                    }
                    button.primary {
                        border-color: ${themeVars.accent};
                        color: ${themeVars.accent};
                    }
                    button.primary:hover {
                        background: ${themeVars.accent};
                        color: #fff;
                    }

                    /* Responsive adjustments via body classes */

                    /* Medium: Hide trackpad/numpad, reorganize to 4 columns */
                    body.medium-width .mini-trackpad,
                    body.medium-width .numpad {
                        display: none !important;
                    }
                    body.medium-width .content-grid {
                        grid-template-columns: repeat(4, 1fr);
                        grid-template-rows: auto auto auto;
                        grid-template-areas:
                            "idl cmd cad esc"
                            "lck slp wke ptl"
                            "dock jig calc conn";
                    }

                    /* Compact: Essential buttons only, 3 columns */
                    body.compact-width .mini-trackpad,
                    body.compact-width .numpad,
                    body.compact-width .dip-lck,
                    body.compact-width .dip-slp,
                    body.compact-width .dip-wke,
                    body.compact-width .dip-ptl,
                    body.compact-width .dip-calc,
                    body.compact-width .dip-cmd {
                        display: none !important;
                    }
                    body.compact-width .content-grid {
                        grid-template-columns: repeat(3, 1fr);
                        grid-template-rows: auto auto;
                        grid-template-areas:
                            "idl cad esc"
                            "dock jig conn";
                    }

                    /* Minimal: Just connect button */
                    body.minimal .mini-trackpad,
                    body.minimal .numpad,
                    body.minimal .dip-lck,
                    body.minimal .dip-slp,
                    body.minimal .dip-wke,
                    body.minimal .dip-ptl,
                    body.minimal .dip-calc,
                    body.minimal .dip-idl,
                    body.minimal .dip-cmd,
                    body.minimal .dip-cad,
                    body.minimal .dip-esc,
                    body.minimal .dip-dock,
                    body.minimal .dip-jig {
                        display: none !important;
                    }
                    body.minimal .content-grid {
                        grid-template-columns: 1fr;
                        grid-template-rows: auto;
                        grid-template-areas: "conn";
                    }
                    body.minimal .header-left { display: none; }
                    body.minimal .lcd-display { font-size: 9px; }

                    /* Height-based hiding */
                    body.compact-height .numpad,
                    body.compact-height .mini-trackpad { display: none !important; }

                    /* Minimal DIP: Trackpad left, 2x2 grid right - fits ~240x54 */
                    body.minimal-dip {
                        flex-direction: row;
                        align-items: stretch;
                        padding: 4px;
                        gap: 4px;
                    }
                    body.minimal-dip .header {
                        display: flex;
                        position: absolute;
                        top: 6px;
                        left: 6px;
                        padding: 0;
                        border: none;
                        margin: 0;
                        z-index: 10;
                    }
                    body.minimal-dip .header-left,
                    body.minimal-dip .lcd-display { display: none; }
                    body.minimal-dip .led-group {
                        gap: 2px;
                    }
                    body.minimal-dip .led-group .led {
                        width: 4px;
                        height: 8px;
                    }
                    body.minimal-dip .content-grid {
                        display: grid;
                        grid-template-columns: 1fr auto auto;
                        grid-template-rows: 1fr 1fr;
                        grid-template-areas:
                            "track wke slp"
                            "track conn conn";
                        gap: 3px;
                        flex: 1;
                    }
                    body.minimal-dip .mini-trackpad {
                        grid-area: track;
                        min-height: 0;
                        display: flex !important;
                    }
                    body.minimal-dip .mini-trackpad .trackpad-crosshair {
                        font-size: 10px;
                        width: 14px;
                        height: 14px;
                    }
                    body.minimal-dip .dip-wke {
                        grid-area: wke;
                        display: flex !important;
                        align-items: center;
                        justify-content: center;
                        padding: 2px 8px;
                        font-size: 8px;
                    }
                    body.minimal-dip .dip-slp {
                        grid-area: slp;
                        display: flex !important;
                        align-items: center;
                        justify-content: center;
                        padding: 2px 8px;
                        font-size: 8px;
                    }
                    body.minimal-dip .dip-conn {
                        grid-area: conn;
                        padding: 2px 8px;
                        font-size: 8px;
                    }
                    body.minimal-dip .numpad,
                    body.minimal-dip .dip-idl,
                    body.minimal-dip .dip-cmd,
                    body.minimal-dip .dip-cad,
                    body.minimal-dip .dip-esc,
                    body.minimal-dip .dip-lck,
                    body.minimal-dip .dip-ptl,
                    body.minimal-dip .dip-calc,
                    body.minimal-dip .dip-dock,
                    body.minimal-dip .dip-jig {
                        display: none !important;
                    }
                `;
                dipWindow.document.head.appendChild(style);
                dipWindow.document.title = 'RelayKVM';

                // Build content
                dipWindow.document.body.innerHTML = `
                    <div class="header">
                        <div class="header-left">
                            <svg class="logo" viewBox="0 0 128 128" width="18" height="18">
                                <rect x="12" y="16" width="64" height="64" rx="8" fill="${themeVars.accent}"/>
                                <rect x="52" y="48" width="64" height="64" rx="8" fill="${themeVars.accent2}"/>
                                <rect x="52" y="48" width="24" height="32" fill="#ffffff"/>
                            </svg>
                            <button class="help-btn" onclick="main.showHelp('pendant')" title="Help">?</button>
                        </div>
                        <div class="lcd-display" id="dipLcd">READY</div>
                        <div class="led-group">
                            <div class="led" id="dipLedLink" title="Link - Connected to device"></div>
                            <div class="led blue" id="dipLedTx" title="TX - Sending data"></div>
                            <div class="led amber" id="dipLedRx" title="RX - Receiving data"></div>
                        </div>
                    </div>
                    <div class="content-grid">
                        <div class="dip-idl status-item"><div class="led" id="dipDotJacked"></div><span class="label" id="dipStatusJacked">IDL</span></div>
                        <div class="dip-cmd status-item"><div class="led" id="dipDotCmd"></div><span class="label" id="dipStatusCmd">CMD</span></div>
                        <button class="dip-cad danger-action" onclick="main.sendCombo(['ctrl','alt','delete'])" title="Ctrl+Alt+Delete">CAD</button>
                        <button class="dip-esc" onclick="main.dpEscape()" title="Escape / Clear calc">Esc</button>
                        <button class="dip-lck" onclick="main.sendCombo(['gui','l'])" title="Lock (Win+L)">Lck</button>
                        <button class="dip-slp" onclick="main.sendSleep()" title="Sleep">Slp</button>
                        <button class="dip-wke" onclick="main.sendWake()" title="Wake">Wke</button>
                        <button class="dip-ptl portal-btn" onclick="main.openPortal()" title="Open Portal window">Ptl</button>
                        <button class="dip-calc" id="dipCalcBtn" onclick="main.toggleCalcMode()" title="Calculator mode - numpad becomes calculator">Calc</button>
                        <div class="mini-trackpad" id="dipTrackpad" title="Mini trackpad - drag to move mouse">
                            <span class="trackpad-crosshair">+</span>
                        </div>
                        <div class="numpad">
                            <button onclick="numpadKey('7')">7</button>
                            <button onclick="numpadKey('8')">8</button>
                            <button onclick="numpadKey('9')">9</button>
                            <button class="mod" id="modShift" onclick="toggleMod('shift')">Shft</button>
                            <button onclick="numpadKey('4')">4</button>
                            <button onclick="numpadKey('5')">5</button>
                            <button onclick="numpadKey('6')">6</button>
                            <button class="mod" id="modCtrl" onclick="toggleMod('ctrl')">Ctrl</button>
                            <button onclick="numpadKey('1')">1</button>
                            <button onclick="numpadKey('2')">2</button>
                            <button onclick="numpadKey('3')">3</button>
                            <button class="mod" id="modAlt" onclick="toggleMod('alt')">Alt</button>
                            <button onclick="numpadKey('0')">0</button>
                            <button onclick="numpadKey('.')">.</button>
                            <button onclick="numpadKey('enter')">‚Üµ</button>
                            <button class="mod" id="modGui" onclick="toggleMod('gui')">Win</button>
                        </div>
                        <button class="dip-dock" onclick="main.dockPendant()">Dock</button>
                        <button class="dip-jig primary" id="dipJigglerBtn" onclick="main.toggleJiggler()">Jig</button>
                        <button class="dip-conn primary" id="dipConnectBtn" onclick="main.toggleConnection()">Conn</button>
                    </div>
                `;

                // Set reference to main window (DIP doesn't have opener)
                dipWindow.main = window;

                // Numpad modifier state and functions
                dipWindow.numpadMods = { shift: false, ctrl: false, alt: false, gui: false };

                dipWindow.updateModDisplay = function() {
                    const mods = dipWindow.numpadMods;
                    const parts = [];
                    if (mods.ctrl) parts.push('Ctrl');
                    if (mods.shift) parts.push('Shift');
                    if (mods.alt) parts.push('Alt');
                    if (mods.gui) parts.push('Win');
                    const display = dipWindow.document.getElementById('dipMods');
                    display.textContent = parts.length ? parts.join('+') + '+' : '';
                };

                dipWindow.toggleMod = function(mod) {
                    if (calcMode) {
                        const opMap = { shift: '+', ctrl: '-', alt: '*', gui: '/' };
                        if (rpnMode) {
                            rpnOperate(opMap[mod]);
                        } else {
                            if (calcResult !== null) {
                                calcExpression = String(calcResult);
                                calcResult = null;
                            }
                            const displayOp = { shift: '+', ctrl: '-', alt: '√ó', gui: '√∑' };
                            if (calcExpression && !/[+\-√ó√∑]$/.test(calcExpression)) {
                                calcExpression += displayOp[mod];
                                updateCalcDisplay();
                            }
                        }
                        return;
                    }
                    dipWindow.numpadMods[mod] = !dipWindow.numpadMods[mod];
                    const btn = dipWindow.document.getElementById('mod' + mod.charAt(0).toUpperCase() + mod.slice(1));
                    btn.classList.toggle('active', dipWindow.numpadMods[mod]);
                    dipWindow.updateModDisplay();
                };

                dipWindow.numpadKey = function(key) {
                    if (calcMode) {
                        if (rpnMode) {
                            if (key === 'enter') {
                                rpnPush();
                            } else {
                                if (key === '.' && rpnEntry.includes('.')) return;
                                rpnEntry += key;
                                rpnHasEntry = true;
                                updateCalcDisplay();
                            }
                        } else {
                            if (key === 'enter') {
                                calcEvaluate();
                            } else {
                                if (calcResult !== null) {
                                    calcExpression = '';
                                    calcResult = null;
                                }
                                if (key === '.') {
                                    const lastOpIndex = Math.max(
                                        calcExpression.lastIndexOf('+'),
                                        calcExpression.lastIndexOf('-'),
                                        calcExpression.lastIndexOf('√ó'),
                                        calcExpression.lastIndexOf('√∑')
                                    );
                                    const currentNumber = calcExpression.slice(lastOpIndex + 1);
                                    if (currentNumber.includes('.')) return;
                                }
                                calcExpression += key;
                                updateCalcDisplay();
                            }
                        }
                        return;
                    }

                    const mods = dipWindow.numpadMods;
                    const combo = [];
                    if (mods.ctrl) combo.push('ctrl');
                    if (mods.shift) combo.push('shift');
                    if (mods.alt) combo.push('alt');
                    if (mods.gui) combo.push('gui');
                    combo.push(key);

                    if (combo.length > 1) {
                        dipWindow.main.sendCombo(combo);
                    } else {
                        dipWindow.main.kvm.sendKey(key);
                    }
                    dipWindow.main.flashLed('ledTx');
                };

                // Mini trackpad functionality with pointer lock (like main trackpad)
                const miniTrackpad = dipWindow.document.getElementById('dipTrackpad');
                let miniCaptured = false;
                let miniDragging = false;
                let miniMoved = 0;
                let miniButton = 0;

                miniTrackpad.addEventListener('mousedown', (e) => {
                    e.preventDefault();

                    // Request pointer lock for unlimited movement (even if disconnected for discoverability)
                    if (!miniCaptured) {
                        miniTrackpad.requestPointerLock();
                    }

                    const btnMap = { 0: 1, 1: 4, 2: 2 };
                    miniButton = btnMap[e.button] || 1;
                    miniMoved = 0;
                    miniDragging = true;
                });

                dipWindow.document.addEventListener('pointerlockchange', () => {
                    const wasCaptured = miniCaptured;
                    miniCaptured = dipWindow.document.pointerLockElement === miniTrackpad;
                    miniTrackpad.classList.toggle('captured', miniCaptured);
                    if (wasCaptured && !miniCaptured) {
                        miniDragging = false;
                    }
                });

                dipWindow.addEventListener('mousemove', (e) => {
                    if (!miniDragging || !miniCaptured) return;
                    const dx = e.movementX;
                    const dy = e.movementY;

                    const main = dipWindow.main;
                    if ((dx !== 0 || dy !== 0) && main.kvm && main.kvm.connected) {
                        main.kvm.moveMouse(Math.round(dx * 2), Math.round(dy * 2));
                        main.flashLed('ledTx');
                        miniMoved += Math.abs(dx) + Math.abs(dy);
                    }
                });

                miniTrackpad.addEventListener('mouseup', (e) => {
                    const main = dipWindow.main;

                    // If barely moved and connected, treat as click
                    if (miniMoved < 5 && main.kvm && main.kvm.connected) {
                        const btnName = { 1: 'left', 2: 'right', 4: 'middle' };
                        main.kvm.click(btnName[miniButton] || 'left');
                        main.flashLed('ledTx');
                    }

                    // Exit pointer lock (even if disconnected)
                    if (miniCaptured) {
                        dipWindow.document.exitPointerLock();
                    }
                    miniDragging = false;
                    miniButton = 0;
                });

                miniTrackpad.addEventListener('contextmenu', (e) => e.preventDefault());

                // Initial state sync
                syncPendantState();

                // Responsive behavior via window resize event (fires during drag)
                let resizeTimeout = null;
                function updatePendantLayout() {
                    const doc = dipWindow.document;
                    const body = doc.body;
                    const width = dipWindow.innerWidth;
                    const height = dipWindow.innerHeight;

                    // Toggle classes based on size (matching docked pendant breakpoints)
                    // Detect minimal DIP (at browser minimum PiP size ~240x54)
                    const isMinimalDip = height < 80;
                    body.classList.toggle('minimal-dip', isMinimalDip);

                    // Only apply other classes if not minimal-dip
                    if (!isMinimalDip) {
                        body.classList.toggle('medium-width', width < 280 && width >= 180);
                        body.classList.toggle('compact-width', width < 180 && width >= 120);
                        body.classList.toggle('minimal', width < 120);
                        body.classList.toggle('compact-height', height < 150);
                    } else {
                        body.classList.remove('medium-width', 'compact-width', 'minimal', 'compact-height');
                    }

                    // Show trackpad resolution in corner during resize
                    const trackpad = doc.getElementById('dipTrackpad');
                    let resLabel = doc.getElementById('dipTrackpadRes');
                    if (trackpad) {
                        const tw = trackpad.offsetWidth;
                        const th = trackpad.offsetHeight;
                        if (!resLabel) {
                            resLabel = doc.createElement('div');
                            resLabel.id = 'dipTrackpadRes';
                            resLabel.style.cssText = 'position:absolute;bottom:2px;right:2px;font-size:7px;opacity:0.5;pointer-events:none;font-family:monospace;';
                            trackpad.style.position = 'relative';
                            trackpad.appendChild(resLabel);
                        }
                        resLabel.textContent = `${tw}√ó${th}`;
                        resLabel.style.display = '';

                        // Hide after 1.5s of no resizing
                        clearTimeout(resizeTimeout);
                        resizeTimeout = setTimeout(() => {
                            if (resLabel) resLabel.style.display = 'none';
                        }, 1500);
                    }
                }
                dipWindow.addEventListener('resize', updatePendantLayout);
                updatePendantLayout(); // Initial check

                // Handle close - show docked pendant when DIP closes
                dipWindow.addEventListener('pagehide', () => {
                    dipWindow = null;
                    document.getElementById('dockedPendant').style.display = '';
                });

                // Keyboard input for calculator in DIP window
                dipWindow.addEventListener('keydown', (e) => {
                    if (calcHandleKey(e)) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });

                log('Pendant opened', 'info');
            } catch (err) {
                log('DIP error: ' + err.message, 'error');
            }
        }

        // ========== Docked Pendant ==========
        let dpNumpadMods = { shift: false, ctrl: false, alt: false, gui: false };
        let calcMode = false;
        let rpnMode = false;
        let calcExpression = '';
        let calcResult = null;
        // RPN state
        let rpnStack = [];
        let rpnEntry = '';
        let rpnHasEntry = false; // true when user is typing a new number
        let rpnLastX = null; // stores X before last operation

        function toggleCalcMode() {
            calcMode = !calcMode;
            calcExpression = '';
            calcResult = null;
            rpnStack = [];
            rpnEntry = '';
            rpnHasEntry = false;
            updateCalcModeUI();
            updateCalcDisplay();
        }

        function toggleRpnMode() {
            if (!calcMode) return;
            rpnMode = !rpnMode;
            // Reset state when switching modes
            calcExpression = '';
            calcResult = null;
            rpnStack = [];
            rpnEntry = '';
            rpnHasEntry = false;
            updateCalcModeUI();
            updateCalcDisplay();
        }

        function formatNumber(n) {
            if (typeof n !== 'number') return String(n);
            if (!Number.isFinite(n)) return 'ERR';
            if (Math.abs(n) > 999999999999) return n.toExponential(4);
            return String(Math.round(n * 100000000) / 100000000);
        }

        function updateCalcDisplay() {
            let display, leftPart = '', rightPart = '';

            if (rpnMode) {
                // RPN: stack info on left, X value on right
                const stackDepth = rpnStack.length;
                const xValue = rpnHasEntry ? rpnEntry : (stackDepth > 0 ? formatNumber(rpnStack[stackDepth - 1]) : '0');

                // Y value depends on whether we're typing:
                // - If typing: Y is top of stack (entry is X)
                // - If not typing: Y is second from top (top is X)
                let yValue = null;
                if (rpnHasEntry && stackDepth >= 1) {
                    yValue = formatNumber(rpnStack[stackDepth - 1]);
                } else if (!rpnHasEntry && stackDepth >= 2) {
                    yValue = formatNumber(rpnStack[stackDepth - 2]);
                }

                // Left part: show Y if available, otherwise stack depth or RPN
                if (yValue !== null) {
                    // Show Y value (truncated) with arrow indicating "Y op X"
                    const yStr = String(yValue).length > 6 ? String(yValue).slice(0, 5) + '‚Ä¶' : String(yValue);
                    leftPart = `${yStr}‚Üí`;
                } else if (stackDepth > 0 || rpnHasEntry) {
                    leftPart = `[${stackDepth + (rpnHasEntry ? 1 : 0)}]`;
                } else {
                    leftPart = 'RPN';
                }

                // Right part: X value with cursor if typing
                rightPart = xValue || '0';
                if (rpnHasEntry) {
                    rightPart += '_'; // Entry cursor
                }
                if (rightPart.length > 12) rightPart = rightPart.slice(-12);

                display = null; // We'll set innerHTML instead
            } else {
                // Normal infix mode
                display = calcResult !== null ? String(calcResult) : (calcExpression || '0');
                if (display.length > 20) display = display.slice(-20);
            }

            // Update docked pendant LCD
            const dpLcd = document.getElementById('dpLcd');
            if (dpLcd && calcMode) {
                if (rpnMode) {
                    dpLcd.innerHTML = `<span style="float:left;opacity:0.6">${leftPart}</span><span style="float:right">${rightPart}</span>`;
                } else {
                    dpLcd.textContent = display;
                }
            }
            // Update DIP pendant LCD
            if (dipWindow && !dipWindow.closed) {
                const dipLcd = dipWindow.document.getElementById('dipLcd');
                if (dipLcd && calcMode) {
                    if (rpnMode) {
                        dipLcd.innerHTML = `<span style="float:left;opacity:0.6">${leftPart}</span><span style="float:right">${rightPart}</span>`;
                    } else {
                        dipLcd.textContent = display;
                    }
                }
            }
        }

        function rpnPush() {
            // Push current entry to stack (or duplicate top if no entry)
            if (rpnHasEntry && rpnEntry) {
                const num = parseFloat(rpnEntry);
                if (!isNaN(num)) {
                    rpnStack.push(num);
                }
                rpnEntry = '';
                rpnHasEntry = false;
            } else if (rpnStack.length > 0) {
                // Duplicate top of stack
                rpnStack.push(rpnStack[rpnStack.length - 1]);
            }
            updateCalcDisplay();
        }

        function rpnOperate(op) {
            // If there's a pending entry, push it first
            if (rpnHasEntry && rpnEntry) {
                const num = parseFloat(rpnEntry);
                if (!isNaN(num)) {
                    rpnStack.push(num);
                }
                rpnEntry = '';
                rpnHasEntry = false;
            }

            if (rpnStack.length < 2) {
                // Not enough operands
                return;
            }

            const x = rpnStack.pop();
            const y = rpnStack.pop();
            rpnLastX = x; // Save X before operation

            let result;
            switch (op) {
                case '+': result = y + x; break;
                case '-': result = y - x; break;
                case '*': result = y * x; break;
                case '/': result = x !== 0 ? y / x : NaN; break;
                default: return;
            }

            rpnStack.push(result);
            updateCalcDisplay();
        }

        function rpnDrop() {
            if (rpnHasEntry) {
                rpnEntry = '';
                rpnHasEntry = false;
            } else if (rpnStack.length > 0) {
                rpnStack.pop();
            }
            updateCalcDisplay();
        }

        function rpnSwap() {
            if (rpnStack.length >= 2) {
                const x = rpnStack.pop();
                const y = rpnStack.pop();
                rpnStack.push(x);
                rpnStack.push(y);
                updateCalcDisplay();
            }
        }

        function rpnRollDown() {
            if (rpnStack.length >= 2) {
                const top = rpnStack.pop();
                rpnStack.unshift(top);
                updateCalcDisplay();
            }
        }

        function rpnRollUp() {
            if (rpnStack.length >= 2) {
                const bottom = rpnStack.shift();
                rpnStack.push(bottom);
                updateCalcDisplay();
            }
        }

        function rpnNegate() {
            // CHS - change sign
            if (rpnHasEntry && rpnEntry) {
                // Negate the entry string
                if (rpnEntry.startsWith('-')) {
                    rpnEntry = rpnEntry.slice(1);
                } else {
                    rpnEntry = '-' + rpnEntry;
                }
                updateCalcDisplay();
            } else if (rpnStack.length > 0) {
                // Negate top of stack
                rpnStack[rpnStack.length - 1] = -rpnStack[rpnStack.length - 1];
                updateCalcDisplay();
            }
        }

        function rpnClearX() {
            // CLx - clear X only (entry or top of stack)
            if (rpnHasEntry) {
                rpnEntry = '';
                rpnHasEntry = false;
            } else if (rpnStack.length > 0) {
                rpnStack[rpnStack.length - 1] = 0;
            }
            updateCalcDisplay();
        }

        function rpnRecallLastX() {
            // Recall LastX - push the saved X value
            if (rpnLastX !== null) {
                // If typing, push current entry first
                if (rpnHasEntry && rpnEntry) {
                    const num = parseFloat(rpnEntry);
                    if (!isNaN(num)) {
                        rpnStack.push(num);
                    }
                    rpnEntry = '';
                    rpnHasEntry = false;
                }
                rpnStack.push(rpnLastX);
                updateCalcDisplay();
            }
        }

        function rpnUnaryOp(fn) {
            // Apply a unary operation to X
            // If typing, use entry; otherwise use top of stack
            let x;
            if (rpnHasEntry && rpnEntry) {
                x = parseFloat(rpnEntry);
                rpnEntry = '';
                rpnHasEntry = false;
            } else if (rpnStack.length > 0) {
                x = rpnStack.pop();
            } else {
                return; // Nothing to operate on
            }

            rpnLastX = x;
            const result = fn(x);
            rpnStack.push(result);
            updateCalcDisplay();
        }

        function rpnSqrt() {
            rpnUnaryOp(x => Math.sqrt(x));
        }

        function rpnSquare() {
            rpnUnaryOp(x => x * x);
        }

        function rpnReciprocal() {
            rpnUnaryOp(x => x !== 0 ? 1 / x : NaN);
        }

        function rpnPercent() {
            // If there's a Y: calculate X% of Y, push result (Y stays)
            // If no Y: just divide X by 100
            let x;
            if (rpnHasEntry && rpnEntry) {
                x = parseFloat(rpnEntry);
                rpnEntry = '';
                rpnHasEntry = false;
            } else if (rpnStack.length > 0) {
                x = rpnStack.pop();
            } else {
                return;
            }

            rpnLastX = x;
            if (rpnStack.length > 0) {
                // Y exists: calculate X% of Y
                const y = rpnStack[rpnStack.length - 1]; // peek Y, don't pop
                rpnStack.push(y * x / 100);
            } else {
                // No Y: just X/100
                rpnStack.push(x / 100);
            }
            updateCalcDisplay();
        }

        function rpnPushPi() {
            // If typing, push entry first
            if (rpnHasEntry && rpnEntry) {
                const num = parseFloat(rpnEntry);
                if (!isNaN(num)) {
                    rpnStack.push(num);
                }
                rpnEntry = '';
                rpnHasEntry = false;
            }
            rpnStack.push(Math.PI);
            updateCalcDisplay();
        }

        function calcEvaluate() {
            if (rpnMode) {
                rpnPush();
                return;
            }
            if (!calcExpression) return;
            try {
                // Replace display operators with JS operators
                const expr = calcExpression.replace(/√ó/g, '*').replace(/√∑/g, '/');
                calcResult = eval(expr);
                // Handle floating point display
                if (typeof calcResult === 'number') {
                    if (!Number.isFinite(calcResult)) {
                        calcResult = 'ERR';
                    } else if (Math.abs(calcResult) > 999999999999) {
                        calcResult = calcResult.toExponential(4);
                    } else {
                        calcResult = Math.round(calcResult * 100000000) / 100000000;
                    }
                }
            } catch (e) {
                calcResult = 'ERR';
            }
            updateCalcDisplay();
        }

        function calcClear() {
            calcExpression = '';
            calcResult = null;
            rpnStack = [];
            rpnEntry = '';
            rpnHasEntry = false;
            rpnLastX = null;
            updateCalcDisplay();
        }

        function dpEscape() {
            if (calcMode) {
                calcClear();
            } else if (kvm && kvm.connected) {
                kvm.sendKey('escape');
                flashLed('ledTx');
            }
        }

        function calcBackspace() {
            if (calcResult !== null) {
                // After evaluation, backspace clears
                calcClear();
            } else if (calcExpression.length > 0) {
                calcExpression = calcExpression.slice(0, -1);
                updateCalcDisplay();
            }
        }

        function calcHandleKey(e) {
            // Don't intercept keys when jacked in - they should go to host
            if (!calcMode || isCapturing) return false;

            const key = e.key;

            // Toggle RPN mode with 'R'
            if (key === 'r' || key === 'R') {
                toggleRpnMode();
                return true;
            }

            // Clear (C only - Escape closes DIP window)
            if (key === 'c' || key === 'C') {
                calcClear();
                return true;
            }

            // RPN-specific handling
            if (rpnMode) {
                // Digits
                if (/^[0-9]$/.test(key)) {
                    rpnEntry += key;
                    rpnHasEntry = true;
                    updateCalcDisplay();
                    return true;
                }

                // Decimal point
                if (key === '.') {
                    if (!rpnEntry.includes('.')) {
                        rpnEntry += '.';
                        rpnHasEntry = true;
                        updateCalcDisplay();
                    }
                    return true;
                }

                // Operators - immediate execution in RPN
                if (['+', '-', '*', '/'].includes(key)) {
                    rpnOperate(key);
                    return true;
                }

                // Enter or Space - push to stack
                if (key === 'Enter' || key === ' ') {
                    rpnPush();
                    return true;
                }

                // Backspace - delete entry char or drop stack
                if (key === 'Backspace') {
                    if (rpnHasEntry && rpnEntry.length > 0) {
                        rpnEntry = rpnEntry.slice(0, -1);
                        if (rpnEntry === '') rpnHasEntry = false;
                        updateCalcDisplay();
                    } else {
                        rpnDrop();
                    }
                    return true;
                }

                // Delete - drop top of stack
                if (key === 'Delete') {
                    rpnDrop();
                    return true;
                }

                // Arrow keys - stack manipulation
                if (key === 'ArrowUp') {
                    rpnRollUp();
                    return true;
                }
                if (key === 'ArrowDown') {
                    rpnRollDown();
                    return true;
                }

                // Swap X and Y (S or Tab)
                if (key === 's' || key === 'S' || key === 'Tab') {
                    rpnSwap();
                    return true;
                }

                // Negate / CHS (N or _)
                if (key === 'n' || key === 'N' || key === '_') {
                    rpnNegate();
                    return true;
                }

                // LastX recall (L)
                if (key === 'l' || key === 'L') {
                    rpnRecallLastX();
                    return true;
                }

                // CLx - clear X only (D for "delete X")
                if (key === 'd' || key === 'D') {
                    rpnClearX();
                    return true;
                }

                // Square root (Q)
                if (key === 'q' || key === 'Q') {
                    rpnSqrt();
                    return true;
                }

                // Square (@ or ¬≤)
                if (key === '@' || key === '¬≤') {
                    rpnSquare();
                    return true;
                }

                // Reciprocal 1/x (I)
                if (key === 'i' || key === 'I') {
                    rpnReciprocal();
                    return true;
                }

                // Percent (%)
                if (key === '%') {
                    rpnPercent();
                    return true;
                }

                // Pi (P)
                if (key === 'p' || key === 'P') {
                    rpnPushPi();
                    return true;
                }

                return false;
            }

            // Normal infix mode handling
            // Digits
            if (/^[0-9]$/.test(key)) {
                if (calcResult !== null) {
                    calcExpression = '';
                    calcResult = null;
                }
                calcExpression += key;
                updateCalcDisplay();
                return true;
            }

            // Decimal point
            if (key === '.') {
                if (calcResult !== null) {
                    calcExpression = '0';
                    calcResult = null;
                }
                const lastOpIndex = Math.max(
                    calcExpression.lastIndexOf('+'),
                    calcExpression.lastIndexOf('-'),
                    calcExpression.lastIndexOf('√ó'),
                    calcExpression.lastIndexOf('√∑')
                );
                const currentNumber = calcExpression.slice(lastOpIndex + 1);
                if (!currentNumber.includes('.')) {
                    calcExpression += '.';
                    updateCalcDisplay();
                }
                return true;
            }

            // Operators
            if (['+', '-', '*', '/'].includes(key)) {
                if (calcResult !== null) {
                    calcExpression = String(calcResult);
                    calcResult = null;
                }
                if (calcExpression && !/[+\-√ó√∑]$/.test(calcExpression)) {
                    const opMap = { '+': '+', '-': '-', '*': '√ó', '/': '√∑' };
                    calcExpression += opMap[key];
                    updateCalcDisplay();
                }
                return true;
            }

            // Evaluate
            if (key === 'Enter' || key === '=') {
                calcEvaluate();
                return true;
            }

            // Backspace
            if (key === 'Backspace') {
                calcBackspace();
                return true;
            }

            return false;
        }

        function updateCalcModeUI() {
            // Update docked pendant
            const dpCalcBtn = document.getElementById('dpCalcBtn');
            if (dpCalcBtn) {
                dpCalcBtn.classList.toggle('active', calcMode);
                dpCalcBtn.classList.toggle('rpn', rpnMode);
                dpCalcBtn.textContent = rpnMode ? 'RPN' : 'Calc';
            }

            // Reset LCD when exiting calc mode
            const dpLcd = document.getElementById('dpLcd');
            if (dpLcd) {
                if (!calcMode) {
                    dpLcd.textContent = kvm && kvm.connected ? 'READY' : 'DISCONNECTED';
                    dpLcd.style.textAlign = '';
                }
            }

            const dpModLabels = {
                dpModShift: calcMode ? '+' : 'Shft',
                dpModCtrl: calcMode ? '‚àí' : 'Ctrl',
                dpModAlt: calcMode ? '√ó' : 'Alt',
                dpModGui: calcMode ? '√∑' : 'Win'
            };
            for (const [id, label] of Object.entries(dpModLabels)) {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.textContent = label;
                    btn.classList.toggle('calc-op', calcMode);
                }
            }

            // Update DIP pendant if open
            if (dipWindow && !dipWindow.closed) {
                const doc = dipWindow.document;
                const dipCalcBtn = doc.getElementById('dipCalcBtn');
                if (dipCalcBtn) {
                    dipCalcBtn.classList.toggle('active', calcMode);
                    dipCalcBtn.classList.toggle('rpn', rpnMode);
                    dipCalcBtn.textContent = rpnMode ? 'RPN' : 'Calc';
                }

                // Reset LCD when exiting calc mode
                const dipLcd = doc.getElementById('dipLcd');
                if (dipLcd) {
                    if (!calcMode) {
                        dipLcd.textContent = kvm && kvm.connected ? 'READY' : 'DISCONNECTED';
                        dipLcd.style.textAlign = '';
                    }
                }

                const dipModLabels = {
                    modShift: calcMode ? '+' : 'Shft',
                    modCtrl: calcMode ? '‚àí' : 'Ctrl',
                    modAlt: calcMode ? '√ó' : 'Alt',
                    modGui: calcMode ? '√∑' : 'Win'
                };
                for (const [id, label] of Object.entries(dipModLabels)) {
                    const btn = doc.getElementById(id);
                    if (btn) {
                        btn.textContent = label;
                        btn.classList.toggle('calc-op', calcMode);
                    }
                }
            }
        }

        function showDockedPendant() {
            document.getElementById('dockedPendant').style.display = '';
        }

        function hideDockedPendant() {
            document.getElementById('dockedPendant').style.display = 'none';
        }

        async function popOutPendant() {
            hideDockedPendant();
            await openPendant();
        }

        function dockPendant() {
            if (dipWindow && !dipWindow.closed) {
                dipWindow.close();
                dipWindow = null;
            }
            showDockedPendant();
        }

        function dpToggleMod(mod) {
            if (calcMode) {
                const opMap = { shift: '+', ctrl: '-', alt: '*', gui: '/' };
                if (rpnMode) {
                    // RPN: execute operator immediately
                    rpnOperate(opMap[mod]);
                } else {
                    // Infix: add operator to expression
                    if (calcResult !== null) {
                        calcExpression = String(calcResult);
                        calcResult = null;
                    }
                    const displayOp = { shift: '+', ctrl: '-', alt: '√ó', gui: '√∑' };
                    if (calcExpression && !/[+\-√ó√∑]$/.test(calcExpression)) {
                        calcExpression += displayOp[mod];
                        updateCalcDisplay();
                    }
                }
                return;
            }
            dpNumpadMods[mod] = !dpNumpadMods[mod];
            const btn = document.getElementById('dpMod' + mod.charAt(0).toUpperCase() + mod.slice(1));
            btn.classList.toggle('active', dpNumpadMods[mod]);
        }

        function dpNumpadKey(key) {
            // In calc mode, handle locally
            if (calcMode) {
                if (rpnMode) {
                    // RPN mode
                    if (key === 'enter') {
                        rpnPush();
                    } else {
                        // Append digit or decimal
                        if (key === '.' && rpnEntry.includes('.')) return;
                        rpnEntry += key;
                        rpnHasEntry = true;
                        updateCalcDisplay();
                    }
                } else {
                    // Infix mode
                    if (key === 'enter') {
                        calcEvaluate();
                    } else {
                        if (calcResult !== null) {
                            calcExpression = '';
                            calcResult = null;
                        }
                        if (key === '.') {
                            const lastOpIndex = Math.max(
                                calcExpression.lastIndexOf('+'),
                                calcExpression.lastIndexOf('-'),
                                calcExpression.lastIndexOf('√ó'),
                                calcExpression.lastIndexOf('√∑')
                            );
                            const currentNumber = calcExpression.slice(lastOpIndex + 1);
                            if (currentNumber.includes('.')) return;
                        }
                        calcExpression += key;
                        updateCalcDisplay();
                    }
                }
                return;
            }

            if (!kvm || !kvm.connected) return;

            const mods = dpNumpadMods;
            const modKeys = [];
            if (mods.ctrl) modKeys.push('ctrl');
            if (mods.shift) modKeys.push('shift');
            if (mods.alt) modKeys.push('alt');
            if (mods.gui) modKeys.push('gui');

            if (modKeys.length > 0) {
                modKeys.push(key);
                sendCombo(modKeys);
            } else {
                kvm.sendKey(key);
            }
            flashLed('ledTx');
        }

        // Docked pendant trackpad
        (function() {
            let dpCaptured = false;
            let dpDragging = false;
            let dpMoved = 0;
            let dpButton = 0;

            document.addEventListener('DOMContentLoaded', () => {
                const trackpad = document.getElementById('dpTrackpad');
                if (!trackpad) return;

                // Pointer lock on drag start (like main trackpad)
                trackpad.addEventListener('mousedown', (e) => {
                    e.preventDefault();

                    // Request pointer lock for unlimited movement (even if disconnected for discoverability)
                    if (!dpCaptured) {
                        trackpad.requestPointerLock();
                    }

                    const btnMap = { 0: 1, 1: 4, 2: 2 };
                    dpButton = btnMap[e.button] || 1;
                    dpMoved = 0;
                    dpDragging = true;
                });

                document.addEventListener('pointerlockchange', () => {
                    const wasCapture = dpCaptured;
                    dpCaptured = document.pointerLockElement === trackpad;
                    trackpad.classList.toggle('captured', dpCaptured);
                    if (wasCapture && !dpCaptured) {
                        dpDragging = false;
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (!dpDragging || !dpCaptured) return;
                    const dx = e.movementX;
                    const dy = e.movementY;

                    if ((dx !== 0 || dy !== 0) && kvm && kvm.connected) {
                        kvm.moveMouse(Math.round(dx * 2), Math.round(dy * 2));
                        flashLed('ledTx');
                        dpMoved += Math.abs(dx) + Math.abs(dy);
                    }
                });

                trackpad.addEventListener('mouseup', (e) => {
                    // If barely moved and connected, treat as click
                    if (dpMoved < 5 && kvm && kvm.connected) {
                        const btnName = { 1: 'left', 2: 'right', 4: 'middle' };
                        kvm.click(btnName[dpButton] || 'left');
                        flashLed('ledTx');
                    }

                    // Exit pointer lock (even if disconnected)
                    if (dpCaptured) {
                        document.exitPointerLock();
                    }
                    dpDragging = false;
                    dpButton = 0;
                });

                trackpad.addEventListener('contextmenu', (e) => e.preventDefault());

                // Keyboard input for calculator when pendant is focused
                const pendant = document.getElementById('dockedPendant');
                pendant.addEventListener('keydown', (e) => {
                    if (calcHandleKey(e)) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });

                // Make pendant focusable
                pendant.setAttribute('tabindex', '0');
            });
        })();

        // Sync docked pendant state
        // Helper to update element only if changed
        function setIf(el, prop, value) {
            if (el[prop] !== value) el[prop] = value;
        }
        function setStyleIf(el, prop, value) {
            if (el.style[prop] !== value) el.style[prop] = value;
        }

        // LCD feedback hold - prevents sync from overwriting feedback messages
        let lcdFeedbackUntil = 0;
        window.setLcdFeedback = function(msg, holdMs = 2000) {
            lcdFeedbackUntil = Date.now() + holdMs;
            const dpLcd = document.getElementById('dpLcd');
            if (dpLcd) dpLcd.textContent = msg;
            if (dipWindow && !dipWindow.closed) {
                const dipLcd = dipWindow.document.getElementById('dipLcd');
                if (dipLcd) dipLcd.textContent = msg;
            }
        };

        function syncDockedPendant() {
            const dp = document.getElementById('dockedPendant');
            if (!dp || dp.style.display === 'none') return;

            // Link LED
            const ledLink = document.getElementById('dpLedLink');
            const ledLinkClass = kvm && kvm.connected ? 'dp-led on' : 'dp-led';
            setIf(ledLink, 'className', ledLinkClass);

            // Jacked in status
            const dotJacked = document.getElementById('dpDotJacked');
            const statusJacked = document.getElementById('dpStatusJacked');
            setIf(dotJacked, 'className', isCapturing ? 'dp-dot on' : 'dp-dot');
            setIf(statusJacked, 'textContent', isCapturing ? 'ACT' : 'IDL');

            // Command mode
            const dotCmd = document.getElementById('dpDotCmd');
            const cmdActive = cmdModeBanner && cmdModeBanner.classList.contains('active');
            setIf(dotCmd, 'className', cmdActive ? 'dp-dot on' : 'dp-dot');

            // Jiggler button
            const jigglerBtn = document.getElementById('dpJigglerBtn');
            setIf(jigglerBtn, 'className', 'dp-jig dp-primary');
            setStyleIf(jigglerBtn, 'background', jigglerActive ? 'var(--accent-secondary)' : '');
            setStyleIf(jigglerBtn, 'color', jigglerActive ? '#fff' : '');
            setIf(jigglerBtn, 'textContent', jigglerActive ? 'Stop' : 'Jig');

            // Connect button
            const connectBtn = document.getElementById('dpConnectBtn');
            const connected = kvm && kvm.connected;
            setIf(connectBtn, 'className', 'dp-conn dp-primary');
            setStyleIf(connectBtn, 'background', connected ? 'var(--accent-secondary)' : '');
            setStyleIf(connectBtn, 'color', connected ? '#fff' : '');
            setIf(connectBtn, 'textContent', connected ? 'Drop' : 'Conn');

            // LCD (skip when in calc mode or feedback hold active)
            if (!calcMode && Date.now() >= lcdFeedbackUntil) {
                const lcd = document.getElementById('dpLcd');
                let lcdText = 'READY';
                if (connected) {
                    if (cmdActive) {
                        lcdText = 'CMD MODE';
                    } else if (jigglerActive) {
                        lcdText = 'JIGGLING';
                    } else if (isCapturing) {
                        lcdText = 'JACKED IN';
                    } else {
                        const modParts = [];
                        if (dpNumpadMods.ctrl) modParts.push('C');
                        if (dpNumpadMods.shift) modParts.push('S');
                        if (dpNumpadMods.alt) modParts.push('A');
                        if (dpNumpadMods.gui) modParts.push('W');
                        lcdText = modParts.length > 0 ? 'MOD: ' + modParts.join('+') : 'CONNECTED';
                    }
                }
                setIf(lcd, 'textContent', lcdText);
            }
        }

        // Sync both pendants periodically
        setInterval(syncDockedPendant, 200);

        function syncPendantState() {
            if (!dipWindow || dipWindow.closed) return;

            const doc = dipWindow.document;
            const connected = kvm && kvm.connected;
            const cmdActive = cmdModeBanner && cmdModeBanner.classList.contains('active');

            // Link LED
            const ledLink = doc.getElementById('dipLedLink');
            setIf(ledLink, 'className', connected ? 'led on' : 'led');

            // Jacked in status
            const dotJacked = doc.getElementById('dipDotJacked');
            const statusJacked = doc.getElementById('dipStatusJacked');
            setIf(dotJacked, 'className', isCapturing ? 'led warn' : 'led');
            setIf(statusJacked, 'className', isCapturing ? 'label active' : 'label');
            setIf(statusJacked, 'textContent', isCapturing ? 'ACT' : 'IDL');

            // Command mode
            const dotCmd = doc.getElementById('dipDotCmd');
            const statusCmd = doc.getElementById('dipStatusCmd');
            setIf(dotCmd, 'className', cmdActive ? 'led warn' : 'led');
            setIf(statusCmd, 'className', cmdActive ? 'label active' : 'label');

            // Jiggler button
            const jigglerBtn = doc.getElementById('dipJigglerBtn');
            setIf(jigglerBtn, 'className', jigglerActive ? 'dip-jig danger' : 'dip-jig primary');
            setIf(jigglerBtn, 'textContent', jigglerActive ? 'Stop' : 'Jig');

            // Connect/Drop button
            const connectBtn = doc.getElementById('dipConnectBtn');
            setIf(connectBtn, 'className', connected ? 'dip-conn danger' : 'dip-conn primary');
            setIf(connectBtn, 'textContent', connected ? 'Drop' : 'Conn');

            // LCD status display (skip when in calc mode or feedback hold active)
            if (!calcMode && Date.now() >= lcdFeedbackUntil) {
                const lcd = doc.getElementById('dipLcd');
                let lcdText = 'READY';
                if (connected) {
                    if (cmdActive) {
                        lcdText = 'CMD MODE';
                    } else if (jigglerActive) {
                        lcdText = 'JIGGLING';
                    } else if (isCapturing) {
                        lcdText = 'JACKED IN';
                    } else {
                        const mods = dipWindow.numpadMods;
                        const modParts = [];
                        if (mods && mods.ctrl) modParts.push('C');
                        if (mods && mods.shift) modParts.push('S');
                        if (mods && mods.alt) modParts.push('A');
                        if (mods && mods.gui) modParts.push('W');
                        lcdText = modParts.length > 0 ? 'MOD: ' + modParts.join('+') : 'CONNECTED';
                    }
                }
                setIf(lcd, 'textContent', lcdText);
            }
        }

        // Sync pendant periodically when open
        setInterval(() => {
            if (dipWindow && !dipWindow.closed) {
                syncPendantState();
            }
        }, 200);

        // Update pendant theme when main theme changes (both DIP and docked)
        function updatePendantTheme() {
            const cs = getComputedStyle(document.documentElement);
            const themeVars = {
                bg: cs.getPropertyValue('--surface-base').trim() || '#0d0f12',
                moduleBg: cs.getPropertyValue('--panel-bg').trim() || '#1a1d21',
                panelInset: cs.getPropertyValue('--panel-inset').trim() || '#13161a',
                displayBg: cs.getPropertyValue('--display-bg').trim() || '#0a0c0e',
                text: cs.getPropertyValue('--text-normal').trim() || '#9aa0a6',
                textDim: cs.getPropertyValue('--text-dim').trim() || '#5f6368',
                border: cs.getPropertyValue('--panel-border').trim() || '#2a2d31',
                accent: cs.getPropertyValue('--accent-primary').trim() || '#00b894',
                accent2: cs.getPropertyValue('--accent-secondary').trim() || '#e17055',
                pendantBtnBg: cs.getPropertyValue('--pendant-btn-bg').trim() || '#2a2d31',
                pendantBtnText: cs.getPropertyValue('--pendant-btn-text').trim() || '#9aa0a6',
                ledGreen: cs.getPropertyValue('--led-green').trim() || '#00ff66',
                ledGreenDim: cs.getPropertyValue('--led-green-dim').trim() || '#004d1f',
                ledAmber: cs.getPropertyValue('--led-amber').trim() || '#ffaa00',
                ledAmberDim: cs.getPropertyValue('--led-amber-dim').trim() || '#4d3300',
                ledBlue: cs.getPropertyValue('--led-blue').trim() || '#0099ff',
                ledBlueDim: cs.getPropertyValue('--led-blue-dim').trim() || '#003366'
            };

            // Calculate trackpad colors (85% light gray + 15% accent)
            const accentHex = themeVars.accent;
            const r = parseInt(accentHex.slice(1,3), 16);
            const g = parseInt(accentHex.slice(3,5), 16);
            const b = parseInt(accentHex.slice(5,7), 16);
            const tr = Math.round(200 * 0.85 + r * 0.15);
            const tg = Math.round(200 * 0.85 + g * 0.15);
            const tb = Math.round(200 * 0.85 + b * 0.15);
            themeVars.trackpad = `rgb(${tr}, ${tg}, ${tb})`;
            themeVars.trackpadDark = `rgb(${Math.round(tr*0.5)}, ${Math.round(tg*0.5)}, ${Math.round(tb*0.5)})`;

            // Update docked pendant
            const dpTrackpad = document.getElementById('dpTrackpad');
            const dpCrosshair = document.querySelector('.dp-crosshair');
            const dpNumpad = document.querySelector('.dp-numpad');
            const dpLcd = document.getElementById('dpLcd');

            if (dpTrackpad) {
                dpTrackpad.style.background = themeVars.trackpad;
                dpTrackpad.style.borderColor = themeVars.border;
            }
            if (dpCrosshair) {
                dpCrosshair.style.borderColor = themeVars.trackpadDark;
                dpCrosshair.style.color = themeVars.trackpadDark;
            }
            if (dpNumpad) {
                dpNumpad.style.background = themeVars.panelInset;
            }
            if (dpLcd) {
                dpLcd.style.background = themeVars.trackpad;
                dpLcd.style.color = themeVars.trackpadDark;
            }

            // Update DIP pendant if open
            if (!dipWindow || dipWindow.closed) return;

            const body = dipWindow.document.body;
            body.style.background = themeVars.bg;
            body.style.color = themeVars.text;

            const doc = dipWindow.document;
            doc.querySelector('.header').style.borderColor = themeVars.border;
            doc.querySelector('.mini-trackpad').style.background = themeVars.trackpad;
            doc.querySelector('.mini-trackpad').style.borderColor = themeVars.border;
            doc.querySelector('.trackpad-crosshair').style.borderColor = themeVars.trackpadDark;
            doc.querySelector('.trackpad-crosshair').style.color = themeVars.trackpadDark;
            doc.querySelector('.numpad').style.background = themeVars.panelInset;

            // Update logo colors
            const logoRects = doc.querySelectorAll('.logo rect');
            if (logoRects.length >= 2) {
                logoRects[0].setAttribute('fill', themeVars.accent);
                logoRects[1].setAttribute('fill', themeVars.accent2);
            }

            // Update LCD
            const lcd = doc.querySelector('.lcd-display');
            if (lcd) {
                lcd.style.background = themeVars.trackpad;
                lcd.style.color = themeVars.trackpadDark;
            }

            // Update buttons
            doc.querySelectorAll('button').forEach(btn => {
                if (!btn.classList.contains('primary') && !btn.classList.contains('danger') && !btn.classList.contains('danger-action')) {
                    btn.style.background = themeVars.pendantBtnBg;
                    btn.style.color = themeVars.pendantBtnText;
                }
            });

            // Update LED colors via CSS custom properties
            const dipStyle = doc.getElementById('pendant-theme');
            if (dipStyle) {
                dipStyle.textContent = dipStyle.textContent.replace(
                    /:root\s*\{[^}]*\}/,
                    `:root {
                        --led-green: ${themeVars.ledGreen};
                        --led-green-dim: ${themeVars.ledGreenDim};
                        --led-amber: ${themeVars.ledAmber};
                        --led-amber-dim: ${themeVars.ledAmberDim};
                        --led-blue: ${themeVars.ledBlue};
                        --led-blue-dim: ${themeVars.ledBlueDim};
                    }`
                );
            }
        }

        // ===== Cursed Gesture Detection (disabled by default) =====
        // Detects yank up/down and shake gestures on the DIP pendant
        // Note: Shake conflicts with Windows "Aero Shake" (minimize all)
        // TODO: Add setting toggle + sensitivity sliders if we want to enable this
        /*
        let dipLastX = 0, dipLastY = 0;
        let dipDragging = false;
        let dipGestureHistory = [];

        setInterval(() => {
            if (!dipWindow || dipWindow.closed) return;
            const x = dipWindow.screenX;
            const y = dipWindow.screenY;
            const dx = x - dipLastX;
            const dy = y - dipLastY;
            const moving = Math.abs(dx) > 2 || Math.abs(dy) > 2;

            if (moving && !dipDragging) {
                dipDragging = true;
                dipGestureHistory = [];
            } else if (!moving && dipDragging) {
                dipDragging = false;
                // Analyze gesture on drag end
                if (dipGestureHistory.length >= 5) {
                    let totalDy = 0, maxDy = 0;
                    for (const g of dipGestureHistory) {
                        totalDy += g.dy;
                        if (Math.abs(g.dy) > Math.abs(maxDy)) maxDy = g.dy;
                    }
                    if (maxDy > 30 && totalDy > 50) log('Gesture: YANK DOWN', 'info');
                    else if (maxDy < -30 && totalDy < -50) log('Gesture: YANK UP', 'info');
                    else {
                        let dirChanges = 0;
                        for (let i = 1; i < dipGestureHistory.length; i++) {
                            if (dipGestureHistory[i].dx * dipGestureHistory[i-1].dx < 0) dirChanges++;
                        }
                        if (dirChanges >= 4) log('Gesture: SHAKE', 'info');
                    }
                }
            }
            if (dipDragging) {
                dipGestureHistory.push({ dx, dy, t: Date.now() });
                if (dipGestureHistory.length > 20) dipGestureHistory.shift();
            }
            dipLastX = x;
            dipLastY = y;
        }, 50);
        */

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registered:', reg.scope))
                .catch(err => console.log('SW registration failed:', err));
        }
    </script>
</body>
</html>
