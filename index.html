<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RelayKVM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Industrial color palette */
            --panel-bg: #1a1d21;
            --panel-surface: #22262b;
            --panel-raised: #2a2f35;
            --panel-inset: #13161a;
            --panel-border: #0d0f12;

            /* Accent colors */
            --led-green: #00ff66;
            --led-green-dim: #004d1f;
            --led-red: #ff3333;
            --led-red-dim: #4d1010;
            --led-amber: #ffaa00;
            --led-amber-dim: #4d3300;
            --led-blue: #0099ff;
            --led-blue-dim: #003366;

            /* Text */
            --text-bright: #e8eaed;
            --text-normal: #9aa0a6;
            --text-dim: #5f6368;
            --text-label: #80868b;

            /* Display colors */
            --display-bg: #0a0c0e;
            --display-text: #00ff66;
            --display-text-dim: #006633;

            /* Bezels and borders */
            --bezel-light: #3a4045;
            --bezel-dark: #101214;
            --screw-color: #2a2f35;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            background: #0d0f12;
            color: var(--text-normal);
            min-height: 100vh;
            padding: 12px;
        }

        /* Main chassis */
        .chassis {
            width: 100%;
            min-height: calc(100vh - 24px);
            display: flex;
            flex-direction: column;
            background: var(--panel-bg);
            border: 3px solid var(--panel-border);
            border-radius: 4px;
            box-shadow:
                inset 0 1px 0 var(--bezel-light),
                0 8px 32px rgba(0,0,0,0.6),
                0 2px 4px rgba(0,0,0,0.4);
        }

        /* Top bezel with branding */
        .top-bezel {
            background: linear-gradient(180deg, var(--panel-raised) 0%, var(--panel-surface) 100%);
            border-bottom: 2px solid var(--panel-border);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .brand-logo {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-bright);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .brand-model {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            color: var(--text-dim);
            padding: 4px 8px;
            background: var(--panel-inset);
            border-radius: 2px;
        }

        .status-cluster {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        /* LED Indicators */
        .led-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .led-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        .led {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--led-green-dim);
            border: 1px solid rgba(0,0,0,0.5);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
            transition: all 0.15s;
        }

        .led.on {
            background: var(--led-green);
            box-shadow:
                inset 0 1px 2px rgba(255,255,255,0.3),
                0 0 8px var(--led-green),
                0 0 16px rgba(0,255,102,0.4);
        }

        .led.red { background: var(--led-red-dim); }
        .led.red.on {
            background: var(--led-red);
            box-shadow:
                inset 0 1px 2px rgba(255,255,255,0.3),
                0 0 8px var(--led-red),
                0 0 16px rgba(255,51,51,0.4);
        }

        .led.amber { background: var(--led-amber-dim); }
        .led.amber.on {
            background: var(--led-amber);
            box-shadow:
                inset 0 1px 2px rgba(255,255,255,0.3),
                0 0 8px var(--led-amber),
                0 0 16px rgba(255,170,0,0.4);
        }

        .led.blue { background: var(--led-blue-dim); }
        .led.blue.on {
            background: var(--led-blue);
            box-shadow:
                inset 0 1px 2px rgba(255,255,255,0.3),
                0 0 8px var(--led-blue),
                0 0 16px rgba(0,153,255,0.4);
        }

        /* Main panel area - horizontal layout */
        .main-panel {
            display: grid;
            grid-template-columns: minmax(350px, 1fr) minmax(600px, 1.5fr);
            padding: 12px;
            gap: 12px;
            flex: 1;
        }

        @media (max-width: 1100px) {
            .main-panel {
                grid-template-columns: 1fr;
            }
        }

        /* Left column: video panel */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Right column grid layout */
        .right-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            grid-template-rows: auto auto auto auto auto 1fr;
            grid-template-areas:
                "tinput tinput tinput tinput"
                "keys keys mouse mouse"
                "jiggler settings log log"
                "wakepower macros log log"
                "cardputer scripts log log"
                "modifiers scripts log log";
            gap: 10px;
            flex: 1;
        }

        .right-column .module {
            margin-bottom: 0;
        }

        .area-tinput { grid-area: tinput; }
        .area-keys { grid-area: keys; }
        .area-mouse { grid-area: mouse; display: flex; flex-direction: column; }
        .area-jiggler { grid-area: jiggler; }
        .area-settings { grid-area: settings; }
        .area-wakepower { grid-area: wakepower; }
        .area-cardputer { grid-area: cardputer; }
        .area-scripts { grid-area: scripts; display: flex; flex-direction: column; }
        .area-modifiers { grid-area: modifiers; }
        .area-macros { grid-area: macros; }
        .area-log { grid-area: log; display: flex; flex-direction: column; }

        /* Extras row: quick actions in compact grid */
        .extras-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .extras-row .module {
            margin-bottom: 0;
        }

        .section-header {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-label);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--panel-border);
        }

        /* Module containers */
        .module {
            background: var(--panel-inset);
            border: 1px solid var(--panel-border);
            border-radius: 3px;
            margin-bottom: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .module:last-child {
            margin-bottom: 0;
        }

        .module-header {
            background: var(--panel-surface);
            padding: 8px 12px;
            border-bottom: 1px solid var(--panel-border);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-label);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-body {
            padding: 10px;
        }

        /* Hardware buttons - industrial flat style */
        .hw-btn {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 10px 16px;
            background: #35393e;
            border: 1px solid var(--panel-border);
            border-radius: 3px;
            color: var(--text-normal);
            cursor: pointer;
            transition: all 0.1s;
        }

        .hw-btn:hover {
            background: #45494f;
            color: var(--text-bright);
        }

        .hw-btn:active {
            background: #282c30;
            transform: translateY(1px);
        }

        .hw-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .hw-btn.primary {
            background: #1a6040;
            border-color: #124030;
            color: #88ffaa;
        }

        .hw-btn.primary:hover {
            background: #227850;
        }

        .hw-btn.danger {
            background: #702020;
            border-color: #501515;
            color: #ffaaaa;
        }

        .hw-btn.danger:hover {
            background: #882828;
        }

        .hw-btn.large {
            padding: 16px 32px;
            font-size: 13px;
        }

        /* Seven-segment style display */
        .seg-display {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--display-bg);
            color: var(--display-text);
            padding: 8px 12px;
            border-radius: 2px;
            border: 1px solid var(--panel-border);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.6);
            font-size: 14px;
            font-weight: 500;
            text-shadow: 0 0 8px var(--display-text);
        }

        .seg-display.amber {
            color: var(--led-amber);
            text-shadow: 0 0 8px var(--led-amber);
        }

        .seg-display.dim {
            color: var(--display-text-dim);
            text-shadow: none;
        }

        /* Capture panel - video area */
        .capture-panel {
            background: var(--panel-inset);
            border: 2px solid var(--panel-border);
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            flex: 1;
            min-height: 250px;
        }

        /* Scanline effect for future video area */
        .capture-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 255, 102, 0.02) 2px,
                rgba(0, 255, 102, 0.02) 4px
            );
            pointer-events: none;
        }

        /* Grid pattern background */
        .capture-panel::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(rgba(0, 255, 102, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 102, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
        }

        .capture-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--led-amber);
            margin-bottom: 24px;
            position: relative;
            z-index: 1;
            padding: 4px 12px;
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid rgba(255, 170, 0, 0.3);
            border-radius: 2px;
        }

        .capture-btn-wrapper {
            position: relative;
            display: inline-block;
            z-index: 1;
        }

        .capture-btn {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 20px 48px;
            background: #1a6040;
            border: 2px solid #124030;
            border-radius: 4px;
            color: #88ffaa;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            z-index: 1;
        }

        .capture-btn:hover:not(:disabled) {
            background: #228050;
            color: #aaffcc;
        }

        .capture-btn:active:not(:disabled) {
            background: #145030;
            transform: translateY(2px);
        }

        .capture-btn:disabled {
            background: #2a2f35;
            border-color: var(--panel-border);
            color: var(--text-dim);
            cursor: not-allowed;
        }

        .capture-hint {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }

        .capture-hint kbd {
            background: var(--panel-surface);
            padding: 3px 6px;
            border-radius: 2px;
            border: 1px solid var(--panel-border);
        }

        /* Trackpad */
        .trackpad {
            background: var(--display-bg);
            border: 2px solid var(--panel-border);
            border-radius: 3px;
            height: 160px;
            cursor: crosshair;
            touch-action: none;
            position: relative;
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.6);
        }

        .trackpad::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 1px solid var(--text-dim);
            border-radius: 50%;
            opacity: 0.3;
        }

        .trackpad::after {
            content: '+';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-dim);
            font-size: 20px;
            opacity: 0.3;
        }

        /* Button grid */
        .btn-grid {
            display: grid;
            gap: 4px;
        }

        .btn-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
        .btn-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
        .btn-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }

        /* Function keys - Bloomberg Terminal style */
        .fn-key {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            padding: 6px 4px;
            background: var(--panel-surface);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            color: var(--text-normal);
            cursor: pointer;
            transition: all 0.1s;
        }

        .fn-key:hover {
            filter: brightness(1.2);
            color: var(--text-bright);
        }

        .fn-key:active {
            filter: brightness(0.9);
            transform: translateY(1px);
        }

        /* Industrial membrane keypad style - flat colors */
        .fn-key.red {
            background: #8b2525;
            border-color: #5c1818;
            color: #fff;
        }

        .fn-key.amber {
            background: #9a7b00;
            border-color: #6b5500;
            color: #fff;
        }

        .fn-key.green {
            background: #2a7a3a;
            border-color: #1a5528;
            color: #fff;
        }

        .fn-key.blue {
            background: #2a5a8a;
            border-color: #1a4060;
            color: #fff;
        }

        /* Text input */
        .text-input-row {
            display: flex;
            gap: 8px;
        }

        .text-input {
            flex: 1;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            padding: 10px 12px;
            background: var(--display-bg);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            color: var(--led-green);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }

        .text-input:focus {
            outline: none;
            border-color: var(--led-green-dim);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4), 0 0 8px rgba(0,255,102,0.1);
        }

        .text-input::placeholder {
            color: var(--text-dim);
        }

        /* Quick actions */
        .action-btn {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 10px 8px;
            background: var(--panel-surface);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            color: var(--text-normal);
            cursor: pointer;
            text-align: left;
            transition: all 0.1s;
        }

        .action-btn:hover {
            background: var(--panel-raised);
            color: var(--text-bright);
            filter: brightness(1.15);
        }

        .action-btn:active {
            filter: brightness(0.9);
            transform: translateY(1px);
        }

        .action-btn .shortcut {
            display: block;
            font-size: 8px;
            color: var(--text-dim);
            margin-top: 4px;
        }

        /* Industrial flat colored action buttons */
        .action-btn.red {
            background: #7a2020;
            border-color: #501515;
            color: #fff;
        }
        .action-btn.red .shortcut { color: #ffcccc; }

        .action-btn.amber {
            background: #806500;
            border-color: #584500;
            color: #fff;
        }
        .action-btn.amber .shortcut { color: #ffe088; }

        .action-btn.green {
            background: #256530;
            border-color: #184520;
            color: #fff;
        }
        .action-btn.green .shortcut { color: #aaffbb; }

        .action-btn.blue {
            background: #254a70;
            border-color: #18354a;
            color: #fff;
        }
        .action-btn.blue .shortcut { color: #aaddff; }

        /* Log display */
        .log-display {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            background: var(--display-bg);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            padding: 8px;
            overflow-y: auto;
            color: var(--display-text);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.5);
        }

        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid rgba(0,255,102,0.1);
        }

        .log-entry:last-child { border-bottom: none; }
        .log-entry .time { color: var(--text-dim); }
        .log-entry.error { color: var(--led-red); }
        .log-entry.send { color: var(--led-blue); }
        .log-entry.info { color: var(--led-amber); }

        /* Bottom bezel */
        .bottom-bezel {
            background: linear-gradient(180deg, var(--panel-surface) 0%, var(--panel-raised) 100%);
            border-top: 2px solid var(--panel-border);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bezel-text {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Screws decoration */
        .screw {
            width: 12px;
            height: 12px;
            background: var(--screw-color);
            border-radius: 50%;
            border: 1px solid var(--panel-border);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
            position: relative;
        }

        .screw::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 8px;
            height: 1px;
            background: var(--panel-border);
        }

        .screw::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            width: 8px;
            height: 1px;
            background: var(--panel-border);
        }

        /* Capture Overlay */
        #captureOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(10, 12, 14, 0.98);
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: none;
        }

        #captureOverlay.active {
            display: flex;
        }

        .overlay-content {
            text-align: center;
        }

        .overlay-indicator {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--led-green);
            margin: 0 auto 32px;
            box-shadow:
                0 0 40px var(--led-green),
                0 0 80px rgba(0,255,102,0.4),
                inset 0 -4px 12px rgba(0,0,0,0.3);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow:
                    0 0 40px var(--led-green),
                    0 0 80px rgba(0,255,102,0.4),
                    inset 0 -4px 12px rgba(0,0,0,0.3);
            }
            50% {
                box-shadow:
                    0 0 60px var(--led-green),
                    0 0 120px rgba(0,255,102,0.5),
                    inset 0 -4px 12px rgba(0,0,0,0.3);
            }
        }

        .overlay-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-bright);
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 8px;
        }

        .overlay-subtitle {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 48px;
        }

        .overlay-stats {
            display: flex;
            justify-content: center;
            gap: 48px;
        }

        .stat-block {
            text-align: center;
        }

        .stat-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 32px;
            font-weight: 700;
            color: var(--led-green);
            text-shadow: 0 0 20px var(--led-green);
        }

        .stat-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 4px;
        }

        .overlay-exit {
            position: absolute;
            bottom: 48px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .overlay-exit kbd {
            background: var(--panel-surface);
            color: var(--led-amber);
            padding: 8px 16px;
            border-radius: 3px;
            border: 1px solid var(--panel-border);
            margin: 0 8px;
        }

        .hardware-hint {
            color: var(--text-dim);
            font-size: 10px;
        }

        /* Sensitivity sliders */
        .sensitivity-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--display-bg);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .sensitivity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(180deg, #3a4045 0%, #2a2f35 50%, #22262b 100%);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            cursor: pointer;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .sensitivity-slider::-webkit-slider-thumb:hover {
            background: linear-gradient(180deg, #454b52 0%, #353a40 50%, #2a2f35 100%);
        }

        .sensitivity-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: linear-gradient(180deg, #3a4045 0%, #2a2f35 50%, #22262b 100%);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            cursor: pointer;
        }

        /* Radio button toggles */
        .radio-btn {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background: var(--panel-surface);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            cursor: pointer;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            transition: all 0.1s;
        }

        .radio-btn:hover {
            background: var(--panel-raised);
            color: var(--text-normal);
        }

        .radio-btn input[type="radio"] {
            display: none;
        }

        .radio-btn:has(input:checked) {
            background: #2a5a8a;
            border-color: #1a4060;
            color: #fff;
        }

        .radio-btn.wide {
            width: 100%;
            justify-content: center;
        }

        /* Off button gets amber when active */
        #radioOff:has(input:checked) {
            background: #9a7b00;
            border-color: #6b5500;
        }

        /* Video settings grid */
        .video-grid {
            display: grid;
            grid-template-columns: 54px 1fr;
            gap: 4px 8px;
            align-items: center;
        }

        .video-grid .radio-btn {
            width: 54px;
            justify-content: center;
        }

        .video-hint {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            color: var(--text-dim);
            font-style: italic;
        }

        /* Video controls disabled state */
        .video-grid .fn-key:disabled {
            background: var(--panel-inset);
            border-color: var(--panel-border);
            color: var(--text-dim);
            opacity: 0.5;
        }

        .video-grid .fn-key {
            width: 52px;
            text-align: center;
        }

        .video-params {
            transition: opacity 0.15s;
        }

        .video-params.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        /* Wake/Power grid layout */
        .wakepower-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            grid-template-rows: 1fr 1fr;
            grid-template-areas:
                "wake arm power"
                "usbwake arm power";
            gap: 4px;
            height: 100%;
        }

        .wakepower-grid .wake-btn:first-child { grid-area: wake; }
        .wakepower-grid .wake-btn:nth-child(2) { grid-area: usbwake; }
        .wakepower-grid .arm-btn { grid-area: arm; }
        .wakepower-grid .power-btn { grid-area: power; }

        /* Arm button - thin and tall */
        .arm-btn {
            width: 24px;
            background: var(--panel-inset);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-dim);
            transition: all 0.2s;
        }

        .arm-btn:hover {
            background: var(--panel-raised);
            color: var(--led-amber);
        }

        .arm-btn.armed {
            background: var(--led-amber);
            border-color: #ff8800;
            color: #000;
            box-shadow: 0 0 8px rgba(255, 170, 0, 0.5);
        }

        /* Power button - faded until armed */
        .power-btn {
            font-size: 11px;
            font-weight: bold;
            opacity: 0.3;
            transition: all 0.2s;
        }

        .power-btn.armed {
            opacity: 1;
            border: 2px solid #ff8800 !important;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.4);
        }

        /* Signal strength bars */
        .signal-bars {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 16px;
        }

        .signal-bars .bar {
            width: 4px;
            background: var(--panel-border);
            border-radius: 1px;
        }

        .signal-bars .bar:nth-child(1) { height: 4px; }
        .signal-bars .bar:nth-child(2) { height: 8px; }
        .signal-bars .bar:nth-child(3) { height: 12px; }
        .signal-bars .bar:nth-child(4) { height: 16px; }

        .signal-bars.strength-1 .bar:nth-child(1) { background: var(--led-red); }
        .signal-bars.strength-2 .bar:nth-child(1),
        .signal-bars.strength-2 .bar:nth-child(2) { background: var(--led-amber); }
        .signal-bars.strength-3 .bar:nth-child(1),
        .signal-bars.strength-3 .bar:nth-child(2),
        .signal-bars.strength-3 .bar:nth-child(3) { background: var(--led-green); }
        .signal-bars.strength-4 .bar { background: var(--led-green); }

        /* Script editor */
        .script-editor {
            flex: 1;
            min-height: 60px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            padding: 6px;
            background: var(--display-bg);
            border: 1px solid var(--panel-border);
            border-radius: 2px;
            color: var(--led-green);
            resize: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }

        .script-editor:focus {
            outline: none;
            border-color: var(--led-green-dim);
        }

        .script-editor::placeholder {
            color: var(--text-dim);
        }

        /* Help modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--panel-bg);
            border: 2px solid var(--panel-border);
            border-radius: 4px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        .modal-header {
            background: var(--panel-surface);
            padding: 10px 14px;
            border-bottom: 1px solid var(--panel-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-bright);
        }

        .modal-body {
            padding: 14px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            line-height: 1.6;
            color: var(--text-normal);
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-body h3 {
            color: var(--led-amber);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 12px 0 6px 0;
        }

        .modal-body h3:first-child {
            margin-top: 0;
        }

        .modal-body code {
            background: var(--panel-inset);
            padding: 2px 5px;
            border-radius: 2px;
            color: var(--led-green);
        }

        .modal-body .cmd-row {
            display: flex;
            gap: 8px;
            margin: 4px 0;
        }

        .modal-body .cmd-name {
            color: var(--led-blue);
            min-width: 80px;
        }

        .modal-body .cmd-desc {
            color: var(--text-dim);
        }

        /* Browser warning */
        .browser-warning {
            display: none;
            background: var(--led-red);
            color: white;
            padding: 12px;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body { padding: 6px; }
            .top-bezel { padding: 8px 12px; }
            .brand-model { display: none; }
            .capture-btn { padding: 14px 24px; font-size: 12px; }
            .panel-section { padding: 10px; }
            .fn-key { padding: 5px 3px; font-size: 9px; }
            .action-btn { padding: 8px 6px; font-size: 8px; }
        }
    </style>
</head>
<body>
    <div class="browser-warning" id="browserWarning">
        WEB BLUETOOTH NOT SUPPORTED — USE CHROME OR EDGE
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay" onclick="closeHelp(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span id="helpTitle">Help</span>
                <button class="fn-key" onclick="closeHelp()" style="padding: 4px 8px;">×</button>
            </div>
            <div class="modal-body" id="helpBody"></div>
        </div>
    </div>

    <!-- Capture Overlay -->
    <div id="captureOverlay">
        <div class="overlay-content">
            <div class="overlay-indicator"></div>
            <div class="overlay-title">Jacked In</div>
            <div class="overlay-subtitle">Direct control active</div>
            <div class="overlay-stats">
                <div class="stat-block">
                    <div class="stat-value" id="statMouse">0</div>
                    <div class="stat-label">Mouse</div>
                </div>
                <div class="stat-block">
                    <div class="stat-value" id="statClicks">0</div>
                    <div class="stat-label">Clicks</div>
                </div>
                <div class="stat-block">
                    <div class="stat-value" id="statKeys">0</div>
                    <div class="stat-label">Keys</div>
                </div>
            </div>
        </div>
        <div class="overlay-exit">
            Press <kbd id="exitKeyDisplay">ESC</kbd> to jack out <span class="hardware-hint">or press G on Cardputer</span>
        </div>
    </div>

    <!-- Main Chassis -->
    <div class="chassis">
        <!-- Top Bezel -->
        <div class="top-bezel">
            <div class="brand">
                <a href="https://github.com/endarthur/RelayKVM" target="_blank" style="text-decoration: none; color: inherit;" title="View on GitHub">
                    <span class="brand-logo">RelayKVM</span>
                </a>
                <span class="brand-model">BT-HID-01</span>
            </div>
            <div class="status-cluster">
                <div class="led-group">
                    <span class="led-label">Link</span>
                    <div class="led" id="ledLink"></div>
                </div>
                <div class="led-group">
                    <span class="led-label">TX</span>
                    <div class="led blue" id="ledTx"></div>
                </div>
                <div class="led-group">
                    <span class="led-label">RX</span>
                    <div class="led amber" id="ledRx"></div>
                </div>
                <button class="hw-btn primary" id="connectBtn" onclick="toggleConnection()">Connect</button>
            </div>
        </div>

        <!-- Main Panel -->
        <div class="main-panel">
            <!-- Left Column: Video Panel + Quick Actions -->
            <div class="left-column">
                <!-- Jack In Panel - video area -->
                <div class="capture-panel">
                    <div class="capture-title">No Signal</div>
                    <button class="capture-btn" id="captureBtn" onclick="startCapture()" disabled>
                        Jack In
                    </button>
                    <div class="capture-hint">Press <kbd id="exitKeyHint">ESC</kbd> to jack out</div>
                </div>

                <!-- Video Settings -->
                <div class="module">
                    <div class="module-header">
                        <span>Video</span>
                        <div class="led" id="ledVideo"></div>
                    </div>
                    <div class="module-body">
                        <div class="video-grid">
                            <!-- Off row -->
                            <label class="radio-btn" id="radioOff">
                                <input type="radio" name="videoMode" value="off" checked onchange="setVideoMode('off')">
                                <span>Off</span>
                            </label>
                            <span class="video-hint">No video capture</span>
                            <!-- USB row -->
                            <label class="radio-btn" id="radioUsb">
                                <input type="radio" name="videoMode" value="usb" onchange="setVideoMode('usb')">
                                <span>USB</span>
                            </label>
                            <div style="display: flex; gap: 4px;">
                                <select id="captureDevice" class="text-input" style="flex: 1; padding: 3px; font-size: 9px;" disabled>
                                    <option value="">Select device...</option>
                                </select>
                                <button class="fn-key green" id="startCaptureBtn" onclick="toggleCapture()" style="padding: 3px 8px; font-size: 9px;" disabled>Start</button>
                            </div>
                            <!-- WebRTC row -->
                            <label class="radio-btn" id="radioWebrtc">
                                <input type="radio" name="videoMode" value="webrtc" onchange="setVideoMode('webrtc')">
                                <span>RTC</span>
                            </label>
                            <div style="display: flex; gap: 4px;">
                                <input type="text" id="peerId" class="text-input" style="flex: 1; padding: 3px; font-size: 9px;" placeholder="Peer ID..." disabled>
                                <button class="fn-key green" id="connectPeerBtn" onclick="connectPeer()" style="padding: 3px 8px; font-size: 9px;" disabled>Connect</button>
                            </div>
                        </div>
                        <!-- Resolution/FPS row -->
                        <div id="videoParams" class="video-params disabled" style="display: flex; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--panel-border);">
                            <div style="flex: 1;">
                                <label class="led-label" style="font-size: 8px;">Resolution</label>
                                <select id="videoRes" class="text-input" style="width: 100%; padding: 3px; font-size: 9px;">
                                    <option value="1080">1080p</option>
                                    <option value="720" selected>720p</option>
                                    <option value="480">480p</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label class="led-label" style="font-size: 8px;">FPS</label>
                                <select id="videoFps" class="text-input" style="width: 100%; padding: 3px; font-size: 9px;">
                                    <option value="60">60</option>
                                    <option value="30" selected>30</option>
                                    <option value="15">15</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions below video -->
                <div class="extras-row" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="module">
                        <div class="module-header">System</div>
                        <div class="module-body">
                            <div class="btn-grid cols-2">
                                <button class="action-btn red" onclick="sendCombo(['ctrl', 'alt', 'delete'])">
                                    C+A+Del
                                    <span class="shortcut">Security</span>
                                </button>
                                <button class="action-btn" onclick="sendCombo(['ctrl', 'shift', 'escape'])">
                                    TaskMgr
                                    <span class="shortcut">C+S+Esc</span>
                                </button>
                                <button class="action-btn red" onclick="sendCombo(['alt', 'f4'])">
                                    Close
                                    <span class="shortcut">Alt+F4</span>
                                </button>
                                <button class="action-btn blue" onclick="sendCombo(['alt', 'tab'])">
                                    Switch
                                    <span class="shortcut">Alt+Tab</span>
                                </button>
                                <button class="action-btn amber" onclick="sendCombo(['gui', 'l'])">
                                    Lock
                                    <span class="shortcut">Win+L</span>
                                </button>
                                <button class="action-btn blue" onclick="sendCombo(['gui', 'd'])">
                                    Desktop
                                    <span class="shortcut">Win+D</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="module">
                        <div class="module-header">Clipboard</div>
                        <div class="module-body">
                            <div class="btn-grid cols-2">
                                <button class="action-btn green" onclick="sendCombo(['ctrl', 'c'])">
                                    Copy
                                    <span class="shortcut">Ctrl+C</span>
                                </button>
                                <button class="action-btn green" onclick="sendCombo(['ctrl', 'v'])">
                                    Paste
                                    <span class="shortcut">Ctrl+V</span>
                                </button>
                                <button class="action-btn" onclick="sendCombo(['ctrl', 'x'])">
                                    Cut
                                    <span class="shortcut">Ctrl+X</span>
                                </button>
                                <button class="action-btn" onclick="sendCombo(['ctrl', 'a'])">
                                    Sel All
                                    <span class="shortcut">Ctrl+A</span>
                                </button>
                                <button class="action-btn" onclick="sendCombo(['ctrl', 'z'])">
                                    Undo
                                    <span class="shortcut">Ctrl+Z</span>
                                </button>
                                <button class="action-btn" onclick="sendCombo(['ctrl', 'y'])">
                                    Redo
                                    <span class="shortcut">Ctrl+Y</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Grid layout -->
            <div class="right-column">
                <!-- Text Input -->
                <div class="module area-tinput">
                    <div class="module-header">Text Input</div>
                    <div class="module-body">
                        <div class="text-input-row">
                            <input type="text" class="text-input" id="textInput" placeholder="Type to send...">
                            <button class="hw-btn primary" id="sendTextBtn" onclick="sendText()" disabled>Send</button>
                        </div>
                    </div>
                </div>

                <!-- Function Keys -->
                <div class="module area-keys">
                    <div class="module-header">Function Keys</div>
                    <div class="module-body">
                        <!-- F-keys block -->
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 3px;">
                            <button class="fn-key red" onclick="sendKey('esc')">Esc</button>
                            <button class="fn-key amber" onclick="sendKey('f1')">F1</button>
                            <button class="fn-key amber" onclick="sendKey('f2')">F2</button>
                            <button class="fn-key amber" onclick="sendKey('f3')">F3</button>
                            <button class="fn-key amber" onclick="sendKey('f4')">F4</button>
                        </div>
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 3px;">
                            <button class="fn-key red" onclick="sendKey('delete')">Del</button>
                            <button class="fn-key amber" onclick="sendKey('f5')">F5</button>
                            <button class="fn-key amber" onclick="sendKey('f6')">F6</button>
                            <button class="fn-key amber" onclick="sendKey('f7')">F7</button>
                            <button class="fn-key amber" onclick="sendKey('f8')">F8</button>
                        </div>
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 12px;">
                            <button class="fn-key" onclick="sendKey('printscreen')">Prt</button>
                            <button class="fn-key amber" onclick="sendKey('f9')">F9</button>
                            <button class="fn-key amber" onclick="sendKey('f10')">F10</button>
                            <button class="fn-key amber" onclick="sendKey('f11')">F11</button>
                            <button class="fn-key amber" onclick="sendKey('f12')">F12</button>
                        </div>
                        <!-- Navigation block -->
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 3px;">
                            <button class="fn-key" onclick="sendKey('insert')">Ins</button>
                            <button class="fn-key blue" onclick="sendKey('home')">Home</button>
                            <button class="fn-key blue" onclick="sendKey('up')">↑</button>
                            <button class="fn-key blue" onclick="sendKey('end')">End</button>
                            <button class="fn-key" onclick="sendKey('backspace')">Bksp</button>
                        </div>
                        <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 12px;">
                            <button class="fn-key blue" onclick="sendKey('pageup')">PgUp</button>
                            <button class="fn-key blue" onclick="sendKey('left')">←</button>
                            <button class="fn-key blue" onclick="sendKey('down')">↓</button>
                            <button class="fn-key blue" onclick="sendKey('right')">→</button>
                            <button class="fn-key blue" onclick="sendKey('pagedown')">PgDn</button>
                        </div>
                        <!-- Action keys -->
                        <div class="btn-grid" style="grid-template-columns: 1fr 3fr 1fr;">
                            <button class="fn-key green" onclick="sendKey('tab')">Tab</button>
                            <button class="fn-key" onclick="sendKey('space')">Space</button>
                            <button class="fn-key green" onclick="sendKey('enter')">Enter</button>
                        </div>
                    </div>
                </div>

                <!-- Mouse -->
                <div class="module area-mouse">
                    <div class="module-header">
                        <span>Mouse</span>
                        <span class="seg-display dim" id="mouseCoords">0, 0</span>
                    </div>
                    <div class="module-body" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="trackpad" id="trackpad" style="flex: 1; height: auto; min-height: 120px;"></div>
                        <div class="btn-grid cols-3" style="margin-top: 8px;">
                            <button class="hw-btn" onclick="mouseClick('left')">L</button>
                            <button class="hw-btn" onclick="mouseClick('middle')">M</button>
                            <button class="hw-btn" onclick="mouseClick('right')">R</button>
                        </div>
                        <div class="btn-grid cols-2" style="margin-top: 4px;">
                            <button class="hw-btn" onclick="mouseScroll(scrollSensitivity)">▲</button>
                            <button class="hw-btn" onclick="mouseScroll(-scrollSensitivity)">▼</button>
                        </div>
                    </div>
                </div>

                <!-- Jiggler -->
                <div class="module area-jiggler">
                    <div class="module-header">
                        <span>Jiggler</span>
                        <div class="led" id="ledJiggler"></div>
                    </div>
                    <div class="module-body">
                        <button class="hw-btn" id="jigglerBtn" onclick="toggleJiggler()" style="width: 100%; margin-bottom: 8px; padding: 6px;">
                            Start
                        </button>
                        <div style="margin-bottom: 6px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <label class="led-label" style="font-size: 8px;">Range</label>
                                <span class="seg-display" style="padding: 1px 4px; font-size: 9px;" id="jigglerRangeVal">5</span>
                            </div>
                            <input type="range" id="jigglerRange" min="1" max="20" step="1" value="5" class="sensitivity-slider">
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <label class="led-label" style="font-size: 8px;">Interval</label>
                                <span class="seg-display" style="padding: 1px 4px; font-size: 9px;" id="jigglerIntervalVal">30</span>
                            </div>
                            <input type="range" id="jigglerInterval" min="1" max="120" step="1" value="30" class="sensitivity-slider">
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="module area-settings">
                    <div class="module-header">Settings</div>
                    <div class="module-body">
                        <div style="margin-bottom: 6px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <label class="led-label" style="font-size: 8px;">Mouse</label>
                                <span class="seg-display" style="padding: 1px 4px; font-size: 9px;" id="mouseSpeedVal">2.0x</span>
                            </div>
                            <input type="range" id="mouseSpeed" min="0.5" max="5" step="0.5" value="2" class="sensitivity-slider">
                        </div>
                        <div style="margin-bottom: 6px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <label class="led-label" style="font-size: 8px;">Scroll</label>
                                <span class="seg-display" style="padding: 1px 4px; font-size: 9px;" id="scrollSpeedVal">3</span>
                            </div>
                            <input type="range" id="scrollSpeed" min="1" max="10" step="1" value="3" class="sensitivity-slider">
                        </div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <label class="led-label" style="font-size: 8px;">Exit:</label>
                            <select id="exitKeySelect" class="text-input" style="padding: 2px 4px; font-size: 9px; flex: 1;">
                                <option value="Escape">ESC</option>
                                <option value="F12">F12</option>
                                <option value="ScrollLock">ScrLk</option>
                                <option value="Pause">Pause</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Wake/Power -->
                <div class="module area-wakepower">
                    <div class="module-header">
                        <span>Wake/Power</span>
                        <button class="fn-key" onclick="sendSleep()" style="padding: 2px 6px; font-size: 8px;" title="Windows: Win+X,U,S">Sleep</button>
                    </div>
                    <div class="module-body" style="padding: 6px;">
                        <div class="wakepower-grid">
                            <button class="fn-key green wake-btn" onclick="sendWake()">Wake</button>
                            <button class="fn-key wake-btn" onclick="sendUsbWake()" style="background: var(--panel-raised);">USB Wake</button>
                            <button class="arm-btn" id="powerArm" onclick="togglePowerArm()">⚠</button>
                            <button class="fn-key red power-btn" id="powerBtn" onclick="sendPower()">PWR</button>
                        </div>
                    </div>
                </div>

                <!-- Cardputer (device control) -->
                <div class="module area-cardputer">
                    <div class="module-header">
                        <span>Cardputer</span>
                        <span class="seg-display dim" id="connLatency" style="padding: 1px 4px; font-size: 9px;">--ms</span>
                    </div>
                    <div class="module-body">
                        <!-- Connection row -->
                        <div style="display: flex; gap: 4px; align-items: center; margin-bottom: 6px;">
                            <div class="signal-bars" id="signalBars">
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                            </div>
                            <span class="led-label" id="connStatus" style="flex: 1;">Disconnected</span>
                            <button class="fn-key" onclick="reconnect()" style="padding: 3px 6px; font-size: 8px;">Reconnect</button>
                        </div>
                        <!-- Display controls -->
                        <div class="btn-grid cols-3" style="margin-bottom: 6px;">
                            <button class="fn-key" id="dispOff" onclick="setDisplay('off')">Off</button>
                            <button class="fn-key" id="dispDim" onclick="setDisplay('dim')">Dim</button>
                            <button class="fn-key blue" id="dispOn" onclick="setDisplay('on')">On</button>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                            <label class="led-label" style="font-size: 8px;">Screen Timeout</label>
                            <span class="seg-display" style="padding: 1px 4px; font-size: 9px;" id="dispTimeoutVal">30s</span>
                        </div>
                        <input type="range" id="dispTimeout" min="0" max="300" step="10" value="30" class="sensitivity-slider">
                    </div>
                </div>

                <!-- Scripts -->
                <div class="module area-scripts">
                    <div class="module-header">
                        <span>Scripts</span>
                        <div style="display: flex; gap: 4px;">
                            <button class="fn-key" onclick="showHelp('scripts')" style="padding: 2px 6px; font-size: 8px;">?</button>
                            <button class="fn-key green" id="runScriptBtn" onclick="runScript()" style="padding: 2px 6px; font-size: 8px;">Run</button>
                        </div>
                    </div>
                    <div class="module-body" style="flex: 1; display: flex; flex-direction: column;">
                        <textarea id="scriptEditor" class="script-editor" placeholder="type Hello World&#10;delay 500&#10;key enter&#10;combo ctrl+s"></textarea>
                        <div style="display: flex; gap: 4px; margin-top: 4px;">
                            <select id="scriptSlot" class="text-input" style="width: 40px; padding: 2px; font-size: 9px;">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                            <button class="fn-key" onclick="loadScript()" style="padding: 2px 6px; font-size: 8px;">Load</button>
                            <button class="fn-key" onclick="saveScript()" style="padding: 2px 6px; font-size: 8px;">Save</button>
                        </div>
                    </div>
                </div>

                <!-- Modifiers -->
                <div class="module area-modifiers">
                    <div class="module-header">Modifiers</div>
                    <div class="module-body">
                        <div class="btn-grid cols-3" style="margin-bottom: 4px;">
                            <button class="fn-key" id="modCtrl" onclick="toggleModifier('ctrl')">Ctrl</button>
                            <button class="fn-key" id="modShift" onclick="toggleModifier('shift')">Shift</button>
                            <button class="fn-key" id="modAlt" onclick="toggleModifier('alt')">Meta</button>
                        </div>
                        <div class="btn-grid cols-2">
                            <button class="fn-key" id="modGui" onclick="toggleModifier('gui')">Super</button>
                            <button class="fn-key" id="modHyper" onclick="toggleHyper()">Hyper</button>
                        </div>
                    </div>
                </div>

                <!-- Macros -->
                <div class="module area-macros">
                    <div class="module-header">
                        <span>Macros</span>
                        <button class="fn-key" onclick="showHelp('macros')" style="padding: 2px 6px; font-size: 8px;">?</button>
                    </div>
                    <div class="module-body">
                        <div class="btn-grid cols-4" style="margin-bottom: 6px;">
                            <button class="fn-key" id="macroBtn1" onclick="playMacro(1)" oncontextmenu="editMacro(1, event)">1</button>
                            <button class="fn-key" id="macroBtn2" onclick="playMacro(2)" oncontextmenu="editMacro(2, event)">2</button>
                            <button class="fn-key" id="macroBtn3" onclick="playMacro(3)" oncontextmenu="editMacro(3, event)">3</button>
                            <button class="fn-key" id="macroBtn4" onclick="playMacro(4)" oncontextmenu="editMacro(4, event)">4</button>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <select id="macroSelect" class="text-input" style="width: 40px; padding: 4px; font-size: 10px;">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                            <input type="text" id="macroEdit" class="text-input" style="flex: 1; padding: 4px; font-size: 10px;" placeholder="Macro text...">
                            <button class="fn-key green" onclick="saveMacro()" style="padding: 4px 8px;">Set</button>
                        </div>
                    </div>
                </div>

                <!-- Log -->
                <div class="module area-log">
                    <div class="module-header">
                        <span>Log</span>
                        <button class="fn-key" onclick="clearLog()" style="padding: 2px 6px; font-size: 8px;">CLR</button>
                    </div>
                    <div class="module-body" style="padding: 0; flex: 1; display: flex; min-height: 0;">
                        <div class="log-display" id="log" style="flex: 1; min-height: 0;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Bezel -->
        <div class="bottom-bezel">
            <div class="bezel-text">Bluetooth HID Relay</div>
            <div style="display: flex; gap: 8px;">
                <div class="screw"></div>
                <div class="screw"></div>
            </div>
            <div class="bezel-text">v1.0</div>
        </div>
    </div>

    <script src="relaykvm-adapter.js"></script>
    <script>
        // ============================================
        // RelayKVM Industrial Controller
        // ============================================

        let kvm = null;
        let knownDevice = null;  // For quick reconnect
        let isDragging = false;
        let lastX = 0, lastY = 0;
        let txTimeout = null, rxTimeout = null;

        // Check browser support
        if (!RelayKVMAdapter.isSupported()) {
            document.getElementById('browserWarning').style.display = 'block';
        }

        // Sensitivity settings
        let mouseSensitivity = parseFloat(localStorage.getItem('mouseSensitivity')) || 2;
        let scrollSensitivity = parseInt(localStorage.getItem('scrollSensitivity')) || 3;

        const mouseSpeedSlider = document.getElementById('mouseSpeed');
        const mouseSpeedVal = document.getElementById('mouseSpeedVal');
        const scrollSpeedSlider = document.getElementById('scrollSpeed');
        const scrollSpeedVal = document.getElementById('scrollSpeedVal');

        // Initialize slider values
        mouseSpeedSlider.value = mouseSensitivity;
        mouseSpeedVal.textContent = mouseSensitivity.toFixed(1) + 'x';
        scrollSpeedSlider.value = scrollSensitivity;
        scrollSpeedVal.textContent = scrollSensitivity;

        mouseSpeedSlider.addEventListener('input', () => {
            mouseSensitivity = parseFloat(mouseSpeedSlider.value);
            mouseSpeedVal.textContent = mouseSensitivity.toFixed(1) + 'x';
            localStorage.setItem('mouseSensitivity', mouseSensitivity);
        });

        scrollSpeedSlider.addEventListener('input', () => {
            scrollSensitivity = parseInt(scrollSpeedSlider.value);
            scrollSpeedVal.textContent = scrollSensitivity;
            localStorage.setItem('scrollSensitivity', scrollSensitivity);
        });

        // Initialize adapter
        kvm = new RelayKVMAdapter();

        kvm.onConnectionChange = (connected) => {
            updateUI(connected);
            log(connected ? 'Link established' : 'Link down', 'info');
        };

        kvm.onDataReceived = (data) => {
            flashLed('ledRx');

            // Check for jack out command from device (G key)
            // Format: [0x57, 0xAB, 0x00, 0x80, 0x00, 0x00]
            if (data.length >= 4 && data[0] === 0x57 && data[1] === 0xAB && data[3] === 0x80) {
                log('Device: Jack out (G)', 'info');
                if (isCapturing) {
                    stopCapture();
                }
                return;
            }

            log('RX: ' + data.length + ' bytes', 'receive');
        };

        // LED flash helper
        function flashLed(id) {
            const led = document.getElementById(id);
            led.classList.add('on');
            clearTimeout(id === 'ledTx' ? txTimeout : rxTimeout);
            const timeout = setTimeout(() => led.classList.remove('on'), 100);
            if (id === 'ledTx') txTimeout = timeout;
            else rxTimeout = timeout;
        }

        // UI Updates
        function updateUI(connected) {
            const btn = document.getElementById('connectBtn');
            const ledLink = document.getElementById('ledLink');
            const sendTextBtn = document.getElementById('sendTextBtn');
            const captureBtn = document.getElementById('captureBtn');

            if (connected) {
                btn.textContent = 'Disconnect';
                btn.classList.remove('primary');
                btn.classList.add('danger');
                ledLink.classList.add('on');
                sendTextBtn.disabled = false;
                captureBtn.disabled = false;
            } else {
                btn.textContent = knownDevice ? 'Quick Connect' : 'Connect';
                btn.classList.remove('danger');
                btn.classList.add('primary');
                ledLink.classList.remove('on');
                sendTextBtn.disabled = true;
                captureBtn.disabled = true;
                if (isCapturing) stopCapture();
                if (jigglerActive) toggleJiggler(); // Stop jiggler on disconnect
            }
            btn.disabled = false;
        }

        async function toggleConnection() {
            const btn = document.getElementById('connectBtn');

            if (kvm.connected) {
                kvm.disconnect();
            } else {
                btn.disabled = true;
                btn.textContent = 'Connecting...';
                try {
                    if (knownDevice) {
                        // Quick reconnect to known device (no picker)
                        log('Quick connecting to ' + knownDevice.name + '...', 'info');
                        await kvm.reconnect(knownDevice);
                    } else {
                        // Show picker for new device
                        await kvm.connect();
                        // After successful connection, check for known devices again
                        checkKnownDevices();
                    }
                } catch (error) {
                    log('Error: ' + error.message, 'error');
                    updateUI(false);
                    // If quick connect failed, clear known device and try fresh
                    if (knownDevice) {
                        log('Quick connect failed, try regular Connect', 'info');
                        knownDevice = null;
                        btn.textContent = 'Connect';
                        btn.title = '';
                    }
                }
            }
        }

        // Keyboard
        async function sendText() {
            const input = document.getElementById('textInput');
            const text = input.value;
            if (text && kvm.connected) {
                flashLed('ledTx');
                log('TX: "' + text + '"', 'send');
                await kvm.typeText(text);
                input.value = '';
            }
        }

        async function sendKey(key) {
            if (kvm.connected) {
                flashLed('ledTx');
                log('TX: ' + key.toUpperCase(), 'send');
                await kvm.sendKey(key);
            }
        }

        async function sendCombo(keys) {
            if (kvm.connected) {
                flashLed('ledTx');
                log('TX: ' + keys.join('+').toUpperCase(), 'send');
                await kvm.sendKeyCombo(keys);
            }
        }

        document.getElementById('textInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendText();
        });

        // Mouse trackpad - drag to move, click to click
        const trackpad = document.getElementById('trackpad');
        const mouseCoords = document.getElementById('mouseCoords');
        let totalX = 0, totalY = 0;
        let trackpadLocked = false;
        let trackpadMoved = 0; // Track total movement to distinguish click vs drag
        let trackpadButton = 0; // Which button was pressed

        trackpad.addEventListener('mousedown', (e) => {
            if (!kvm.connected) return;
            e.preventDefault();

            // Request pointer lock for unlimited movement
            if (!trackpadLocked) {
                trackpad.requestPointerLock();
            }

            // Remember which button, but don't send it yet
            const btnMap = { 0: 1, 1: 4, 2: 2 };
            trackpadButton = btnMap[e.button] || 1;
            trackpadMoved = 0;

            isDragging = true;
            lastX = e.clientX;
            lastY = e.clientY;
        });

        trackpad.addEventListener('mousemove', (e) => {
            if (!kvm.connected || !isDragging) return;

            let dx, dy;
            if (trackpadLocked) {
                dx = e.movementX;
                dy = e.movementY;
            } else {
                dx = e.clientX - lastX;
                dy = e.clientY - lastY;
                lastX = e.clientX;
                lastY = e.clientY;
            }

            if (dx !== 0 || dy !== 0) {
                // Just move, no buttons - apply sensitivity
                kvm.moveMouse(Math.round(dx * mouseSensitivity), Math.round(dy * mouseSensitivity));
                flashLed('ledTx');
                trackpadMoved += Math.abs(dx) + Math.abs(dy);
                totalX += dx; totalY += dy;
                mouseCoords.textContent = totalX + ', ' + totalY;
                mouseCoords.classList.remove('dim');
            }
        });

        trackpad.addEventListener('mouseup', (e) => {
            if (!kvm.connected) return;

            // If barely moved, treat as a click
            if (trackpadMoved < 5) {
                const btnName = { 1: 'left', 2: 'right', 4: 'middle' };
                kvm.click(btnName[trackpadButton] || 'left');
                flashLed('ledTx');
                log('TX: Click ' + (btnName[trackpadButton] || 'left'), 'send');
            }

            // Exit pointer lock
            if (trackpadLocked) {
                document.exitPointerLock();
            }
            isDragging = false;
            trackpadButton = 0;
        });

        trackpad.addEventListener('contextmenu', (e) => e.preventDefault());

        // Scroll wheel on trackpad
        trackpad.addEventListener('wheel', (e) => {
            if (!kvm.connected) return;
            e.preventDefault();
            const scroll = e.deltaY > 0 ? -scrollSensitivity : scrollSensitivity;
            kvm.scroll(scroll);
            flashLed('ledTx');
        }, { passive: false });

        // Handle pointer lock changes for trackpad
        document.addEventListener('pointerlockchange', () => {
            if (document.pointerLockElement === trackpad) {
                trackpadLocked = true;
                trackpad.style.cursor = 'none';
            } else if (document.pointerLockElement !== overlay) {
                trackpadLocked = false;
                trackpad.style.cursor = 'crosshair';
                isDragging = false;
            }
        });

        // Touch support - tap to click, drag to move
        let touchMoved = 0;

        trackpad.addEventListener('touchstart', (e) => {
            if (!kvm.connected) return;
            e.preventDefault();
            isDragging = true;
            touchMoved = 0;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
        });

        trackpad.addEventListener('touchmove', (e) => {
            if (!isDragging || !kvm.connected) return;
            e.preventDefault();
            const dx = e.touches[0].clientX - lastX;
            const dy = e.touches[0].clientY - lastY;
            if (dx !== 0 || dy !== 0) {
                kvm.moveMouse(Math.round(dx * mouseSensitivity), Math.round(dy * mouseSensitivity));
                flashLed('ledTx');
                touchMoved += Math.abs(dx) + Math.abs(dy);
                lastX = e.touches[0].clientX;
                lastY = e.touches[0].clientY;
            }
        });

        trackpad.addEventListener('touchend', () => {
            if (!kvm.connected) return;
            // Tap = click
            if (touchMoved < 5) {
                kvm.click('left');
                flashLed('ledTx');
            }
            isDragging = false;
        });

        async function mouseClick(button) {
            if (kvm.connected) {
                flashLed('ledTx');
                log('TX: Click ' + button, 'send');
                await kvm.click(button);
            }
        }

        async function mouseScroll(amount) {
            if (kvm.connected) {
                flashLed('ledTx');
                await kvm.scroll(amount);
            }
        }

        // Capture Mode
        let isCapturing = false;
        let captureStats = { mouse: 0, clicks: 0, keys: 0 };
        const overlay = document.getElementById('captureOverlay');

        // Configurable exit key
        let exitKey = localStorage.getItem('exitKey') || 'Escape';
        const exitKeySelect = document.getElementById('exitKeySelect');
        exitKeySelect.value = exitKey;
        updateExitKeyDisplay();

        exitKeySelect.addEventListener('change', () => {
            exitKey = exitKeySelect.value;
            localStorage.setItem('exitKey', exitKey);
            updateExitKeyDisplay();
            log('Exit key set to: ' + exitKey, 'info');
        });

        function updateExitKeyDisplay() {
            const displayMap = {
                'Escape': 'ESC',
                'F12': 'F12',
                'F11': 'F11',
                'F10': 'F10',
                'ScrollLock': 'SCROLL LOCK',
                'Pause': 'PAUSE'
            };
            // Update both overlay and main hint
            document.getElementById('exitKeyDisplay').textContent = displayMap[exitKey] || exitKey;
            const hintEl = document.getElementById('exitKeyHint');
            if (hintEl) hintEl.textContent = displayMap[exitKey] || exitKey;
        }

        function startCapture() {
            if (!kvm.connected) return;
            overlay.classList.add('active');
            overlay.requestPointerLock();
        }

        function stopCapture() {
            if (!isCapturing) return; // Already stopped
            isCapturing = false;
            overlay.classList.remove('active');
            // Only exit pointer lock if overlay has it (not trackpad)
            if (document.pointerLockElement === overlay) document.exitPointerLock();
            resetCaptureKeyboardState();
            captureButtons = 0;
            log('Jacked out', 'info');
        }

        document.addEventListener('pointerlockchange', () => {
            if (document.pointerLockElement === overlay) {
                // Capture overlay got pointer lock - start capture mode
                isCapturing = true;
                captureStats = { mouse: 0, clicks: 0, keys: 0 };
                updateCaptureStats();
                log('Jacked in', 'info');
                document.addEventListener('mousemove', onCaptureMouseMove);
                document.addEventListener('mousedown', onCaptureMouseDown);
                document.addEventListener('mouseup', onCaptureMouseUp);
                document.addEventListener('wheel', onCaptureWheel);
                document.addEventListener('keydown', onCaptureKeyDown);
                document.addEventListener('keyup', onCaptureKeyUp);
            } else if (document.pointerLockElement === null && isCapturing) {
                // Pointer lock released while in capture mode - stop capture
                document.removeEventListener('mousemove', onCaptureMouseMove);
                document.removeEventListener('mousedown', onCaptureMouseDown);
                document.removeEventListener('mouseup', onCaptureMouseUp);
                document.removeEventListener('wheel', onCaptureWheel);
                document.removeEventListener('keydown', onCaptureKeyDown);
                document.removeEventListener('keyup', onCaptureKeyUp);
                stopCapture();
            }
            // If pointerLockElement is trackpad, do nothing here (trackpad handler handles it)
        });

        function onCaptureMouseMove(e) {
            if (!isCapturing || !kvm.connected) return;
            if (e.movementX !== 0 || e.movementY !== 0) {
                // Include button state so drag works correctly - apply sensitivity
                const dx = Math.round(e.movementX * mouseSensitivity);
                const dy = Math.round(e.movementY * mouseSensitivity);
                kvm.moveMouse(dx, dy, 0, captureButtons);
                captureStats.mouse++;
                updateCaptureStats();
            }
        }

        let captureButtons = 0;

        function onCaptureMouseDown(e) {
            if (!isCapturing || !kvm.connected) return;
            e.preventDefault();
            const btnMap = { 0: 1, 1: 4, 2: 2 };
            captureButtons |= btnMap[e.button] || 0;
            kvm.moveMouse(0, 0, 0, captureButtons);
            captureStats.clicks++;
            updateCaptureStats();
        }

        function onCaptureMouseUp(e) {
            if (!isCapturing || !kvm.connected) return;
            e.preventDefault();
            const btnMap = { 0: 1, 1: 4, 2: 2 };
            captureButtons &= ~(btnMap[e.button] || 0);
            kvm.moveMouse(0, 0, 0, captureButtons);
        }

        function onCaptureWheel(e) {
            if (!isCapturing || !kvm.connected) return;
            e.preventDefault();
            kvm.scroll(e.deltaY > 0 ? -scrollSensitivity : scrollSensitivity);
        }

        let heldModifiers = 0, heldKeys = [];

        async function updateKeyboardState() {
            await kvm.sendKeyboardReport(heldModifiers, heldKeys);
        }

        function onCaptureKeyDown(e) {
            if (!isCapturing || !kvm.connected) return;
            // Check for configurable exit key
            if (e.key === exitKey) {
                stopCapture();
                return;
            }
            e.preventDefault();

            let key = e.key.toLowerCase();
            const map = { 'control': 'ctrl', 'meta': 'gui', ' ': 'space', 'arrowup': 'up', 'arrowdown': 'down', 'arrowleft': 'left', 'arrowright': 'right' };
            key = map[key] || key;

            const mod = RelayKVMAdapter.MODIFIER_MAP[key];
            if (mod) { heldModifiers |= mod; updateKeyboardState(); return; }

            const code = RelayKVMAdapter.KEYCODE[key];
            if (code && !heldKeys.includes(code) && heldKeys.length < 6) {
                heldKeys.push(code);
                updateKeyboardState();
                captureStats.keys++;
                updateCaptureStats();
            }
        }

        function onCaptureKeyUp(e) {
            if (!isCapturing || !kvm.connected) return;
            e.preventDefault();

            let key = e.key.toLowerCase();
            const map = { 'control': 'ctrl', 'meta': 'gui', ' ': 'space', 'arrowup': 'up', 'arrowdown': 'down', 'arrowleft': 'left', 'arrowright': 'right' };
            key = map[key] || key;

            const mod = RelayKVMAdapter.MODIFIER_MAP[key];
            if (mod) { heldModifiers &= ~mod; updateKeyboardState(); return; }

            const code = RelayKVMAdapter.KEYCODE[key];
            if (code) { heldKeys = heldKeys.filter(k => k !== code); updateKeyboardState(); }
        }

        function resetCaptureKeyboardState() {
            heldModifiers = 0; heldKeys = [];
            if (kvm.connected) kvm.sendKeyboardReport(0, []);
        }

        function updateCaptureStats() {
            document.getElementById('statMouse').textContent = captureStats.mouse;
            document.getElementById('statClicks').textContent = captureStats.clicks;
            document.getElementById('statKeys').textContent = captureStats.keys;
        }

        overlay.addEventListener('contextmenu', e => e.preventDefault());

        // Logging
        function log(msg, type = 'info') {
            const el = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            entry.innerHTML = '<span class="time">' + time + '</span> ' + msg;
            el.appendChild(entry);
            el.scrollTop = el.scrollHeight;
            while (el.children.length > 50) el.removeChild(el.firstChild);
        }

        function clearLog() { document.getElementById('log').innerHTML = ''; }

        // Mouse Jiggler
        let jigglerActive = false;
        let jigglerTimer = null;
        let jigglerRange = parseInt(localStorage.getItem('jigglerRange')) || 5;
        let jigglerInterval = parseInt(localStorage.getItem('jigglerInterval')) || 30;
        let jigglerDirection = 1;

        const jigglerRangeSlider = document.getElementById('jigglerRange');
        const jigglerRangeVal = document.getElementById('jigglerRangeVal');
        const jigglerIntervalSlider = document.getElementById('jigglerInterval');
        const jigglerIntervalVal = document.getElementById('jigglerIntervalVal');
        const jigglerBtn = document.getElementById('jigglerBtn');
        const ledJiggler = document.getElementById('ledJiggler');

        // Initialize jiggler sliders
        jigglerRangeSlider.value = jigglerRange;
        jigglerRangeVal.textContent = jigglerRange;
        jigglerIntervalSlider.value = jigglerInterval;
        jigglerIntervalVal.textContent = jigglerInterval;

        jigglerRangeSlider.addEventListener('input', () => {
            jigglerRange = parseInt(jigglerRangeSlider.value);
            jigglerRangeVal.textContent = jigglerRange;
            localStorage.setItem('jigglerRange', jigglerRange);
        });

        jigglerIntervalSlider.addEventListener('input', () => {
            jigglerInterval = parseInt(jigglerIntervalSlider.value);
            jigglerIntervalVal.textContent = jigglerInterval;
            localStorage.setItem('jigglerInterval', jigglerInterval);
            // Restart timer if active
            if (jigglerActive) {
                clearInterval(jigglerTimer);
                jigglerTimer = setInterval(doJiggle, jigglerInterval * 1000);
            }
        });

        function toggleJiggler() {
            if (!kvm.connected) {
                log('Connect first to use jiggler', 'error');
                return;
            }

            jigglerActive = !jigglerActive;

            if (jigglerActive) {
                jigglerBtn.textContent = 'Stop';
                jigglerBtn.classList.add('danger');
                ledJiggler.classList.add('on');
                jigglerTimer = setInterval(doJiggle, jigglerInterval * 1000);
                log('Jiggler: ' + jigglerRange + 'px/' + jigglerInterval + 's', 'info');
            } else {
                jigglerBtn.textContent = 'Start';
                jigglerBtn.classList.remove('danger');
                ledJiggler.classList.remove('on');
                clearInterval(jigglerTimer);
                jigglerTimer = null;
                log('Jiggler off', 'info');
            }
        }

        function doJiggle() {
            if (!kvm.connected) {
                toggleJiggler(); // Stop if disconnected
                return;
            }
            // Move in alternating directions
            const move = jigglerRange * jigglerDirection;
            kvm.moveMouse(move, move);
            jigglerDirection *= -1;
            flashLed('ledTx');
        }

        // Modifier toggles
        let activeModifiers = { ctrl: false, alt: false, shift: false, gui: false };

        function toggleModifier(mod) {
            activeModifiers[mod] = !activeModifiers[mod];
            const btn = document.getElementById('mod' + mod.charAt(0).toUpperCase() + mod.slice(1));
            if (activeModifiers[mod]) {
                btn.classList.add('green');
            } else {
                btn.classList.remove('green');
            }
            updateHyperState();
        }

        function toggleHyper() {
            const allOn = activeModifiers.ctrl && activeModifiers.alt && activeModifiers.shift && activeModifiers.gui;
            const newState = !allOn;
            ['ctrl', 'alt', 'shift', 'gui'].forEach(mod => {
                activeModifiers[mod] = newState;
                const btn = document.getElementById('mod' + mod.charAt(0).toUpperCase() + mod.slice(1));
                if (newState) {
                    btn.classList.add('green');
                } else {
                    btn.classList.remove('green');
                }
            });
            updateHyperState();
            log('Hyper: ' + (newState ? 'ON' : 'OFF'), 'info');
        }

        function updateHyperState() {
            const allOn = activeModifiers.ctrl && activeModifiers.alt && activeModifiers.shift && activeModifiers.gui;
            const hyperBtn = document.getElementById('modHyper');
            if (allOn) {
                hyperBtn.classList.add('green');
            } else {
                hyperBtn.classList.remove('green');
            }
        }

        // Get active modifiers for combo
        function getActiveModifiers() {
            return Object.keys(activeModifiers).filter(m => activeModifiers[m]);
        }

        // Override sendKey to include active modifiers
        const originalSendKey = sendKey;
        sendKey = async function(key) {
            const mods = getActiveModifiers();
            if (mods.length > 0 && kvm.connected) {
                flashLed('ledTx');
                log('TX: ' + [...mods, key].join('+').toUpperCase(), 'send');
                await kvm.sendKeyCombo([...mods, key]);
            } else {
                await originalSendKey(key);
            }
        };

        // Macros (stores in localStorage)
        let macros = JSON.parse(localStorage.getItem('macros')) || {
            1: 'Hello World',
            2: '',
            3: '',
            4: ''
        };

        const macroSelect = document.getElementById('macroSelect');
        const macroEdit = document.getElementById('macroEdit');

        // Load macro into editor when selection changes
        macroSelect.addEventListener('change', () => {
            macroEdit.value = macros[macroSelect.value] || '';
        });

        // Initialize editor with first macro
        macroEdit.value = macros[1] || '';

        // Update macro button styles based on content
        function updateMacroButtons() {
            for (let i = 1; i <= 4; i++) {
                const btn = document.getElementById('macroBtn' + i);
                if (macros[i]) {
                    btn.classList.add('amber');
                    btn.title = macros[i].substring(0, 50);
                } else {
                    btn.classList.remove('amber');
                    btn.title = 'Empty';
                }
            }
        }
        updateMacroButtons();

        function saveMacro() {
            const num = macroSelect.value;
            macros[num] = macroEdit.value;
            localStorage.setItem('macros', JSON.stringify(macros));
            updateMacroButtons();
            log('Macro ' + num + ' saved', 'info');
        }

        function editMacro(num, event) {
            event.preventDefault();
            macroSelect.value = num;
            macroEdit.value = macros[num] || '';
            macroEdit.focus();
            macroEdit.select();
        }

        function playMacro(num) {
            if (!kvm.connected) {
                log('Connect first', 'error');
                return;
            }
            const text = macros[num];
            if (text) {
                flashLed('ledTx');
                log('Macro ' + num + ': "' + text.substring(0, 20) + (text.length > 20 ? '...' : '') + '"', 'send');
                kvm.typeText(text);
            } else {
                log('Macro ' + num + ' empty', 'info');
                // Select this macro for editing
                macroSelect.value = num;
                macroEdit.value = '';
                macroEdit.focus();
            }
        }

        // Video module (UI only - not connected to functionality yet)
        let videoMode = 'off';
        let videoStreaming = false;

        function setVideoMode(mode) {
            videoMode = mode;
            // Stop any active stream when switching modes
            if (videoStreaming) {
                stopVideoStream();
            }
            updateVideoUI();
            log('Video: ' + mode.toUpperCase(), 'info');
        }

        function updateVideoUI() {
            const ledVideo = document.getElementById('ledVideo');
            const captureDevice = document.getElementById('captureDevice');
            const startCaptureBtn = document.getElementById('startCaptureBtn');
            const peerId = document.getElementById('peerId');
            const connectPeerBtn = document.getElementById('connectPeerBtn');
            const videoParams = document.getElementById('videoParams');

            // Update LED: amber=off, blue=ready, green=streaming
            ledVideo.classList.remove('on', 'amber', 'blue');
            if (videoMode === 'off') {
                ledVideo.classList.add('amber');
            } else if (videoStreaming) {
                ledVideo.classList.add('on'); // green = active
            } else {
                ledVideo.classList.add('blue', 'on'); // blue = ready
            }

            // Enable/disable USB controls
            captureDevice.disabled = videoMode !== 'usb';
            startCaptureBtn.disabled = videoMode !== 'usb';
            startCaptureBtn.textContent = videoStreaming && videoMode === 'usb' ? 'Stop' : 'Start';
            startCaptureBtn.classList.toggle('red', videoStreaming && videoMode === 'usb');
            startCaptureBtn.classList.toggle('green', !videoStreaming || videoMode !== 'usb');

            // Enable/disable WebRTC controls
            peerId.disabled = videoMode !== 'webrtc';
            connectPeerBtn.disabled = videoMode !== 'webrtc';
            connectPeerBtn.textContent = videoStreaming && videoMode === 'webrtc' ? 'Stop' : 'Connect';
            connectPeerBtn.classList.toggle('red', videoStreaming && videoMode === 'webrtc');
            connectPeerBtn.classList.toggle('green', !videoStreaming || videoMode !== 'webrtc');

            // Dim resolution/FPS when off
            if (videoMode === 'off') {
                videoParams.classList.add('disabled');
            } else {
                videoParams.classList.remove('disabled');
            }
        }

        function toggleCapture() {
            if (videoStreaming) {
                stopVideoStream();
            } else {
                const device = document.getElementById('captureDevice').value;
                if (!device) {
                    log('Select a capture device', 'error');
                    return;
                }
                startVideoStream('usb');
            }
        }

        function connectPeer() {
            if (videoStreaming) {
                stopVideoStream();
            } else {
                const peerId = document.getElementById('peerId').value;
                if (!peerId) {
                    log('Enter peer ID', 'error');
                    return;
                }
                startVideoStream('webrtc');
                log('WebRTC: connecting to ' + peerId + '... (not implemented)', 'info');
            }
        }

        function startVideoStream(type) {
            videoStreaming = true;
            updateVideoUI();
            log(type.toUpperCase() + ': streaming (not implemented)', 'info');
        }

        function stopVideoStream() {
            videoStreaming = false;
            updateVideoUI();
            log('Video: stopped', 'info');
        }

        // Initialize video LED state (off = amber)
        document.getElementById('ledVideo').classList.add('amber');

        // Enumerate USB capture devices (if available)
        async function enumerateCaptureDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                const select = document.getElementById('captureDevice');
                select.innerHTML = '<option value="">Select capture device...</option>';
                videoDevices.forEach(device => {
                    const opt = document.createElement('option');
                    opt.value = device.deviceId;
                    opt.textContent = device.label || ('Camera ' + (select.options.length));
                    select.appendChild(opt);
                });
            } catch (e) {
                // Permission denied or not supported
            }
        }
        enumerateCaptureDevices();

        // Wake/Power functions
        const powerArmBtn = document.getElementById('powerArm');
        const powerBtn = document.getElementById('powerBtn');
        let powerArmed = false;
        let armTimeout = null;

        function togglePowerArm() {
            powerArmed = !powerArmed;
            powerArmBtn.classList.toggle('armed', powerArmed);
            powerBtn.classList.toggle('armed', powerArmed);

            if (powerArmed) {
                log('Power armed - use with caution!', 'error');
                // Auto-disarm after 10 seconds
                armTimeout = setTimeout(() => {
                    if (powerArmed) {
                        powerArmed = false;
                        powerArmBtn.classList.remove('armed');
                        powerBtn.classList.remove('armed');
                        log('Power auto-disarmed', 'info');
                    }
                }, 10000);
            } else {
                if (armTimeout) clearTimeout(armTimeout);
                log('Power disarmed', 'info');
            }
        }

        // Sleep macro (Windows: Win+X, U, S)
        async function sendSleep() {
            if (!kvm.connected) {
                log('Connect first', 'error');
                return;
            }
            try {
                flashLed('ledTx');
                log('Sending sleep sequence (Win+X, U, S)...', 'info');
                // Win+X to open power menu
                await kvm.sendKeyboardReport(0x08, [0x1B]); // GUI + X
                await new Promise(r => setTimeout(r, 100));
                await kvm.sendKeyboardReport(0, []);
                await new Promise(r => setTimeout(r, 300)); // Wait for menu
                // U for Shut down or sign out
                await kvm.sendKeyboardReport(0, [0x18]); // U
                await new Promise(r => setTimeout(r, 50));
                await kvm.sendKeyboardReport(0, []);
                await new Promise(r => setTimeout(r, 200)); // Wait for submenu
                // S for Sleep
                await kvm.sendKeyboardReport(0, [0x16]); // S
                await new Promise(r => setTimeout(r, 50));
                await kvm.sendKeyboardReport(0, []);
                log('Sleep sequence sent', 'send');
            } catch (e) {
                log('Sleep error: ' + e.message, 'error');
            }
        }

        // Simple wake - just sends keyboard activity
        async function sendWake() {
            if (!kvm.connected) {
                log('Connect first', 'error');
                return;
            }
            try {
                flashLed('ledTx');
                // Send a shift key press/release to wake
                await kvm.sendKeyboardReport(0x02, []); // Left Shift down
                await new Promise(r => setTimeout(r, 50));
                await kvm.sendKeyboardReport(0, []); // Release
                log('Wake signal sent', 'send');
            } catch (e) {
                log('Wake error: ' + e.message, 'error');
            }
        }

        // USB Wake - sends command to Cardputer to trigger USB wake
        async function sendUsbWake() {
            if (!kvm.connected) {
                log('Connect first', 'error');
                return;
            }
            try {
                flashLed('ledTx');
                await kvm.sendUsbWake();
                log('USB wake signal sent', 'send');
            } catch (e) {
                log('USB wake error: ' + e.message, 'error');
            }
        }

        async function sendPower() {
            if (!kvm.connected || !powerArmed) return;
            flashLed('ledTx');
            // This would need firmware support for power button
            log('Power button pressed (not implemented in firmware)', 'info');
            // Disarm after use
            powerArmed = false;
            powerArmBtn.classList.remove('armed');
            powerBtn.classList.remove('armed');
        }

        // Connection monitoring
        let pingInterval = null;

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connStatus');
            const bars = document.getElementById('signalBars');
            const latency = document.getElementById('connLatency');

            if (connected) {
                status.textContent = 'Connected';
                bars.className = 'signal-bars strength-4';
                // Start ping interval
                if (!pingInterval) {
                    pingInterval = setInterval(measureLatency, 5000);
                    measureLatency();
                }
            } else {
                status.textContent = 'Disconnected';
                bars.className = 'signal-bars';
                latency.textContent = '--ms';
                latency.classList.add('dim');
                if (pingInterval) {
                    clearInterval(pingInterval);
                    pingInterval = null;
                }
            }
        }

        async function measureLatency() {
            if (!kvm.connected) return;
            const start = performance.now();
            try {
                // Send a minimal message and measure response time
                await kvm.sendKeyboardReport(0, []);
                const elapsed = Math.round(performance.now() - start);
                const latencyEl = document.getElementById('connLatency');
                latencyEl.textContent = elapsed + 'ms';
                latencyEl.classList.remove('dim');

                // Update signal bars based on latency
                const bars = document.getElementById('signalBars');
                if (elapsed < 50) bars.className = 'signal-bars strength-4';
                else if (elapsed < 100) bars.className = 'signal-bars strength-3';
                else if (elapsed < 200) bars.className = 'signal-bars strength-2';
                else bars.className = 'signal-bars strength-1';
            } catch (e) {
                // Connection might be lost
            }
        }

        function reconnect() {
            if (kvm.connected) {
                kvm.disconnect();
            }
            setTimeout(() => toggleConnection(), 100);
        }

        // Hook into existing connection change
        const originalOnConnectionChange = kvm.onConnectionChange;
        kvm.onConnectionChange = (connected) => {
            originalOnConnectionChange(connected);
            updateConnectionStatus(connected);
        };

        // Scripts
        let scripts = JSON.parse(localStorage.getItem('scripts')) || {
            1: 'type Hello World\ndelay 500\nkey enter',
            2: '',
            3: ''
        };
        let scriptRunning = false;

        function loadScript() {
            const slot = document.getElementById('scriptSlot').value;
            document.getElementById('scriptEditor').value = scripts[slot] || '';
            log('Script ' + slot + ' loaded', 'info');
        }

        function saveScript() {
            const slot = document.getElementById('scriptSlot').value;
            scripts[slot] = document.getElementById('scriptEditor').value;
            localStorage.setItem('scripts', JSON.stringify(scripts));
            log('Script ' + slot + ' saved', 'info');
        }

        async function runScript() {
            if (!kvm.connected) {
                log('Connect first', 'error');
                return;
            }
            if (scriptRunning) {
                scriptRunning = false;
                log('Script stopped', 'info');
                return;
            }

            const script = document.getElementById('scriptEditor').value;
            const lines = script.split('\n').filter(l => l.trim());

            if (!lines.length) {
                log('Script is empty', 'error');
                return;
            }

            scriptRunning = true;
            const runBtn = document.getElementById('runScriptBtn');
            runBtn.textContent = 'Stop';
            runBtn.classList.remove('green');
            runBtn.classList.add('red');
            log('Script running...', 'info');

            for (const line of lines) {
                if (!scriptRunning) break;

                const parts = line.trim().split(/\s+/);
                const cmd = parts[0].toLowerCase();
                const args = parts.slice(1).join(' ');

                try {
                    switch (cmd) {
                        case 'type':
                            await kvm.typeText(args);
                            flashLed('ledTx');
                            break;
                        case 'key':
                            await kvm.sendKey(args.toLowerCase());
                            flashLed('ledTx');
                            break;
                        case 'combo':
                            const keys = args.toLowerCase().split('+').map(k => k.trim());
                            await kvm.sendKeyCombo(keys);
                            flashLed('ledTx');
                            break;
                        case 'delay':
                        case 'wait':
                            await new Promise(r => setTimeout(r, parseInt(args) || 100));
                            break;
                        case 'click':
                            await kvm.click(args || 'left');
                            flashLed('ledTx');
                            break;
                        case 'move':
                            const [x, y] = args.split(/[,\s]+/).map(n => parseInt(n) || 0);
                            await kvm.moveMouse(x, y);
                            flashLed('ledTx');
                            break;
                        case 'log':
                            log(args, 'info');
                            break;
                        default:
                            log('Unknown command: ' + cmd, 'error');
                    }
                } catch (e) {
                    log('Script error: ' + e.message, 'error');
                    break;
                }

                // Small delay between commands
                await new Promise(r => setTimeout(r, 20));
            }

            scriptRunning = false;
            runBtn.textContent = 'Run';
            runBtn.classList.remove('red');
            runBtn.classList.add('green');
            log('Script finished', 'info');
        }

        // Load first script slot on init
        document.getElementById('scriptEditor').value = scripts[1] || '';

        // Display control (Cardputer screen)
        let displayMode = 'on';
        const dispTimeoutSlider = document.getElementById('dispTimeout');
        const dispTimeoutVal = document.getElementById('dispTimeoutVal');

        dispTimeoutSlider.addEventListener('input', async () => {
            const val = parseInt(dispTimeoutSlider.value);
            dispTimeoutVal.textContent = val === 0 ? 'Never' : val + 's';
            if (kvm.connected) {
                try {
                    await kvm.setDisplayTimeout(val);
                    flashLed('ledTx');
                    log('Display timeout: ' + (val === 0 ? 'disabled' : val + 's'), 'send');
                } catch (e) {
                    log('Timeout error: ' + e.message, 'error');
                }
            }
        });

        async function setDisplay(mode) {
            displayMode = mode;

            // Update button states
            document.getElementById('dispOff').classList.remove('red');
            document.getElementById('dispDim').classList.remove('amber');
            document.getElementById('dispOn').classList.remove('blue');

            if (mode === 'off') {
                document.getElementById('dispOff').classList.add('red');
            } else if (mode === 'dim') {
                document.getElementById('dispDim').classList.add('amber');
            } else {
                document.getElementById('dispOn').classList.add('blue');
            }

            if (kvm.connected) {
                try {
                    await kvm.setDisplayBrightness(mode);
                    flashLed('ledTx');
                    log('Display: ' + mode.toUpperCase(), 'send');
                } catch (e) {
                    log('Display error: ' + e.message, 'error');
                }
            } else {
                log('Connect first', 'error');
            }
        }

        // Help modal
        const helpContent = {
            scripts: {
                title: 'Script Commands',
                body: `
                    <h3>Text & Keys</h3>
                    <div class="cmd-row"><span class="cmd-name">type &lt;text&gt;</span><span class="cmd-desc">Type text characters</span></div>
                    <div class="cmd-row"><span class="cmd-name">key &lt;key&gt;</span><span class="cmd-desc">Press a single key</span></div>
                    <div class="cmd-row"><span class="cmd-name">combo &lt;k+k&gt;</span><span class="cmd-desc">Key combination</span></div>

                    <h3>Mouse</h3>
                    <div class="cmd-row"><span class="cmd-name">click &lt;btn&gt;</span><span class="cmd-desc">left, right, or middle</span></div>
                    <div class="cmd-row"><span class="cmd-name">move &lt;x&gt; &lt;y&gt;</span><span class="cmd-desc">Move mouse relative</span></div>

                    <h3>Timing</h3>
                    <div class="cmd-row"><span class="cmd-name">delay &lt;ms&gt;</span><span class="cmd-desc">Wait milliseconds</span></div>

                    <h3>Modifiers</h3>
                    <code>ctrl</code> <code>alt</code> <code>shift</code> <code>gui</code>

                    <h3>Examples</h3>
                    <code>type Hello World</code><br>
                    <code>combo ctrl+alt+delete</code><br>
                    <code>delay 1000</code><br>
                    <code>key enter</code>
                `
            },
            macros: {
                title: 'Macros Help',
                body: `
                    <h3>Quick Actions</h3>
                    <div class="cmd-row"><span class="cmd-name">Click</span><span class="cmd-desc">Play the macro</span></div>
                    <div class="cmd-row"><span class="cmd-name">Right-click</span><span class="cmd-desc">Edit the macro</span></div>

                    <h3>Editing</h3>
                    Macros store plain text that gets typed when played.
                    <br><br>
                    1. Right-click a macro button (or select slot)<br>
                    2. Type your text in the editor<br>
                    3. Click <code>Set</code> to save

                    <h3>Tips</h3>
                    • Great for passwords, emails, signatures<br>
                    • Use Scripts for complex automation<br>
                    • Macros persist in browser storage
                `
            }
        };

        function showHelp(topic) {
            const help = helpContent[topic];
            if (!help) return;
            document.getElementById('helpTitle').textContent = help.title;
            document.getElementById('helpBody').innerHTML = help.body;
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelp(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('helpModal').classList.remove('active');
            }
        }

        // Close modal on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('helpModal').classList.contains('active')) {
                closeHelp();
            }
        });

        // Check for known devices on startup
        async function checkKnownDevices() {
            try {
                const devices = await RelayKVMAdapter.getKnownDevices();
                if (devices.length > 0) {
                    knownDevice = devices[0];
                    log('Known device found: ' + knownDevice.name, 'info');
                    const btn = document.getElementById('connectBtn');
                    btn.textContent = 'Quick Connect';
                    btn.title = 'Reconnect to ' + knownDevice.name;
                }
            } catch (e) {
                console.log('Could not check known devices:', e);
            }
        }

        checkKnownDevices();
        log('System ready', 'info');
    </script>
</body>
</html>
